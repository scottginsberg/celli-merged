<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LOOMWORKS // GOD ROUTER</title>
  <style>
    :root {
      --matrix-green: #00ff41;
      --terminal-bg: #050505;
      --panel-border: rgba(0, 255, 65, 0.18);
      --soft-green: #c8ffd7;
      --subtle: #0f1a10;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      background: radial-gradient(circle at 20% 20%, rgba(0, 255, 65, 0.08), transparent 35%), var(--terminal-bg);
      color: #e2fbe2;
      font-family: 'Space Mono', 'Courier New', monospace;
    }

    a { color: inherit; }

    .gridlines {
      background-size: 40px 40px;
      background-image: linear-gradient(to right, rgba(0, 255, 65, 0.07) 1px, transparent 1px),
        linear-gradient(to bottom, rgba(0, 255, 65, 0.07) 1px, transparent 1px);
    }

    .panel { background: rgba(0, 0, 0, 0.6); border: 1px solid var(--panel-border); border-radius: 10px; padding: 16px; }
    .holo { box-shadow: 0 0 30px rgba(0, 255, 65, 0.25); border-color: var(--panel-border); }
    .row { display: flex; gap: 12px; flex-wrap: wrap; }
    .between { display: flex; justify-content: space-between; align-items: center; gap: 8px; }
    .chips { display: flex; gap: 6px; flex-wrap: wrap; }
    .chip { padding: 4px 8px; border: 1px solid rgba(0,255,65,0.3); border-radius: 6px; background: rgba(0,255,65,0.05); font-size: 11px; }
    .btn { cursor: pointer; border: 1px solid rgba(0,255,65,0.4); background: #021406; color: #e2fbe2; padding: 8px 10px; border-radius: 6px; font-size: 12px; }
    .btn:hover { background: #063212; }
    .btn.secondary { background: transparent; color: #7de7a2; }
    .small { font-size: 12px; color: #7de7a2; }
    .muted { color: #4e7a5b; font-size: 11px; }
    .card { border: 1px solid rgba(0,255,65,0.15); background: rgba(255,255,255,0.02); border-radius: 8px; padding: 10px; }
    .pill { padding: 2px 8px; border-radius: 12px; border: 1px solid rgba(0,255,65,0.3); font-size: 11px; }
    .table { width: 100%; border-collapse: collapse; font-size: 12px; }
    .table th, .table td { border: 1px solid rgba(0,255,65,0.2); padding: 8px; text-align: left; }
    .input { width: 100%; background: #000; color: #c8ffd7; border: 1px solid rgba(0,255,65,0.4); padding: 8px; border-radius: 6px; font-family: inherit; }
    .textarea { width: 100%; min-height: 120px; background: #000; color: #c8ffd7; border: 1px solid rgba(0,255,65,0.4); padding: 8px; border-radius: 6px; font-family: inherit; }
    .tag { background: rgba(0, 255, 65, 0.12); color: #b7ffca; padding: 4px 6px; border-radius: 5px; font-size: 11px; }
    .log { font-size: 11px; color: #9fffb4; line-height: 1.5; max-height: 140px; overflow-y: auto; border: 1px solid rgba(0,255,65,0.15); padding: 8px; background: rgba(0,0,0,0.4); }
    .nav { display: flex; flex-direction: column; gap: 8px; }
    .nav button { width: 100%; text-align: left; }
    .nav .active { background: rgba(0,255,65,0.16); color: #e2fbe2; border-color: rgba(0, 255, 65, 0.4); }
    .api-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; }
    .two-col { display: grid; grid-template-columns: 280px 1fr; gap: 16px; }
    .grid { display: grid; gap: 10px; }
    .grid.four { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
    .grid.three { grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); }
    .grid.two { grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); }
    .mt-2 { margin-top: 8px; }
    .mb-2 { margin-bottom: 8px; }
    .mt-1 { margin-top: 4px; }
    .mb-1 { margin-bottom: 4px; }
    .status { font-size: 11px; padding: 2px 6px; border-radius: 6px; border: 1px solid rgba(0,255,65,0.2); }
    .status.ok { color: #9fffb4; }
    .status.warn { color: #facc15; border-color: rgba(250,204,21,0.4); }
    .status.fail { color: #f87171; border-color: rgba(248,113,113,0.4); }
    .progress { height: 8px; background: rgba(0,255,65,0.15); border-radius: 4px; overflow: hidden; }
    .progress span { display: block; height: 100%; background: #00ff41; }
    .badge { display: inline-block; background: #073114; padding: 3px 6px; border: 1px solid rgba(0,255,65,0.2); border-radius: 6px; font-size: 11px; color: #9fffb4; }
    @media (max-width: 900px) { .two-col { grid-template-columns: 1fr; } }
  </style>
</head>
<body class="gridlines">
  <div id="app"></div>
  <script>
    const state = {
      view: 'overview',
      logs: ['SYSTEM INITIALIZED...','CONNECTING TO CELLI NODE GRAPH...','LISTENING TO ZEITGEIST...'],
      ledger: [{ ts: '08:00', msg: 'Router online · mythkeeper quorum formed' }, { ts: '08:05', msg: 'Baseline resonance loaded from god.html nodes' }],
      voteDraft: 'pona hope pilin',
      nextArc: 0,
      cta: 'Identity Assessment',
      backlogHealth: { linked: 90, broken: 2, patched: 0 },
      apiKeys: JSON.parse(localStorage.getItem('loom_api_keys') || '{}'),
      apiStatus: { transcription: 'idle', trendDiscovery: 'idle', distroStats: 'idle' },
      financials: { warChest: 300, casino: 200, totalRevenue: 1000, holdings: [{ ticker: '$PEPE', vibe: 'memetic' }, { ticker: '$AI', vibe: 'hype' }, { ticker: '$BTC', vibe: 'store' }] },
      trends: [],
      generatedContent: null,
    };

    const data = {
      agents: {
        DIME: { name: 'DIME (The Child)', core: 'Wonder/Confusion', toki: 'sona lili' },
        FESH: { name: 'FESH PINCE (The Jester)', core: 'Absurdity/Satire', toki: 'musi ike' },
        WEAVER: { name: 'THE WEAVER (Historian)', core: 'Patterns/History', toki: 'tenpo pini' }
      },
      provisioning: [
        { id: 'Registrar', scope: 'Identity Birth', focus: 'Mint @loomworks.xyz + MX/DMARC', sla: '<2m' },
        { id: 'Herald', scope: 'Recovery Linker', focus: 'Playwright Gmail binding', sla: '<90s' },
        { id: 'Chorus Hand', scope: 'Social Shell', focus: 'TikTok/Spotify initialization', sla: '<3m' },
        { id: 'Tropist', scope: 'Semiotic Infill', focus: 'TV Tropes heatmap + trope tags', sla: '<45s' },
        { id: 'Spinster', scope: 'Tracklist', focus: '90-song arc clustering', sla: '<2m' },
        { id: 'GREG Monitor', scope: 'Self-Repair', focus: 'Link audits + re-cluster', sla: 'continuous' },
      ],
      arcs: [
        { id: 'hope', title: 'Hope Arc', keyword: 'pona', cpv: 0.006, form: 'Reality Show PSA', backlog: ['LW_TRACK_091', 'LW_TRACK_034'] },
        { id: 'critique', title: 'Anger/Critique', keyword: 'ike', cpv: 0.012, form: 'And Now Presenting', backlog: ['LW_TRACK_010', 'LW_TRACK_034'] },
        { id: 'heart', title: 'Feeling/Pilin', keyword: 'pilin', cpv: 0.008, form: 'Vignette + Stem Pack', backlog: ['LW_TRACK_091', 'LW_TRACK_010'] },
      ],
      resonanceNodes: [
        {
          node_id: 'LW_TRACK_091',
          toki_pona_profile: { dominant_word: 'pilin', purity_score: 0.85, truth_balance: 'hope_weighted' },
          resonance_node: {
            theme: 'Hope',
            life_link: 'post_breakup_lucidity',
            culture_shell: '90s_vibe_animation',
            semiotic_lesson: 'The integrity of the archive vs. digital rot'
          },
          industrial_metrics: { bite_layers: 9, reference_delta: 4.5, visual_shell: 'creme_bezel_ui', accessibility: 'open_gate' },
          performance_delta: { organic_rip_potential: 'high', cpv_prediction: 0.006 }
        },
        {
          node_id: 'LW_TRACK_034',
          toki_pona_profile: { dominant_word: 'pona', purity_score: 0.73, truth_balance: 'balanced' },
          resonance_node: {
            theme: 'Anger',
            life_link: 'warehouse_shift_era',
            culture_shell: '1930s_aesthetic',
            semiotic_lesson: 'Labor grift vs. craft integrity'
          },
          industrial_metrics: { bite_layers: 8, reference_delta: 6.2, visual_shell: 'pumpkin_head', accessibility: 'identity_gate' },
          performance_delta: { organic_rip_potential: 'medium', cpv_prediction: 0.012 }
        },
        {
          node_id: 'LW_TRACK_010',
          toki_pona_profile: { dominant_word: 'ike', purity_score: 0.64, truth_balance: 'anger_weighted' },
          resonance_node: {
            theme: 'Hope',
            life_link: 'trainyard_nights',
            culture_shell: 'skibidi_velocity',
            semiotic_lesson: 'Integrity layer of a 1928 sketch vs. modern feed friction'
          },
          industrial_metrics: { bite_layers: 7, reference_delta: 3.1, visual_shell: 'chrome_mask', accessibility: 'open_gate' },
          performance_delta: { organic_rip_potential: 'high', cpv_prediction: 0.004 }
        }
      ],
      triangulationSets: {
        storyNodes: [
          { id: 'LW_TRACK_091', title: 'Archive Liminal Run', theme: 'Hope', cultureShell: '90s_vibe_animation', truthVector: 'pilin', biteLayers: 9, referenceDelta: 4.5, pulse: 1.1, tropes: ['Found Family', 'Mirror Duel'], wikiEntry: 'story-engine/index.html#LW_TRACK_091', releaseState: 'beta' },
          { id: 'LW_TRACK_034', title: 'Warehouse Shift Psalm', theme: 'Anger', cultureShell: '1930s_aesthetic', truthVector: 'pona', biteLayers: 8, referenceDelta: 6.2, pulse: 0.96, tropes: ['Class Uprising', 'Bureaucracy Satire'], wikiEntry: 'story-engine/index.html#LW_TRACK_034', releaseState: 'polish' },
          { id: 'LW_TRACK_010', title: 'Trainyard Nights', theme: 'Hope', cultureShell: 'skibidi_velocity', truthVector: 'ike', biteLayers: 7, referenceDelta: 3.1, pulse: 1.08, tropes: ['Runaway Mentor', 'Mirror Duel'], wikiEntry: 'story-engine/index.html#LW_TRACK_010', releaseState: 'draft' },
        ],
        castArcs: [
          { id: 'CAST_ARC_01', title: 'DIME // Wonder Spiral', theme: 'Love', cultureShell: 'Tarot prop', truthVector: 'pilin', biteLayers: 6, referenceDelta: 5, pulse: 1.05, tropes: ['Chosen One', 'Found Family'], wikiEntry: 'story-explorer/index.html#DIME', releaseState: 'beta' },
          { id: 'CAST_ARC_02', title: 'FESH // Satire Blade', theme: 'Anger', cultureShell: 'Vintage gourmet meme', truthVector: 'ike', biteLayers: 7, referenceDelta: 8, pulse: 0.94, tropes: ['Bureaucracy Satire', 'Jester Oracle'], wikiEntry: 'story-explorer/index.html#FESH', releaseState: 'draft' },
          { id: 'CAST_ARC_03', title: 'WEAVER // Lattice Archivist', theme: 'Loss', cultureShell: 'Mario rotational rods', truthVector: 'pona', biteLayers: 8, referenceDelta: 7, pulse: 1, tropes: ['Archivist', 'Mirror Duel'], wikiEntry: 'story-explorer/index.html#WEAVER', releaseState: 'ready' }
        ],
      }
    };

    const navItems = [
      { id: 'overview', label: 'Overview', description: 'Pulse, Shamanic protocol, in-app nav' },
      { id: 'story', label: 'Story Wiki', description: 'Story engine + wiki' },
      { id: 'graph', label: 'Graph', description: 'Node lattice / cockpit' },
      { id: 'cast', label: 'Cast', description: 'Story bible + explorer' },
      { id: 'weaver', label: 'Weaver Protocol', description: 'Agent stack + orchestration' },
      { id: 'basilisk', label: 'Basilisk', description: 'Live generator' },
    ];

    function $(query, ctx=document) { return ctx.querySelector(query); }
    function el(tag, className, children) {
      const node = document.createElement(tag);
      if (className) node.className = className;
      if (Array.isArray(children)) children.forEach(child => node.append(child));
      else if (typeof children === 'string') node.textContent = children;
      return node;
    }

    function setView(view) { state.view = view; render(); }

    function saveKeys(evt) {
      evt.preventDefault();
      const form = evt.target.closest('form');
      const keys = ['sunoKey','synclabsKey','openaiKey'];
      keys.forEach(k => state.apiKeys[k] = form[k].value.trim());
      localStorage.setItem('loom_api_keys', JSON.stringify(state.apiKeys));
      log(`[KEYS] Updated API keys (${keys.filter(k=>state.apiKeys[k]).length}/3 populated)`);
      render();
    }

    function log(message) {
      const ts = new Date().toLocaleTimeString();
      state.logs.unshift(`[${ts}] ${message}`);
      state.logs = state.logs.slice(0, 12);
    }

    function pushLedger(message) {
      const ts = new Date().toLocaleTimeString();
      state.ledger.unshift({ ts, msg: message });
      state.ledger = state.ledger.slice(0, 12);
    }

    function parseVotes() {
      const tokens = state.voteDraft.toLowerCase().split(/\s+/).filter(Boolean);
      let winner = data.arcs[0];
      let best = -1;
      data.arcs.forEach(arc => {
        const score = tokens.filter(t => t.includes(arc.keyword)).length;
        if (score > best) { best = score; winner = arc; }
      });
      state.nextArc = data.arcs.indexOf(winner);
      pushLedger(`[VOTE] ${winner.title} prioritized via keyword match`);
      render();
    }

    function rotateCTA() {
      state.cta = state.cta === 'Identity Assessment' ? '16x16 Manufacture' : 'Identity Assessment';
      pushLedger(`[VALUE GATE] CTA rotated to ${state.cta}`);
      render();
    }

    function patchLink() {
      state.backlogHealth = { ...state.backlogHealth, broken: Math.max(state.backlogHealth.broken - 1, 0), patched: state.backlogHealth.patched + 1 };
      pushLedger('[GREG] Self-repair triggered · broken link patched');
      render();
    }

    function runProvisioning(id) {
      const slot = data.provisioning.find(p => p.id === id);
      slot.status = slot.status === 'running' ? 'stable' : slot.status === 'stable' ? 'alert' : 'running';
      slot.lastPing = new Date().toLocaleTimeString();
      pushLedger(`[${id}] executed runbook`);
      render();
    }

    function requireKey(keyName) {
      if (!state.apiKeys[keyName]) {
        log(`API key missing for ${keyName}. Add it to run this action.`);
        return false;
      }
      return true;
    }

    function syncTranscriptions() {
      if (!requireKey('sunoKey')) return;
      state.apiStatus.transcription = 'queued';
      log('[AUDIO] Transcription batch queued');
      setTimeout(() => { state.apiStatus.transcription = 'complete'; log('[AUDIO] Transcriptions returned'); render(); }, 900);
      render();
    }

    function scanOpenInternet() {
      if (!requireKey('openaiKey')) return;
      state.apiStatus.trendDiscovery = 'scanning';
      log('[DISCOVERY] Scanning leading topics');
      setTimeout(() => {
        state.apiStatus.trendDiscovery = 'complete';
        state.trends = [
          { topic: 'Bitcoin Halving', category: 'Finance', volatility: 0.8 },
          { topic: 'AI Consciousness', category: 'Tech', volatility: 0.9 },
          { topic: 'Met Gala Insects', category: 'Fashion', volatility: 0.4 },
        ];
        log('[DISCOVERY] Trends refreshed');
        render();
      }, 800);
      render();
    }

    function fetchDistroStats() {
      if (!requireKey('synclabsKey')) return;
      state.apiStatus.distroStats = 'syncing';
      log('[DISTRO] Syncing DistroKid metrics');
      setTimeout(() => { state.apiStatus.distroStats = 'ready'; log('[DISTRO] DistroKid metrics cached'); render(); }, 700);
      render();
    }

    function simulatePayout() {
      const add = 1000;
      const split = { warChest: Math.round(add * 0.3), casino: Math.round(add * 0.2), operations: add - Math.round(add * 0.3) - Math.round(add * 0.2) };
      state.financials.totalRevenue += add;
      state.financials.warChest += split.warChest;
      state.financials.casino += split.casino;
      state.financials.holdings.push({ ticker: '$' + ['PEPE','WIF','AI','BTC'][Math.floor(Math.random()*4)], vibe: 'scatter' });
      if (state.financials.holdings.length > 6) state.financials.holdings.shift();
      log(`[BAGMAN] Simulated $${add} payout split across war chest/casino/ops`);
      render();
    }

    function froggerLeap(topic) {
      log(`[CELLI] Calculating Frogger Leap for: ${topic}`);
      state.generatedContent = {
        topic,
        anchor: 'chorus-lattice',
        script: 'Cut the feed, switch to monochrome, drop the punch-in before the bag explodes.',
        audioStatus: 'RENDERING (Suno API)...',
        videoStatus: 'QUEUED (SyncLabs)...'
      };
      render();
    }

    function renderHeader() {
      return `
        <header class="panel between" style="border-bottom:1px solid rgba(0,255,65,0.25);">
          <div>
            <div class="muted" style="letter-spacing:0.35em;text-transform:uppercase;">Loomworks Dispatch</div>
            <h1 style="margin:4px 0 2px;font-size:22px;color:${'var(--soft-green)'}">GOD ROUTER · Basilisk / Story / Graph</h1>
            <div class="muted">${navItems.find(n => n.id === state.view)?.label || 'Router Overview'} · high-side routing online</div>
          </div>
          <div class="small" style="text-align:right;">
            <div>Now Presenting · Cast + Wiki + Node Graph</div>
            <div style="color:#7de7a2;">single-page cockpit</div>
          </div>
        </header>
      `;
    }

    function renderNav() {
      return `
        <nav class="panel nav">
          <div class="muted" style="letter-spacing:0.2em;text-transform:uppercase;">Navigation</div>
          ${navItems.map(item => `
            <button class="btn ${state.view===item.id?'active':''}" onclick="setView('${item.id}')">
              <div style="font-weight:700;">${item.label}</div>
              <div class="muted">${item.description}</div>
            </button>
          `).join('')}
          <div class="muted">Internal router keeps all modules docked—no external jumps.</div>
        </nav>
      `;
    }

    function renderApiKeys() {
      return `
        <form class="panel holo" onsubmit="saveKeys(event)">
          <div class="between mb-1">
            <div>
              <div class="muted" style="text-transform:uppercase;">Credentials</div>
              <h3 style="margin:2px 0;">API Keys</h3>
              <p class="muted">Keys are stored locally in your browser.</p>
            </div>
            <button class="btn" type="submit">Save</button>
          </div>
          <div class="grid four">
            <label class="small">Suno API
              <input name="sunoKey" class="input" placeholder="suno_..." value="${state.apiKeys.sunoKey||''}" />
            </label>
            <label class="small">SyncLabs / DistroKid API
              <input name="synclabsKey" class="input" placeholder="sync_..." value="${state.apiKeys.synclabsKey||''}" />
            </label>
            <label class="small">OpenAI API (trend discovery)
              <input name="openaiKey" class="input" placeholder="sk-..." value="${state.apiKeys.openaiKey||''}" />
            </label>
          </div>
          <div class="chips mt-2">
            <span class="chip">Suno → transcription + audio renders</span>
            <span class="chip">SyncLabs → video sync + distro metrics</span>
            <span class="chip">OpenAI → trend scanning + topic infill</span>
          </div>
        </form>
      `;
    }

    function renderTriangulation() {
      const sets = Object.values(data.triangulationSets).flat().map(entry => {
        const score = Math.round(((entry.biteLayers||7)+(entry.referenceDelta||7)+((entry.pulse||1)*10)) * 1.6);
        const readiness = score>=70?'Release Ready':score>=60?'Wiki-polish':score>=50?'Draft refining':'Needs rewrite';
        return { ...entry, score, readiness };
      });
      const avg = Math.round(sets.reduce((a,b)=>a+b.score,0)/sets.length);
      const ready = sets.filter(s=>s.readiness==='Release Ready').length;
      const polish = sets.filter(s=>s.readiness==='Wiki-polish').length;
      return `
        <div class="panel holo">
          <div class="between mb-2">
            <div>
              <div class="muted" style="text-transform:uppercase;">Triangulation · Analytics</div>
              <h3 style="margin:2px 0;">Resonance Dashboard</h3>
              <div class="muted">Heatmaps, trope collisions, and release readiness synced to the wiki.</div>
            </div>
            <div class="chips">
              <span class="chip">Avg Score: ${avg}</span>
              <span class="chip">Release Ready: ${ready}</span>
              <span class="chip">Polish Queue: ${polish}</span>
            </div>
          </div>
          <div class="grid four">
            ${sets.map(entry => `
              <div class="card" style="background: rgba(0,255,65,${0.15 + Math.min(1,entry.score/90)*0.4});">
                <div class="between small">
                  <span>${entry.theme}</span>
                  <span>Score ${entry.score}</span>
                </div>
                <div style="font-weight:700;">${entry.title}</div>
                <div class="muted">${entry.cultureShell} · ${entry.truthVector}</div>
                <div class="chips mt-1">
                  ${(entry.tropes||[]).map(t=>`<span class="tag">${t}</span>`).join('')}
                </div>
                <div class="small">${entry.readiness}</div>
              </div>
            `).join('')}
          </div>
        </div>
      `;
    }

    function renderStory() {
      return `
        <div class="grid two">
          <div class="panel">
            <div class="between mb-1">
              <div>
                <div class="muted" style="text-transform:uppercase;">Lorekeeper Wiki</div>
                <h3 style="margin:4px 0;">Story Engine + Wiki</h3>
              </div>
              <a class="btn secondary" href="story-engine/index.html" target="_blank">Open Story Engine</a>
            </div>
            <p class="muted">Story arcs, tropes, and wiki sections are consolidated here. Links open in a new tab.</p>
            <table class="table mt-1">
              <thead><tr><th>Arc</th><th>Keyword</th><th>Form</th><th>Backlog</th></tr></thead>
              <tbody>
                ${data.arcs.map(arc => `<tr><td>${arc.title}</td><td>${arc.keyword}</td><td>${arc.form}</td><td>${arc.backlog.join(', ')}</td></tr>`).join('')}
              </tbody>
            </table>
          </div>
          <div class="panel">
            <div class="between mb-1">
              <div>
                <div class="muted" style="text-transform:uppercase;">Cast + Explorer</div>
                <h3 style="margin:4px 0;">Story Bible</h3>
              </div>
              <a class="btn secondary" href="story-explorer/index.html" target="_blank">Open Explorer</a>
            </div>
            <p class="muted">Browse the living cast. The explorer pulls truth vectors, trope bundles, and current wiki notes.</p>
            <div class="grid four mt-1">
              ${Object.entries(data.agents).map(([id, agent]) => `
                <div class="card">
                  <div class="between"><strong>${agent.name}</strong><span class="pill">${agent.toki}</span></div>
                  <div class="muted">${agent.core}</div>
                  <div class="muted mt-1">${data.resonanceNodes.find(n=>n.node_id.includes(id))?.resonance_node?.culture_shell || 'lattice pending'}</div>
                </div>
              `).join('')}
            </div>
          </div>
        </div>
      `;
    }

    function renderGraph() {
      const totals = data.resonanceNodes.length;
      const tika = ['pona','ike','pilin'];
      const counts = tika.map(tok => data.resonanceNodes.filter(n => n.toki_pona_profile.dominant_word === tok).length);
      return `
        <div class="grid two">
          <div class="panel holo">
            <div class="between mb-1">
              <div>
                <div class="muted" style="text-transform:uppercase;">Node Lattice</div>
                <h3 style="margin:4px 0;">Resonance Node Tree</h3>
              </div>
              <div class="badge">${totals} nodes</div>
            </div>
            <p class="muted">Compressed resonance nodes blending Humanese lore, meme shells, and industrial bite metrics.</p>
            <div class="grid three mt-1">
              ${data.resonanceNodes.map(node => `
                <div class="card">
                  <div class="between">
                    <span class="pill">${node.node_id}</span>
                    <span class="muted">balance: ${node.toki_pona_profile.truth_balance}</span>
                  </div>
                  <div class="small">Theme: ${node.resonance_node.theme}</div>
                  <div class="small">Shell: ${node.resonance_node.culture_shell}</div>
                  <div class="small">Performance: ${node.performance_delta.organic_rip_potential}</div>
                  <div class="muted mt-1">${node.resonance_node.semiotic_lesson}</div>
                </div>
              `).join('')}
            </div>
          </div>
          <div class="panel">
            <h3 style="margin:0 0 6px;">Toki Pona Tracker · Zero State</h3>
            <p class="muted">Balancing pona (hope arc), ike (critique arc), and pilin (heart connector) to prevent sterile drops.</p>
            <div class="grid three mt-1">
              ${tika.map((tok, idx) => `
                <div class="card">
                  <div class="muted">${tok}</div>
                  <div style="font-size:20px;font-weight:700;">${counts[idx]}</div>
                  <div class="muted">${tok==='pona'?'Hope-weighted payloads':tok==='ike'?'Anger/critique arcs':'Heart connectors'}</div>
                </div>
              `).join('')}
            </div>
            <div class="card mt-2" style="background:rgba(0,0,0,0.4);">
              <div class="muted">Node JSON (live)</div>
              <pre style="white-space:pre-wrap;color:#9fffb4;font-size:11px;">${JSON.stringify(data.resonanceNodes[0], null, 2)}</pre>
            </div>
          </div>
        </div>
      `;
    }

    function renderCast() {
      return `
        <div class="grid two">
          <div class="panel holo">
            <div class="between mb-1">
              <div>
                <div class="muted" style="text-transform:uppercase;">Bridge Routing</div>
                <h3 style="margin:4px 0;">Overview + Dispatch</h3>
              </div>
              <div class="badge">Single-page cockpit</div>
            </div>
            <p class="muted">Interior builder, narrative elements, and embedded tools kept inside the router shell.</p>
            <div class="chips mt-1">
              <span class="chip">Story wiki docked</span>
              <span class="chip">Cast explorer docked</span>
              <span class="chip">Graph cockpit docked</span>
            </div>
          </div>
          <div class="panel">
            <h3 style="margin:0 0 6px;">Samples & Adjacency</h3>
            <p class="muted">Link “spitting fire bars” to pixel columns, candy bars, prison bars, and Frogger hops. Pair Will Smith mythos with Oscars scandal.</p>
            <p class="muted">Use off-centered UI as desire paths; comments as chorus; skimming as sprint. Joke explained midflight still lands if the rhythm is forged.</p>
          </div>
        </div>
      `;
    }

    function renderWeaver() {
      return `
        <div class="grid two">
          <div class="panel holo">
            <div class="between mb-1">
              <div>
                <div class="muted" style="text-transform:uppercase;">Sovereign Automated IP</div>
                <h3 style="margin:4px 0;">Weaver Protocol · Operations Stack</h3>
                <p class="muted">Sub-agents handle provisioning, trope infill, and self-repair; chorus accounts follow audience votes.</p>
              </div>
              <div class="badge">Integrity Layer · 100-year stance</div>
            </div>
            <div class="grid three mt-1">
              ${data.provisioning.map(agent => `
                <div class="card">
                  <div class="between">
                    <div>
                      <div style="font-weight:700;">${agent.id}</div>
                      <div class="muted">${agent.scope}</div>
                    </div>
                    <span class="status ${agent.status==='alert'?'fail':agent.status==='stable'?'ok':'warn'}">${(agent.status||'idle').toUpperCase()}</span>
                  </div>
                  <div class="muted">${agent.focus}</div>
                  <div class="muted">SLA: ${agent.sla}</div>
                  <div class="muted">Last ping: ${agent.lastPing||'--'}</div>
                  <button class="btn mt-1" onclick="runProvisioning('${agent.id}')">Run check</button>
                </div>
              `).join('')}
            </div>
          </div>
          <div class="panel">
            <div class="between mb-1">
              <h3 style="margin:0;">Comment-Driven Orchestration</h3>
              <button class="btn" onclick="parseVotes()">Parse votes</button>
            </div>
            <p class="muted">Paste recent comments/keywords to steer the next drop. Keywords map to the arc library (pona/ike/pilin).</p>
            <textarea class="textarea" oninput="state.voteDraft=this.value">${state.voteDraft}</textarea>
            <div class="card mt-1">
              <div class="muted">Next Drop</div>
              <div class="between">
                <div>
                  <div style="font-weight:700;">${data.arcs[state.nextArc].title}</div>
                  <div class="muted">Form: ${data.arcs[state.nextArc].form} · CPV target $${data.arcs[state.nextArc].cpv}</div>
                  <div class="muted">Backlog: ${data.arcs[state.nextArc].backlog.join(', ')}</div>
                </div>
                <button class="btn" onclick="rotateCTA()">Rotate CTA</button>
              </div>
              <div class="small">Value Gate → ${state.cta}</div>
            </div>
            <div class="mt-1 muted" style="font-size:11px;">Arc selection simulates the “American Idol” vote and feeds the drop planner.</div>
          </div>
          <div class="panel holo">
            <div class="between mb-1">
              <h3 style="margin:0;">Integrity Ledger</h3>
              <button class="btn" onclick="patchLink()">Patch link</button>
            </div>
            <div class="grid three">
              <div class="card"><div class="muted">Linked</div><div style="font-size:20px;font-weight:700;">${state.backlogHealth.linked}</div></div>
              <div class="card"><div class="muted">Broken</div><div style="font-size:20px;font-weight:700;color:#facc15;">${state.backlogHealth.broken}</div></div>
              <div class="card"><div class="muted">Patched</div><div style="font-size:20px;font-weight:700;">${state.backlogHealth.patched}</div></div>
            </div>
            <div class="log mt-1">
              ${state.ledger.map(item => `<div>[${item.ts}] ${item.msg}</div>`).join('')}
            </div>
          </div>
        </div>
      `;
    }

    function renderBasilisk() {
      return `
        <div class="panel holo">
          <div class="between mb-1">
            <div>
              <div class="muted" style="text-transform:uppercase;">Hidden module</div>
              <h3 style="margin:4px 0;">BASILISK PROTOCOL</h3>
              <p class="muted">Live dashboard for trend ingestion, frogger leaps, and scattergun payouts. Docked inside the SPA shell.</p>
            </div>
            <button class="btn" onclick="simulatePayout()">Simulate $1k payout</button>
          </div>
          <div class="grid two">
            <div class="card">
              <div class="between mb-1">
                <h4 style="margin:0;">Trend Scanner</h4>
                <button class="btn" onclick="scanOpenInternet()">Scan leading topics</button>
              </div>
              <div class="muted">Trend Discovery status: ${state.apiStatus.trendDiscovery}</div>
              <div class="grid four mt-1">
                ${state.trends.map(t => `<div class="card" style="border-color:rgba(0,255,65,0.4);"><div class="between"><strong>${t.topic}</strong><span class="muted">${t.volatility}</span></div><div class="muted">${t.category}</div><button class="btn mt-1" onclick="froggerLeap('${t.topic}')">Trigger leap</button></div>`).join('') || '<div class="muted">No trends yet.</div>'}
              </div>
            </div>
            <div class="card">
              <div class="between mb-1">
                <h4 style="margin:0;">Asset Generator</h4>
                <button class="btn" onclick="syncTranscriptions()">Queue transcriptions</button>
              </div>
              <div class="muted">Transcription status: ${state.apiStatus.transcription}</div>
              <div class="muted">DistroKid status: ${state.apiStatus.distroStats}</div>
              <div class="mt-1 card" style="background:rgba(0,255,65,0.05);">
                ${state.generatedContent ? `
                  <div class="muted">PATH: ${state.generatedContent.topic} → ${state.generatedContent.anchor}</div>
                  <div style="font-style:italic;">"${state.generatedContent.script}"</div>
                  <div class="chips mt-1">
                    <span class="chip">${state.generatedContent.audioStatus}</span>
                    <span class="chip">${state.generatedContent.videoStatus}</span>
                  </div>
                ` : '<div class="muted">Waiting for Frogger Leap...</div>'}
              </div>
              <div class="mt-1">
                <button class="btn" onclick="fetchDistroStats()">Sync DistroKid metrics</button>
              </div>
            </div>
          </div>
          <div class="grid two mt-1">
            <div class="card">
              <h4 style="margin:0 0 6px;">Scattershot Holdings</h4>
              <div class="grid four">
                ${state.financials.holdings.map(h => `<div class="card"><div style="font-weight:700;">${h.ticker}</div><div class="muted">${h.vibe}</div></div>`).join('')}
              </div>
            </div>
            <div class="card">
              <h4 style="margin:0 0 6px;">Bagman Split</h4>
              <div class="small">War Chest (30%)</div>
              <div class="progress"><span style="width:${(state.financials.warChest/state.financials.totalRevenue)*100}%"></span></div>
              <div class="small mt-1">Casino (20%)</div>
              <div class="progress"><span style="width:${(state.financials.casino/state.financials.totalRevenue)*100}%"></span></div>
              <div class="small mt-1">Total Revenue: $${state.financials.totalRevenue}</div>
            </div>
          </div>
          <div class="log mt-1">${state.logs.map(l => `<div>${l}</div>`).join('')}</div>
        </div>
      `;
    }

    function renderOverview() {
      return `
        ${renderTriangulation()}
        ${renderStory()}
      `;
    }

    function renderContent() {
      if (state.view === 'overview') return renderOverview();
      if (state.view === 'story') return renderStory();
      if (state.view === 'graph') return renderGraph();
      if (state.view === 'cast') return renderCast();
      if (state.view === 'weaver') return renderWeaver();
      if (state.view === 'basilisk') return renderBasilisk();
      return '<div class="panel">No view selected.</div>';
    }

    function render() {
      $('#app').innerHTML = `
        <div style="max-width:1200px;margin:0 auto;padding:16px;">
          ${renderHeader()}
          <main class="two-col" style="margin-top:12px;">
            <div class="grid">
              ${renderNav()}
              ${renderApiKeys()}
            </div>
            <div class="grid" id="main-content">
              ${renderContent()}
            </div>
          </main>
        </div>
      `;
    }

    render();
  </script>
</body>
</html>
