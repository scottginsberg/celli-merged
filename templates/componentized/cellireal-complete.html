<script type="module">
// Guard against duplicate boot/RAF chains
if (window.__CELL_REWORK_BOOTED__) {
 console.warn('Duplicate boot blocked');
 throw new Error('Duplicate boot');
}
window.__CELL_REWORK_BOOTED__ = true;
// Debug: global render-order controls (defaults)
// Shells behind fills by default; array frame behind all
window.__RO = window.__RO || { ghostFill:350, solidFill:360, solidShell:340, ghostShell:300, frameCore:295, frameShell:300 };
const statusEl = document.getElementById('statusChip');
const safeStatus = (text) => {
 if (!statusEl) return;
 statusEl.textContent = text == null ? '' : String(text);
};

(async () => {
/* ===========================
 Imports
=========================== */
// Try multiple import strategies to bypass caching issues
let THREE, OrbitControls, RoundedBoxGeometry, BufferGeometryUtils;
let EffectComposer, RenderPass, UnrealBloomPass, BokehPass, ShaderPass, FXAAShader, OutlinePass, AfterimagePass, OutputPass;
let RGBELoader, Reflector;

try {
 // Strategy 1: Use CDN with proper module paths
 const baseUrl = 'https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js';
 const examplesBase = 'https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm';
 const [threeModule, controlsModule, geometryModule, utilsModule,
 effectComposerModule, renderPassModule, bloomPassModule, bokehPassModule,
 shaderPassModule, fxaaModule, outlineModule, afterimageModule, outputModule,
 rgbeModule, reflectorModule
 ] = await Promise.all([
 import(baseUrl),
 import(`${examplesBase}/controls/OrbitControls.js`),
 import(`${examplesBase}/geometries/RoundedBoxGeometry.js`),
 import(`${examplesBase}/utils/BufferGeometryUtils.js`),
 import(`${examplesBase}/postprocessing/EffectComposer.js`),
 import(`${examplesBase}/postprocessing/RenderPass.js`),
 import(`${examplesBase}/postprocessing/UnrealBloomPass.js`),
 import(`${examplesBase}/postprocessing/BokehPass.js`),
 import(`${examplesBase}/postprocessing/ShaderPass.js`),
 import(`${examplesBase}/shaders/FXAAShader.js`),
 import(`${examplesBase}/postprocessing/OutlinePass.js`),
 import(`${examplesBase}/postprocessing/AfterimagePass.js`),
 import(`${examplesBase}/postprocessing/OutputPass.js`),
 import(`${examplesBase}/loaders/RGBELoader.js`),
 import(`${examplesBase}/objects/Reflector.js`)
 ]);

 THREE = threeModule.default || threeModule;
 OrbitControls = controlsModule.OrbitControls || controlsModule.default;
 RoundedBoxGeometry = geometryModule.RoundedBoxGeometry || geometryModule.default;
 BufferGeometryUtils = utilsModule.default || utilsModule;
 EffectComposer = effectComposerModule.EffectComposer || effectComposerModule.default;
 RenderPass = renderPassModule.RenderPass || renderPassModule.default;
 UnrealBloomPass = bloomPassModule.UnrealBloomPass || bloomPassModule.default;
 BokehPass = bokehPassModule.BokehPass || bokehPassModule.default;
 ShaderPass = shaderPassModule.ShaderPass || shaderPassModule.default;
 FXAAShader = fxaaModule.FXAAShader || fxaaModule.default;
 OutlinePass = outlineModule.OutlinePass || outlineModule.default;
 AfterimagePass = afterimageModule.AfterimagePass || afterimageModule.default;
 OutputPass = outputModule.OutputPass || outputModule.default;
 RGBELoader = rgbeModule.RGBELoader || rgbeModule.default;
 Reflector = reflectorModule.Reflector || reflectorModule.default;

 console.log('Three.js imports successful:', !!THREE.Scene, !!OrbitControls, !!RoundedBoxGeometry);
 safeStatus('Modules loaded successfully');
} catch(e) {
 console.error('Import failed:', e);
 safeStatus('Import failed: ' + e.message);
 throw e;
}
// Fancy mode removed; keep only core Three.js imports
// Removed heavy AO/Vignette to keep the look clean and modern
// Dynamic Rapier loader (optional)
let RAPIER = null; let RAP_READY = false;
let rapierLoadPromise = null;
let rapierInitPromise = null;
// Global intro flag to guarantee onboarding runs exactly once across handlers
window.__INTRO_FIRED = window.__INTRO_FIRED || false;

// Initialize Twemoji for consistent emoji rendering
if(typeof twemoji !== 'undefined'){
 twemoji.parse(document.body, {
 folder: 'svg',
 ext: '.svg',
 className: 'emoji'
 });
}
const playClickSound = (()=>{
 try{
 const audio = new Audio('https://threejs.org/examples/sounds/ping_pong.mp3');
 audio.preload = 'auto';
 audio.volume = 0.55;
 return ()=>{ try{ audio.currentTime = 0; audio.play(); }catch{} };
 }catch{
function updateStatus(t){ safeStatus(t); }
(async ()=>{
 try {
 console.log('Starting immediate initialization...');
 const restoreDebug = readPersistedPhysicsDebug();
 console.log('Initialization complete');
 } catch(e) {
 console.error('Initialization failed:', e);
 }
})();
})().catch((err) => {
 console.error('Boot sequence failed', err);
 const message = err && err.message ? `Boot failed: ${err.message}` : 'Boot failed';
 safeStatus(message);
});
</script>
