<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Celli Beta Focus</title>
  <style>
    :root {
      color-scheme: only dark;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #000;
      font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: #fff;
      letter-spacing: 0.08em;
    }

    main {
      width: min(520px, 92vw);
    }

    .form-panel {
      position: relative;
      padding: clamp(2.5rem, 6vw, 3.5rem) clamp(1.5rem, 6vw, 3rem) clamp(2.25rem, 6vw, 3.25rem);
      border: 4px solid #fff;
      background: #000;
      display: grid;
      gap: clamp(1.5rem, 4vw, 2rem);
      box-shadow: 0 0 0 10px #000, 0 0 38px rgba(255, 255, 255, 0.16);
      transition: transform 0.18s ease, border-color 0.6s ease;
    }

    .form-panel.fade-out {
      border-color: rgba(255, 255, 255, 0.5);
    }

    .focus-form {
      transition: opacity 0.6s ease, transform 0.6s ease;
    }

    .form-panel.fade-out .focus-form {
      opacity: 0;
      transform: scale(0.96);
      pointer-events: none;
    }

    .visualizer-overlay {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: clamp(1.5rem, 4vw, 2.25rem);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.6s ease;
      padding: clamp(1.5rem, 4vw, 2.5rem);
      z-index: 2;
      background: linear-gradient(180deg, rgba(0, 0, 0, 0.15) 0%, rgba(0, 0, 0, 0.75) 100%);
    }

    .visualizer-overlay.active {
      opacity: 1;
    }

    .visualizer-selections {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      justify-content: center;
      text-transform: uppercase;
      letter-spacing: 0.2em;
      font-weight: 700;
      text-align: center;
    }

    .selection-burst {
      position: relative;
      padding: 0.75rem 1.5rem;
      border: 2px solid rgba(255, 255, 255, 0.65);
      color: #fff;
      background: rgba(255, 255, 255, 0.12);
      box-shadow: 0 0 18px rgba(255, 255, 255, 0.2);
      animation: selectionBurst 1.9s ease-out var(--burst-delay, 0ms) infinite;
      backdrop-filter: blur(6px);
    }

    @keyframes selectionBurst {
      0% {
        opacity: 1;
        transform: translate3d(0, 0, 0) scale(1);
      }
      45% {
        opacity: 1;
        transform: translate3d(var(--burst-x, 0px), var(--burst-y, 0px), 0) scale(1.08);
      }
      70% {
        opacity: 0.8;
        transform: translate3d(calc(var(--burst-x, 0px) * 1.2), calc(var(--burst-y, 0px) * 1.2), 0) scale(0.94);
      }
      100% {
        opacity: 0;
        transform: translate3d(calc(var(--burst-x, 0px) * 1.6), calc(var(--burst-y, 0px) * 1.6), 0) scale(0.88);
      }
    }

    #audioVisualizer {
      width: min(100%, 480px);
      height: clamp(160px, 36vw, 220px);
      border: 2px solid rgba(255, 255, 255, 0.55);
      background: radial-gradient(circle at center, rgba(255, 255, 255, 0.18), rgba(0, 0, 0, 0.85));
      box-shadow: 0 0 25px rgba(255, 255, 255, 0.2);
    }

    .form-panel::before {
      content: "";
      position: absolute;
      inset: clamp(1.25rem, 4vw, 2rem) clamp(1.25rem, 4vw, 2rem) auto clamp(1.25rem, 4vw, 2rem);
      height: 6px;
      background: #fff;
    }

    h1 {
      margin: clamp(0rem, 1vw, 0.5rem) 0 0;
      font-size: clamp(1.1rem, 2.6vw, 1.6rem);
      text-transform: uppercase;
      text-align: center;
      line-height: 1.4;
      letter-spacing: 0.14em;
    }

    .prompt {
      margin: 0;
      text-align: center;
      font-size: clamp(0.95rem, 2.4vw, 1.1rem);
      text-transform: uppercase;
    }

    .options {
      display: grid;
      gap: clamp(0.65rem, 2vw, 0.85rem);
    }

    .focus-option {
      border: 3px solid #fff;
      background: #0d0d0d;
      color: inherit;
      padding: 0.85rem 1.25rem;
      font-size: clamp(0.95rem, 2.4vw, 1.05rem);
      text-transform: uppercase;
      letter-spacing: 0.16em;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.18s ease, background 0.18s ease, color 0.18s ease;
    }

    .focus-option:hover,
    .focus-option:focus-visible {
      background: #fff;
      color: #000;
      transform: translateY(-3px);
      outline: none;
    }

    .focus-option:active {
      transform: translateY(0);
    }

    .focus-option.selected {
      background: #fff;
      color: #000;
      transform: translateY(-3px);
    }

    .form-actions {
      display: flex;
      justify-content: center;
    }

    .submit-button {
      border: 3px solid #fff;
      background: #fff;
      color: #000;
      padding: 0.85rem 2.5rem;
      font-size: clamp(0.95rem, 2.4vw, 1.05rem);
      text-transform: uppercase;
      letter-spacing: 0.2em;
      font-weight: 700;
      cursor: pointer;
      transition: transform 0.18s ease, background 0.18s ease, color 0.18s ease;
    }

    .submit-button:hover,
    .submit-button:focus-visible {
      background: transparent;
      color: #fff;
      transform: translateY(-3px);
      outline: none;
    }

    .encore-controls {
      display: grid;
      gap: 0.75rem;
      justify-items: center;
    }

    .status {
      min-height: 1.2em;
      font-size: 0.75rem;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      text-align: center;
      color: #c8c8c8;
    }

    .escape-button {
      position: absolute;
      top: clamp(0.75rem, 3vw, 1.5rem);
      right: clamp(0.75rem, 3vw, 1.5rem);
      border: 3px solid #ff385b;
      background: #ff1f47;
      color: #fff;
      padding: 0.6rem 1.35rem;
      text-transform: uppercase;
      letter-spacing: 0.18em;
      font-weight: 800;
      cursor: pointer;
      display: none;
      transition: transform 0.2s ease, background 0.2s ease, color 0.2s ease;
      box-shadow: 0 8px 28px rgba(255, 24, 72, 0.35);
    }

    .escape-button.visible {
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .escape-button:hover,
    .escape-button:focus-visible {
      background: #fff;
      color: #ff1f47;
      transform: translateY(-2px);
      outline: none;
    }

    .form-panel.shake {
      animation: shake 0.4s ease;
    }

    @keyframes shake {
      0%, 100% {
        transform: translateX(0);
      }
      20% {
        transform: translateX(-10px);
      }
      40% {
        transform: translateX(8px);
      }
      60% {
        transform: translateX(-6px);
      }
      80% {
        transform: translateX(4px);
      }
    }

    footer {
      text-align: center;
      font-size: 0.65rem;
      text-transform: uppercase;
      letter-spacing: 0.22em;
      color: #6f6f6f;
    }
  </style>
</head>
<body>
  <main id="betaFocusPanel" class="form-panel" aria-labelledby="betaFocusHeading">
    <form id="betaFocusForm" class="focus-form" novalidate>
      <h1 id="betaFocusHeading">Before we get started…</h1>
      <p class="prompt">Is there anything we should focus on first for our beta release?</p>
      <div class="options" role="group" aria-label="Beta focus options">
        <button type="button" class="focus-option" data-value="Level Editor">Level Editor</button>
        <button type="button" class="focus-option" data-value="Story Mode">Story Mode</button>
        <button type="button" class="focus-option" data-value="Cute Stuff">Cute Stuff</button>
        <button type="button" class="focus-option" data-value="Musical Numbers">Musical Numbers</button>
        <button type="button" class="focus-option" data-value="Boss Fights">Boss Fights</button>
        <button type="button" class="focus-option" data-value="Puzzles">Puzzles</button>
        <button type="button" class="focus-option" data-value="Riddles">Riddles</button>
        <button type="button" class="focus-option" data-value="Clues">Clues</button>
        <button type="button" class="focus-option" data-value="Celli Dance Party">Celli Dance Party</button>
      </div>
      <div class="form-actions">
        <button type="submit" class="submit-button">Submit</button>
      </div>
      <div class="encore-controls">
        <div id="audioStatus" class="status" role="status" aria-live="polite"></div>
      </div>
      <footer>EA.mp3, EA2.mp3, EA3.mp3, and E4.mp3 are ready to play.</footer>
    </form>
    <button type="button" id="escapeEncoreButton" class="escape-button" aria-live="polite" aria-label="Get me out of here!">Get me out of here!</button>
    <div id="visualizerOverlay" class="visualizer-overlay" aria-hidden="true">
      <div id="visualizerSelections" class="visualizer-selections"></div>
      <canvas id="audioVisualizer" width="480" height="220" role="presentation"></canvas>
    </div>
  </main>
  <script>
    (function () {
      const panel = document.getElementById('betaFocusPanel');
      const form = document.getElementById('betaFocusForm');
      const optionButtons = Array.from(document.querySelectorAll('.focus-option'));
      const statusEl = document.getElementById('audioStatus');
      const escapeButton = document.getElementById('escapeEncoreButton');
      const overlay = document.getElementById('visualizerOverlay');
      const overlaySelections = document.getElementById('visualizerSelections');
      const visualizerCanvas = document.getElementById('audioVisualizer');
      const visualizerCtx = visualizerCanvas ? visualizerCanvas.getContext('2d') : null;

      const AUDIO_PATH_PREFIX = '../../';

      function createTrack(fileName) {
        const audio = new Audio(`${AUDIO_PATH_PREFIX}${fileName}`);
        audio.preload = 'auto';
        return audio;
      }

      const baseTrack = createTrack('EA.mp3');
      const encoreTrack = createTrack('EA2.mp3');
      const superEncoreTrack = createTrack('EA3.mp3');
      const finaleTrack = createTrack('E4.mp3');

      const tracks = [baseTrack, encoreTrack, superEncoreTrack, finaleTrack];
      const encoreTracks = [encoreTrack, superEncoreTrack, finaleTrack];
      const encoreLabels = [
        'Encore — playing EA2.mp3…',
        'Super Encore — playing EA3.mp3…',
        'Finale — playing E4.mp3…',
      ];
      const encoreEndMessages = [
        'Encore complete — ready for one more?',
        'Super Encore complete — finale ready?',
        'Finale complete. Thank you!',
      ];

      const audioContextState = {
        context: null,
        analyser: null,
        dataArray: null,
        animationId: null,
        destinationConnected: false,
      };
      const trackSourceNodes = new Map();
      const DEFAULT_ESCAPE_LABEL = 'Get me out of here!';
      const ENCORE_LABEL = 'ENCORE!';
      const NEAR_DISTANCE = 72;

      function ensureAudioContext() {
        if (!visualizerCanvas || !visualizerCtx) {
          return null;
        }

        const AudioContextCtor = window.AudioContext || window.webkitAudioContext;
        if (!AudioContextCtor) {
          return null;
        }

        if (!audioContextState.context) {
          audioContextState.context = new AudioContextCtor();
          audioContextState.analyser = audioContextState.context.createAnalyser();
          audioContextState.analyser.fftSize = 256;
          audioContextState.dataArray = new Uint8Array(audioContextState.analyser.frequencyBinCount);
        }

        if (!audioContextState.destinationConnected && audioContextState.analyser && audioContextState.context) {
          audioContextState.analyser.connect(audioContextState.context.destination);
          audioContextState.destinationConnected = true;
        }

        return audioContextState;
      }

      function resumeAudioContext() {
        const state = ensureAudioContext();
        if (!state || !state.context) {
          return;
        }

        if (state.context.state === 'suspended') {
          state.context.resume().catch((error) => {
            console.warn('Unable to resume audio context', error);
          });
        }
      }

      function connectAudioSource(audio) {
        const state = ensureAudioContext();
        if (!state || !state.context || !state.analyser || trackSourceNodes.has(audio)) {
          return;
        }

        try {
          const source = state.context.createMediaElementSource(audio);
          source.connect(state.analyser);
          trackSourceNodes.set(audio, source);
        } catch (error) {
          console.warn('Unable to connect audio source', error);
        }
      }

      function stopVisualizer() {
        if (audioContextState.animationId) {
          window.cancelAnimationFrame(audioContextState.animationId);
          audioContextState.animationId = null;
        }

        if (visualizerCtx && visualizerCanvas) {
          visualizerCtx.clearRect(0, 0, visualizerCanvas.width, visualizerCanvas.height);
        }
      }

      function startVisualizer(audio) {
        const state = ensureAudioContext();
        if (!state || !state.analyser || !visualizerCanvas || !visualizerCtx) {
          return;
        }

        connectAudioSource(audio);
        resumeAudioContext();

        const cssWidth = visualizerCanvas.clientWidth || visualizerCanvas.width;
        const cssHeight = visualizerCanvas.clientHeight || visualizerCanvas.height;
        if (cssWidth && cssHeight) {
          visualizerCanvas.width = cssWidth;
          visualizerCanvas.height = cssHeight;
        }

        const bufferLength = state.analyser.frequencyBinCount;
        const width = visualizerCanvas.width;
        const height = visualizerCanvas.height;

        function draw() {
          state.animationId = window.requestAnimationFrame(draw);
          state.analyser.getByteFrequencyData(state.dataArray);
          visualizerCtx.clearRect(0, 0, width, height);

          const barWidth = (width / bufferLength) * 1.5;
          let x = 0;

          for (let i = 0; i < bufferLength; i += 1) {
            const value = state.dataArray[i] / 255;
            const barHeight = value * height;
            const hue = 200 + value * 140;
            visualizerCtx.fillStyle = `hsla(${hue}, 85%, ${45 + value * 35}%, ${0.55 + value * 0.35})`;
            visualizerCtx.fillRect(x, height - barHeight, barWidth, barHeight);
            x += barWidth + 2;
          }
        }

        window.cancelAnimationFrame(state.animationId);
        draw();
      }

      function ensureOverlayActive() {
        if (overlay) {
          overlay.classList.add('active');
        }
      }

      function createSelectionBurst(label, index) {
        const burst = document.createElement('span');
        burst.className = 'selection-burst';
        burst.textContent = label;
        const angle = Math.random() * Math.PI * 2;
        const distance = 32 + Math.random() * 60;
        burst.style.setProperty('--burst-x', `${Math.cos(angle) * distance}px`);
        burst.style.setProperty('--burst-y', `${Math.sin(angle) * distance}px`);
        burst.style.setProperty('--burst-delay', `${index * 120}ms`);
        return burst;
      }

      function showSelectionOverlay() {
        if (!overlay) {
          return;
        }

        ensureOverlayActive();

        if (!overlaySelections) {
          return;
        }

        overlaySelections.innerHTML = '';

        const selectedButtons = optionButtons.filter((btn) => btn.classList.contains('selected'));
        if (selectedButtons.length > 0) {
          selectedButtons.forEach((btn, index) => {
            overlaySelections.appendChild(createSelectionBurst(btn.textContent.trim(), index));
          });
        } else if (selectedOption) {
          overlaySelections.appendChild(createSelectionBurst(selectedOption, 0));
        }
      }

      let selectedOption = null;
      let encoreIndex = 0;
      let escapeLabelState = DEFAULT_ESCAPE_LABEL;

      function updateStatus(message) {
        if (statusEl) {
          statusEl.textContent = message || '';
        }
      }

      function triggerPanelShake() {
        if (!panel) {
          return;
        }
        panel.classList.remove('shake');
        void panel.offsetWidth;
        panel.classList.add('shake');
      }

      function stopOtherTracks(except) {
        stopVisualizer();
        tracks.forEach((audio) => {
          if (audio !== except) {
            audio.pause();
            try {
              audio.currentTime = 0;
            } catch (error) {
              console.warn('Unable to reset audio time', error);
            }
          }
        });
      }

      function handlePlaybackPromise(promise, label, audio) {
        if (!promise || typeof promise.then !== 'function') {
          updateStatus(label);
          startVisualizer(audio);
          return;
        }

        promise
          .then(() => {
            updateStatus(label);
            startVisualizer(audio);
          })
          .catch((error) => {
            console.warn('Audio playback failed. Ensure EA tracks are available.', error);
            updateStatus('Audio unavailable — please add EA.mp3, EA2.mp3, EA3.mp3, and E4.mp3.');
            stopVisualizer();
          });
      }

      function playTrack(audio, label) {
        stopOtherTracks(audio);
        try {
          audio.currentTime = 0;
        } catch (error) {
          console.warn('Unable to reset selected audio time', error);
        }
        ensureOverlayActive();
        resumeAudioContext();
        const playback = audio.play();
        handlePlaybackPromise(playback, label, audio);
      }

      function updateEscapeLabel(near) {
        const nextLabel = near ? ENCORE_LABEL : DEFAULT_ESCAPE_LABEL;
        if (!escapeButton || escapeLabelState === nextLabel) {
          return;
        }

        escapeLabelState = nextLabel;
        escapeButton.textContent = nextLabel;
        escapeButton.setAttribute('aria-label', nextLabel);
      }

      function showEscapeButton() {
        if (!escapeButton) {
          return;
        }
        escapeButton.classList.add('visible');
        updateEscapeLabel(false);
      }

      function isPointerNearButton(x, y) {
        if (!escapeButton || !escapeButton.classList.contains('visible')) {
          return false;
        }

        const rect = escapeButton.getBoundingClientRect();
        const withinX = x >= rect.left - NEAR_DISTANCE && x <= rect.right + NEAR_DISTANCE;
        const withinY = y >= rect.top - NEAR_DISTANCE && y <= rect.bottom + NEAR_DISTANCE;
        return withinX && withinY;
      }

      function handlePointerProximity(event) {
        if (!event || !('clientX' in event) || !escapeButton || !escapeButton.classList.contains('visible')) {
          return;
        }

        const near = isPointerNearButton(event.clientX, event.clientY);
        updateEscapeLabel(near);
      }

      function playNextEncoreTrack() {
        const track = encoreTracks[encoreIndex % encoreTracks.length];
        const label = encoreLabels[encoreIndex % encoreLabels.length];
        encoreIndex = (encoreIndex + 1) % encoreTracks.length;
        triggerPanelShake();
        playTrack(track, label);
      }

      optionButtons.forEach((button) => {
        button.addEventListener('click', () => {
          selectedOption = button.dataset.value || button.textContent.trim();
          optionButtons.forEach((btn) => {
            btn.classList.toggle('selected', btn === button);
          });
          triggerPanelShake();
          updateStatus(`Selected: ${selectedOption}`);
        });
      });

      if (form) {
        form.addEventListener('submit', (event) => {
          event.preventDefault();

          if (!selectedOption) {
            triggerPanelShake();
            updateStatus('Choose an option before submitting.');
            return;
          }

          encoreIndex = 0;
          triggerPanelShake();
          if (panel) {
            panel.classList.add('fade-out');
          }
          showSelectionOverlay();
          playTrack(baseTrack, 'Playing EA.mp3…');
          updateStatus(`Playing EA.mp3 for “${selectedOption}”.`);
          showEscapeButton();
        });
      }

      baseTrack.addEventListener('ended', () => {
        stopVisualizer();
        updateStatus('Encore ready. Hover over the red button.');
      });

      [encoreTrack, superEncoreTrack, finaleTrack].forEach((track, index) => {
        track.addEventListener('ended', () => {
          stopVisualizer();
          updateStatus(encoreEndMessages[index] || 'Encore complete.');
        });
      });

      if (escapeButton) {
        escapeButton.addEventListener('click', () => {
          if (!escapeButton.classList.contains('visible')) {
            return;
          }
          playNextEncoreTrack();
        });

        escapeButton.addEventListener('pointerenter', () => updateEscapeLabel(true));
        escapeButton.addEventListener('pointerleave', () => updateEscapeLabel(false));
        escapeButton.addEventListener('focus', () => updateEscapeLabel(true));
        escapeButton.addEventListener('blur', () => updateEscapeLabel(false));
      }

      document.addEventListener('pointermove', handlePointerProximity);
      document.addEventListener('pointerdown', handlePointerProximity);

      updateStatus('Pick a focus to start the track.');
      updateEscapeLabel(false);
    })();
  </script>
</body>
</html>
