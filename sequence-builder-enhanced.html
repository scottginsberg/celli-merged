<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Celli Sequence Builder - Enhanced Asset Manager</title>
  
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #1a1a1a;
      color: #e0e0e0;
      overflow: hidden;
    }

    /* Main Layout - 4 Panel Grid */
    .builder-container {
      display: grid;
      grid-template-columns: 320px 1fr 380px;
      grid-template-rows: 60px 1fr 200px;
      height: 100vh;
      gap: 0;
    }

    /* ===== HEADER ===== */
    .builder-header {
      grid-column: 1 / -1;
      background: linear-gradient(135deg, #2c3e50 0%, #1a252f 100%);
      border-bottom: 2px solid #34495e;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }

    .builder-title {
      font-size: 20px;
      font-weight: 600;
      color: #ecf0f1;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .scene-badge {
      background: #3498db;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 0.5px;
    }

    .builder-controls {
      display: flex;
      gap: 8px;
    }

    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .btn-primary { background: #3498db; color: white; }
    .btn-primary:hover { background: #2980b9; transform: translateY(-1px); }
    .btn-success { background: #27ae60; color: white; }
    .btn-success:hover { background: #229954; }
    .btn-danger { background: #e74c3c; color: white; }
    .btn-danger:hover { background: #c0392b; }
    .btn-secondary { background: #7f8c8d; color: white; }
    .btn-secondary:hover { background: #5d6d6e; }

    /* ===== LEFT PANEL - ASSET MANAGER ===== */
    .panel-left {
      background: #2c2c2c;
      border-right: 1px solid #444;
      overflow-y: auto;
      padding: 15px;
    }

    .asset-manager-header {
      background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 15px;
      border: 1px solid #445566;
    }

    .asset-manager-title {
      font-size: 14px;
      font-weight: 700;
      color: #3498db;
      margin-bottom: 8px;
    }

    .asset-stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      font-size: 10px;
      color: #bdc3c7;
    }

    .stat-item {
      background: rgba(52, 152, 219, 0.1);
      padding: 6px;
      border-radius: 4px;
      text-align: center;
    }

    .stat-value {
      font-size: 16px;
      font-weight: 700;
      color: #3498db;
      display: block;
    }

    /* Expandable Asset Groups */
    .asset-group {
      margin-bottom: 12px;
      background: #353535;
      border-radius: 6px;
      overflow: hidden;
      border: 1px solid #444;
    }

    .asset-group-header {
      padding: 10px 12px;
      background: #2a2a2a;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      transition: background 0.2s;
      user-select: none;
    }

    .asset-group-header:hover {
      background: #333;
    }

    .asset-group-header.active {
      background: #2c3e50;
    }

    .asset-group-title {
      font-size: 12px;
      font-weight: 700;
      color: #e0e0e0;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .asset-count {
      background: #3498db;
      color: white;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 10px;
      font-weight: 700;
    }

    .expand-icon {
      font-size: 12px;
      transition: transform 0.2s;
      color: #999;
    }

    .asset-group-header.active .expand-icon {
      transform: rotate(90deg);
    }

    .asset-group-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease-out;
    }

    .asset-group-content.expanded {
      max-height: 600px;
      overflow-y: auto;
    }

    .asset-item {
      padding: 8px 12px;
      margin: 4px 8px;
      background: #2a2a2a;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 11px;
      border-left: 3px solid transparent;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .asset-item:hover {
      background: #404040;
      border-left-color: #3498db;
      transform: translateX(4px);
    }

    .asset-item.selected {
      background: #2c3e50;
      border-left-color: #3498db;
    }

    .asset-name {
      font-weight: 600;
      color: #e0e0e0;
    }

    .asset-type {
      font-size: 9px;
      padding: 2px 6px;
      border-radius: 3px;
      font-weight: 700;
      text-transform: uppercase;
    }

    .type-component { background: #9b59b6; color: white; }
    .type-style { background: #e74c3c; color: white; }
    .type-function { background: #f39c12; color: white; }
    .type-variable { background: #16a085; color: white; }
    .type-import { background: #34495e; color: white; }

    .asset-details {
      padding: 8px 12px;
      margin: 4px 8px;
      background: #1e1e1e;
      border-radius: 4px;
      font-size: 10px;
      color: #999;
      font-family: 'Consolas', monospace;
      max-height: 80px;
      overflow-y: auto;
    }

    /* ===== CENTER PANEL - TIMELINE + DIALOGUE ===== */
    .panel-center {
      background: #1e1e1e;
      display: flex;
      flex-direction: column;
    }

    .center-tabs {
      background: #252525;
      border-bottom: 1px solid #333;
      display: flex;
      gap: 2px;
      padding: 0 10px;
    }

    .tab-btn {
      padding: 10px 20px;
      background: transparent;
      border: none;
      color: #999;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      border-bottom: 3px solid transparent;
      transition: all 0.2s;
    }

    .tab-btn:hover {
      color: #e0e0e0;
      background: rgba(255,255,255,0.05);
    }

    .tab-btn.active {
      color: #3498db;
      border-bottom-color: #3498db;
    }

    .tab-content {
      flex: 1;
      overflow: hidden;
      display: none;
    }

    .tab-content.active {
      display: flex;
      flex-direction: column;
    }

    /* Timeline */
    .timeline-container {
      flex: 1;
      position: relative;
      overflow: auto;
    }

    .timeline-grid {
      position: absolute;
      inset: 0;
      background: 
        repeating-linear-gradient(90deg, #2a2a2a 0, #2a2a2a 1px, transparent 1px, transparent 50px),
        repeating-linear-gradient(0deg, #2a2a2a 0, #2a2a2a 1px, transparent 1px, transparent 40px);
    }

    .timeline-ruler {
      height: 40px;
      background: #252525;
      border-bottom: 2px solid #444;
      display: flex;
      align-items: center;
      padding: 0 15px;
      position: relative;
    }

    .timeline-marker {
      position: absolute;
      height: 100%;
      display: flex;
      align-items: center;
      color: #888;
      font-size: 11px;
      font-weight: 600;
      padding-left: 6px;
    }

    .timeline-marker::before {
      content: '';
      position: absolute;
      left: 0;
      top: 50%;
      width: 1px;
      height: 12px;
      background: #666;
      transform: translateY(-50%);
    }

    .sequence-track {
      position: relative;
      min-height: 60px;
      border-bottom: 1px solid #333;
      padding: 10px 15px;
    }

    .sequence-node {
      position: absolute;
      background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
      border: 2px solid #5dade2;
      border-radius: 8px;
      padding: 8px 12px;
      cursor: move;
      font-size: 12px;
      font-weight: 600;
      color: white;
      box-shadow: 0 4px 12px rgba(52, 152, 219, 0.4);
      transition: all 0.2s;
      min-width: 80px;
    }

    .sequence-node:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(52, 152, 219, 0.6);
    }

    .sequence-node.selected {
      border-color: #f39c12;
      box-shadow: 0 4px 12px rgba(243, 156, 18, 0.6);
    }

    /* Dialogue System */
    .dialogue-workspace {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
    }

    .dialogue-controls {
      background: #252525;
      padding: 12px;
      border-bottom: 1px solid #333;
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .dialogue-cards-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 15px;
      padding: 10px;
    }

    .dialogue-card {
      background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);
      border: 1px solid #445566;
      border-radius: 8px;
      padding: 15px;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
    }

    .dialogue-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 20px rgba(52, 152, 219, 0.3);
      border-color: #3498db;
    }

    .dialogue-card.selected {
      border-color: #3498db;
      box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.4);
    }

    .dialogue-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .dialogue-speaker {
      font-size: 13px;
      font-weight: 700;
      color: #3498db;
    }

    .dialogue-actions {
      display: flex;
      gap: 4px;
    }

    .icon-btn {
      padding: 4px 8px;
      background: rgba(255,255,255,0.1);
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s;
    }

    .icon-btn:hover {
      background: rgba(255,255,255,0.2);
    }

    .dialogue-text {
      font-size: 12px;
      line-height: 1.6;
      color: #e0e0e0;
      min-height: 60px;
    }

    .dialogue-meta {
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid rgba(255,255,255,0.1);
      font-size: 10px;
      color: #999;
      display: flex;
      justify-content: space-between;
    }

    .display-target {
      padding: 2px 8px;
      background: #27ae60;
      color: white;
      border-radius: 10px;
      font-size: 9px;
      font-weight: 700;
    }

    /* ===== RIGHT PANEL - INSPECTOR ===== */
    .panel-right {
      background: #2c2c2c;
      border-left: 1px solid #444;
      overflow-y: auto;
      padding: 15px;
    }

    .inspector-section {
      background: #353535;
      padding: 12px;
      margin-bottom: 12px;
      border-radius: 6px;
      border: 1px solid #444;
    }

    .inspector-section-title {
      font-size: 13px;
      font-weight: 600;
      color: #3498db;
      margin-bottom: 10px;
      padding-bottom: 6px;
      border-bottom: 1px solid #444;
    }

    .property-group {
      margin-bottom: 12px;
    }

    .property-label {
      font-size: 11px;
      font-weight: 600;
      color: #999;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 6px;
    }

    .property-input {
      width: 100%;
      padding: 8px 10px;
      background: #2a2a2a;
      border: 1px solid #555;
      border-radius: 4px;
      color: #e0e0e0;
      font-size: 13px;
      font-family: 'Consolas', 'Monaco', monospace;
    }

    .property-input:focus {
      outline: none;
      border-color: #3498db;
      background: #333;
    }

    textarea.property-input {
      resize: vertical;
      min-height: 80px;
      font-family: 'Segoe UI', sans-serif;
    }

    /* ===== BOTTOM PANEL - CODE PREVIEW ===== */
    .panel-bottom {
      grid-column: 1 / -1;
      background: #1a1a1a;
      border-top: 2px solid #444;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .code-preview-header {
      background: #252525;
      padding: 8px 15px;
      border-bottom: 1px solid #333;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .code-preview-title {
      font-size: 12px;
      font-weight: 600;
      color: #999;
    }

    .code-preview-content {
      flex: 1;
      overflow: auto;
      padding: 15px;
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 12px;
      line-height: 1.6;
      background: #1a1a1a;
      color: #d4d4d4;
    }

    .code-keyword { color: #569cd6; }
    .code-string { color: #ce9178; }
    .code-number { color: #b5cea8; }
    .code-comment { color: #6a9955; font-style: italic; }
    .code-function { color: #dcdcaa; }

    /* Loading Overlay */
    .loading-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    }

    .loading-content {
      text-align: center;
      color: #3498db;
    }

    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 4px solid #444;
      border-top-color: #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading-text {
      font-size: 16px;
      font-weight: 600;
    }

    .loading-detail {
      font-size: 12px;
      color: #999;
      margin-top: 8px;
    }

    /* Scrollbar Styling */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #1a1a1a;
    }

    ::-webkit-scrollbar-thumb {
      background: #555;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #666;
    }
  </style>
</head>
<body>
  <!-- Main Container -->
  <div class="builder-container">
    
    <!-- Header -->
    <div class="builder-header">
      <div class="builder-title">
        <span>üé¨</span>
        <span>Sequence Builder</span>
        <span class="scene-badge" id="sceneName">Loading...</span>
      </div>
      <div class="builder-controls">
        <button class="btn btn-primary" id="analyzeBtn">üîç Analyze Scene</button>
        <button class="btn btn-success" id="exportBtn">üíæ Export</button>
        <button class="btn btn-secondary" id="importBtn">üìÇ Import</button>
        <button class="btn btn-danger" id="closeBtn">‚úï Close</button>
      </div>
    </div>

    <!-- Left Panel - Asset Manager -->
    <div class="panel-left">
      <div class="asset-manager-header">
        <div class="asset-manager-title">üì¶ Scene Asset Manager</div>
        <div class="asset-stats">
          <div class="stat-item">
            <span class="stat-value" id="totalAssets">0</span>
            <span>Total Assets</span>
          </div>
          <div class="stat-item">
            <span class="stat-value" id="totalGroups">0</span>
            <span>Asset Groups</span>
          </div>
        </div>
      </div>

      <div id="assetGroupsContainer">
        <!-- Asset groups will be populated here -->
      </div>
    </div>

    <!-- Center Panel - Timeline & Dialogue -->
    <div class="panel-center">
      <div class="center-tabs">
        <button class="tab-btn active" data-tab="timeline">‚è±Ô∏è Timeline</button>
        <button class="tab-btn" data-tab="dialogue">üí¨ Dialogue</button>
        <button class="tab-btn" data-tab="hierarchy">üóÇÔ∏è Hierarchy</button>
      </div>

      <!-- Timeline Tab -->
      <div class="tab-content active" id="timeline-tab">
        <div class="timeline-ruler" id="timelineRuler"></div>
        <div class="timeline-container" id="timelineContainer">
          <div class="timeline-grid"></div>
          <div id="timelineTracks"></div>
        </div>
      </div>

      <!-- Dialogue Tab -->
      <div class="tab-content" id="dialogue-tab">
        <div class="dialogue-controls">
          <button class="btn btn-primary" id="addDialogueBtn">‚ûï Add Dialogue</button>
          <button class="btn btn-secondary" id="castToDisplayBtn">üì∫ Cast to Display</button>
          <select class="property-input" id="displaySelect" style="width: auto; padding: 6px 10px;">
            <option value="terminal">Terminal</option>
            <option value="notepad">Notepad</option>
            <option value="subtitle">Subtitle</option>
            <option value="popup">Popup</option>
          </select>
        </div>
        <div class="dialogue-workspace">
          <div class="dialogue-cards-container" id="dialogueCardsContainer">
            <!-- Dialogue cards will be added here -->
          </div>
        </div>
      </div>

      <!-- Hierarchy Tab -->
      <div class="tab-content" id="hierarchy-tab">
        <div style="padding: 20px; color: #999;">
          <h3 style="color: #3498db; margin-bottom: 10px;">Scene Hierarchy</h3>
          <div id="hierarchyTree" style="font-family: monospace; font-size: 12px; line-height: 1.8;">
            <!-- Hierarchy tree will be rendered here -->
          </div>
        </div>
      </div>
    </div>

    <!-- Right Panel - Inspector -->
    <div class="panel-right">
      <div class="inspector-section">
        <div class="inspector-section-title">üîç Inspector</div>
        <div id="inspector">
          <div style="text-align: center; color: #666; padding: 40px 20px; font-size: 13px;">
            Select an asset or dialogue to inspect
          </div>
        </div>
      </div>
    </div>

    <!-- Bottom Panel - Code Preview -->
    <div class="panel-bottom">
      <div class="code-preview-header">
        <div class="code-preview-title">üìÑ Generated Code / Analysis Output</div>
        <button class="btn btn-secondary" id="copyCodeBtn" style="padding: 4px 10px; font-size: 11px;">üìã Copy</button>
      </div>
      <div class="code-preview-content" id="codePreview">
        <span class="code-comment">// Scene analysis and generated code will appear here...</span>
      </div>
    </div>

  </div>

  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-content">
      <div class="loading-spinner"></div>
      <div class="loading-text">Loading Enhanced Sequence Builder</div>
      <div class="loading-detail" id="loadingDetail">Initializing scene analyzer...</div>
    </div>
  </div>

  <script type="module">
    console.log('üé¨ Enhanced Sequence Builder Starting...');

    // ===== SCENE ASSET ANALYZER =====
    class SceneAssetAnalyzer {
      constructor() {
        this.sceneSource = null;
        this.assets = {
          components: [],
          styles: [],
          functions: [],
          variables: [],
          imports: [],
          classes: [],
          dependencies: []
        };
      }

      async analyzeScene(scenePath) {
        console.log(`üîç Analyzing scene: ${scenePath}`);
        
        try {
          // Try to fetch the scene file
          const response = await fetch(scenePath);
          if (!response.ok) {
            console.warn(`Could not fetch ${scenePath}`);
            return this._generateMockAssets(scenePath);
          }
          
          this.sceneSource = await response.text();
          return this._parseSceneSource();
        } catch (error) {
          console.warn('Scene analysis error:', error);
          return this._generateMockAssets(scenePath);
        }
      }

      _parseSceneSource() {
        const assets = {
          components: [],
          styles: [],
          functions: [],
          variables: [],
          imports: [],
          classes: [],
          dependencies: []
        };

        const lines = this.sceneSource.split('\n');

        lines.forEach((line, index) => {
          // Detect imports
          if (line.includes('import ')) {
            const match = line.match(/import\s+(?:{([^}]+)}|(\w+))\s+from\s+['"](.+)['"]/);
            if (match) {
              const imported = match[1] || match[2];
              const from = match[3];
              assets.imports.push({
                name: imported.trim(),
                from: from,
                line: index + 1
              });
              assets.dependencies.push(from);
            }
          }

          // Detect class definitions
          if (line.includes('class ')) {
            const match = line.match(/class\s+(\w+)/);
            if (match) {
              assets.classes.push({
                name: match[1],
                line: index + 1,
                type: line.includes('extends') ? 'extended' : 'base'
              });
            }
          }

          // Detect functions
          if (line.includes('function ') || line.match(/^\s*\w+\s*\(/)) {
            const match = line.match(/(?:async\s+)?(?:function\s+)?(\w+)\s*\(/);
            if (match && !line.includes('//')) {
              assets.functions.push({
                name: match[1],
                line: index + 1,
                async: line.includes('async')
              });
            }
          }

          // Detect variables
          if (line.match(/^\s*(?:const|let|var)\s+(\w+)/)) {
            const match = line.match(/(?:const|let|var)\s+(\w+)/);
            if (match) {
              assets.variables.push({
                name: match[1],
                line: index + 1,
                type: line.includes('const') ? 'const' : line.includes('let') ? 'let' : 'var'
              });
            }
          }

          // Detect CSS references
          if (line.includes('.css') || line.includes('style')) {
            const match = line.match(/['"]([^'"]*\.css)['"]/);
            if (match) {
              assets.styles.push({
                name: match[1],
                line: index + 1
              });
            }
          }

          // Detect components (Three.js objects, etc.)
          if (line.includes('new THREE.') || line.includes('new ')) {
            const match = line.match(/new\s+(THREE\.)?(\w+)/);
            if (match) {
              assets.components.push({
                name: match[2],
                line: index + 1,
                namespace: match[1] || 'custom'
              });
            }
          }
        });

        // Remove duplicates
        Object.keys(assets).forEach(key => {
          if (Array.isArray(assets[key])) {
            assets[key] = this._uniqueBy(assets[key], 'name');
          }
        });

        this.assets = assets;
        return assets;
      }

      _uniqueBy(array, key) {
        const seen = new Set();
        return array.filter(item => {
          const k = item[key];
          return seen.has(k) ? false : seen.add(k);
        });
      }

      _generateMockAssets(scenePath) {
        // Generate sample assets based on scene name
        const sceneName = scenePath.split('/').pop().replace('.js', '');
        
        return {
          components: [
            { name: 'Scene', line: 1, namespace: 'THREE' },
            { name: 'PerspectiveCamera', line: 5, namespace: 'THREE' },
            { name: 'WebGLRenderer', line: 10, namespace: 'THREE' },
            { name: 'Mesh', line: 15, namespace: 'THREE' },
            { name: 'BoxGeometry', line: 20, namespace: 'THREE' }
          ],
          styles: [
            { name: 'main.css', line: 1 },
            { name: 'animations.css', line: 2 },
            { name: 'hud.css', line: 3 }
          ],
          functions: [
            { name: 'init', line: 30, async: true },
            { name: 'animate', line: 50, async: false },
            { name: 'update', line: 70, async: false },
            { name: 'handleInput', line: 90, async: false }
          ],
          variables: [
            { name: 'scene', line: 12, type: 'const' },
            { name: 'camera', line: 13, type: 'const' },
            { name: 'renderer', line: 14, type: 'const' },
            { name: 'state', line: 25, type: 'let' }
          ],
          imports: [
            { name: 'THREE', from: 'three', line: 1 },
            { name: 'Store', from: './engine/Store.js', line: 2 },
            { name: 'Actions', from: './engine/Actions.js', line: 3 }
          ],
          classes: [
            { name: sceneName, line: 40, type: 'extended' }
          ],
          dependencies: [
            'three',
            './engine/Store.js',
            './engine/Actions.js',
            './core/SceneManager.js'
          ]
        };
      }

      generateHierarchy() {
        const hierarchy = {
          scene: this.assets.classes[0]?.name || 'Scene',
          children: [
            {
              name: 'Imports',
              count: this.assets.imports.length,
              items: this.assets.imports.map(i => `${i.name} from ${i.from}`)
            },
            {
              name: 'Components',
              count: this.assets.components.length,
              items: this.assets.components.map(c => `${c.namespace}${c.name}`)
            },
            {
              name: 'Functions',
              count: this.assets.functions.length,
              items: this.assets.functions.map(f => `${f.async ? 'async ' : ''}${f.name}()`)
            },
            {
              name: 'Variables',
              count: this.assets.variables.length,
              items: this.assets.variables.map(v => `${v.type} ${v.name}`)
            },
            {
              name: 'Styles',
              count: this.assets.styles.length,
              items: this.assets.styles.map(s => s.name)
            }
          ]
        };
        return hierarchy;
      }
    }

    // ===== DIALOGUE MANAGER =====
    class DialogueManager {
      constructor() {
        this.dialogues = [];
        this.selectedDialogue = null;
      }

      createDialogue(data = {}) {
        const dialogue = {
          id: Date.now(),
          speaker: data.speaker || 'Unknown',
          text: data.text || '',
          display: data.display || 'subtitle',
          timestamp: data.timestamp || 0,
          duration: data.duration || 3.0,
          ...data
        };
        this.dialogues.push(dialogue);
        return dialogue;
      }

      updateDialogue(id, updates) {
        const dialogue = this.dialogues.find(d => d.id === id);
        if (dialogue) {
          Object.assign(dialogue, updates);
        }
        return dialogue;
      }

      deleteDialogue(id) {
        const index = this.dialogues.findIndex(d => d.id === id);
        if (index > -1) {
          this.dialogues.splice(index, 1);
        }
      }

      exportDialogues() {
        return {
          dialogues: this.dialogues,
          count: this.dialogues.length
        };
      }

      importDialogues(data) {
        if (data.dialogues) {
          this.dialogues = data.dialogues;
        }
      }
    }

    // ===== MAIN APPLICATION =====
    class EnhancedSequenceBuilder {
      constructor() {
        this.analyzer = new SceneAssetAnalyzer();
        this.dialogueManager = new DialogueManager();
        this.state = {
          currentScene: null,
          assets: null,
          selectedAsset: null,
          currentTab: 'timeline'
        };
        
        this.ui = {
          sceneName: document.getElementById('sceneName'),
          assetGroupsContainer: document.getElementById('assetGroupsContainer'),
          totalAssets: document.getElementById('totalAssets'),
          totalGroups: document.getElementById('totalGroups'),
          inspector: document.getElementById('inspector'),
          codePreview: document.getElementById('codePreview'),
          dialogueCardsContainer: document.getElementById('dialogueCardsContainer'),
          hierarchyTree: document.getElementById('hierarchyTree'),
          loadingOverlay: document.getElementById('loadingOverlay'),
          loadingDetail: document.getElementById('loadingDetail')
        };
      }

      async init() {
        console.log('üé¨ Initializing Enhanced Sequence Builder...');
        
        this.ui.loadingDetail.textContent = 'Detecting current scene...';
        
        const sceneName = this._detectCurrentScene();
        this.state.currentScene = sceneName;
        this.ui.sceneName.textContent = sceneName;
        
        this.ui.loadingDetail.textContent = 'Analyzing scene assets...';
        const scenePath = `./src/scripts/scenes/${sceneName}.js`;
        this.state.assets = await this.analyzer.analyzeScene(scenePath);
        
        this._renderAssetGroups();
        this._setupEventListeners();
        this._renderInitialDialogues();
        this._updateCodePreview();
        
        setTimeout(() => {
          this.ui.loadingOverlay.style.display = 'none';
          console.log('‚úÖ Enhanced Sequence Builder Ready');
        }, 500);
      }

      _detectCurrentScene() {
        if (window.opener && window.opener.introScene) {
          return 'IntroSceneComplete';
        }
        if (window.opener && window.opener.currentScene) {
          return window.opener.currentScene.constructor.name;
        }
        return 'IntroSceneComplete';
      }

      _renderAssetGroups() {
        const assets = this.state.assets;
        const groups = [
          { key: 'components', icon: 'üß©', title: 'Components', color: '#9b59b6' },
          { key: 'functions', icon: '‚ö°', title: 'Functions', color: '#f39c12' },
          { key: 'variables', icon: 'üìä', title: 'Variables', color: '#16a085' },
          { key: 'styles', icon: 'üé®', title: 'Styles', color: '#e74c3c' },
          { key: 'imports', icon: 'üì¶', title: 'Imports', color: '#34495e' },
          { key: 'classes', icon: 'üèõÔ∏è', title: 'Classes', color: '#2c3e50' }
        ];

        let totalAssets = 0;
        this.ui.assetGroupsContainer.innerHTML = '';

        groups.forEach(group => {
          const items = assets[group.key] || [];
          totalAssets += items.length;

          const groupEl = document.createElement('div');
          groupEl.className = 'asset-group';
          
          groupEl.innerHTML = `
            <div class="asset-group-header">
              <div class="asset-group-title">
                <span>${group.icon}</span>
                <span>${group.title}</span>
                <span class="asset-count">${items.length}</span>
              </div>
              <span class="expand-icon">‚ñ∂</span>
            </div>
            <div class="asset-group-content">
              ${items.map((item, idx) => `
                <div class="asset-item" data-group="${group.key}" data-index="${idx}">
                  <span class="asset-name">${item.name}</span>
                  <span class="asset-type type-${group.key.slice(0, -1)}">${group.key.slice(0, 3).toUpperCase()}</span>
                </div>
                ${item.from || item.line ? `
                  <div class="asset-details">
                    ${item.from ? `from: ${item.from}` : `line: ${item.line}`}
                    ${item.async ? ' | async' : ''}
                    ${item.type ? ` | ${item.type}` : ''}
                  </div>
                ` : ''}
              `).join('')}
            </div>
          `;

          this.ui.assetGroupsContainer.appendChild(groupEl);

          // Add expand/collapse functionality
          const header = groupEl.querySelector('.asset-group-header');
          const content = groupEl.querySelector('.asset-group-content');
          
          header.addEventListener('click', () => {
            const isExpanded = content.classList.contains('expanded');
            if (isExpanded) {
              content.classList.remove('expanded');
              header.classList.remove('active');
            } else {
              content.classList.add('expanded');
              header.classList.add('active');
            }
          });

          // Add asset selection
          groupEl.querySelectorAll('.asset-item').forEach(item => {
            item.addEventListener('click', (e) => {
              e.stopPropagation();
              this._selectAsset(group.key, parseInt(item.dataset.index));
            });
          });
        });

        this.ui.totalAssets.textContent = totalAssets;
        this.ui.totalGroups.textContent = groups.length;
      }

      _selectAsset(groupKey, index) {
        // Deselect all
        document.querySelectorAll('.asset-item').forEach(el => el.classList.remove('selected'));
        
        // Select this one
        const asset = this.state.assets[groupKey][index];
        this.state.selectedAsset = { ...asset, group: groupKey };
        
        const assetEl = document.querySelector(`.asset-item[data-group="${groupKey}"][data-index="${index}"]`);
        if (assetEl) assetEl.classList.add('selected');
        
        this._updateInspector();
      }

      _updateInspector() {
        if (!this.state.selectedAsset) {
          this.ui.inspector.innerHTML = `
            <div style="text-align: center; color: #666; padding: 40px 20px; font-size: 13px;">
              Select an asset or dialogue to inspect
            </div>
          `;
          return;
        }

        const asset = this.state.selectedAsset;
        
        this.ui.inspector.innerHTML = `
          <div class="inspector-section">
            <div class="inspector-section-title">${asset.name}</div>
            
            <div class="property-group">
              <div class="property-label">Type</div>
              <input type="text" class="property-input" value="${asset.group}" readonly>
            </div>
            
            ${asset.line ? `
              <div class="property-group">
                <div class="property-label">Line Number</div>
                <input type="number" class="property-input" value="${asset.line}" readonly>
              </div>
            ` : ''}
            
            ${asset.from ? `
              <div class="property-group">
                <div class="property-label">Import From</div>
                <input type="text" class="property-input" value="${asset.from}" readonly>
              </div>
            ` : ''}
            
            ${asset.namespace ? `
              <div class="property-group">
                <div class="property-label">Namespace</div>
                <input type="text" class="property-input" value="${asset.namespace}" readonly>
              </div>
            ` : ''}
            
            ${asset.async !== undefined ? `
              <div class="property-group">
                <div class="property-label">Async</div>
                <input type="text" class="property-input" value="${asset.async ? 'Yes' : 'No'}" readonly>
              </div>
            ` : ''}
          </div>
        `;
      }

      _renderInitialDialogues() {
        // Create some sample dialogues
        this.dialogueManager.createDialogue({
          speaker: 'System',
          text: 'Welcome to the sequence builder. Use this interface to create dynamic dialogue sequences.',
          display: 'terminal',
          timestamp: 0
        });

        this.dialogueManager.createDialogue({
          speaker: 'Celli',
          text: 'Select assets from the left panel to inspect their properties and relationships.',
          display: 'subtitle',
          timestamp: 3.0
        });

        this._renderDialogueCards();
      }

      _renderDialogueCards() {
        this.ui.dialogueCardsContainer.innerHTML = this.dialogueManager.dialogues.map(dialogue => `
          <div class="dialogue-card" data-id="${dialogue.id}">
            <div class="dialogue-header">
              <div class="dialogue-speaker">${dialogue.speaker}</div>
              <div class="dialogue-actions">
                <button class="icon-btn" onclick="window.builderApp._editDialogue(${dialogue.id})">‚úèÔ∏è</button>
                <button class="icon-btn" onclick="window.builderApp._deleteDialogue(${dialogue.id})">üóëÔ∏è</button>
              </div>
            </div>
            <div class="dialogue-text">${dialogue.text}</div>
            <div class="dialogue-meta">
              <span>@${dialogue.timestamp.toFixed(1)}s</span>
              <span class="display-target">${dialogue.display}</span>
            </div>
          </div>
        `).join('');

        // Add click handlers
        document.querySelectorAll('.dialogue-card').forEach(card => {
          card.addEventListener('click', (e) => {
            if (!e.target.closest('.icon-btn')) {
              this._selectDialogue(parseInt(card.dataset.id));
            }
          });
        });
      }

      _selectDialogue(id) {
        document.querySelectorAll('.dialogue-card').forEach(el => el.classList.remove('selected'));
        const card = document.querySelector(`.dialogue-card[data-id="${id}"]`);
        if (card) card.classList.add('selected');
        
        const dialogue = this.dialogueManager.dialogues.find(d => d.id === id);
        if (dialogue) {
          this._showDialogueInspector(dialogue);
        }
      }

      _showDialogueInspector(dialogue) {
        this.ui.inspector.innerHTML = `
          <div class="inspector-section">
            <div class="inspector-section-title">üí¨ Dialogue Properties</div>
            
            <div class="property-group">
              <div class="property-label">Speaker</div>
              <input type="text" class="property-input" id="dialogueSpeaker" value="${dialogue.speaker}">
            </div>
            
            <div class="property-group">
              <div class="property-label">Text</div>
              <textarea class="property-input" id="dialogueText">${dialogue.text}</textarea>
            </div>
            
            <div class="property-group">
              <div class="property-label">Display Target</div>
              <select class="property-input" id="dialogueDisplay">
                <option value="terminal" ${dialogue.display === 'terminal' ? 'selected' : ''}>Terminal</option>
                <option value="notepad" ${dialogue.display === 'notepad' ? 'selected' : ''}>Notepad</option>
                <option value="subtitle" ${dialogue.display === 'subtitle' ? 'selected' : ''}>Subtitle</option>
                <option value="popup" ${dialogue.display === 'popup' ? 'selected' : ''}>Popup</option>
              </select>
            </div>
            
            <div class="property-group">
              <div class="property-label">Timestamp (seconds)</div>
              <input type="number" class="property-input" id="dialogueTimestamp" value="${dialogue.timestamp}" step="0.1" min="0">
            </div>
            
            <div class="property-group">
              <div class="property-label">Duration (seconds)</div>
              <input type="number" class="property-input" id="dialogueDuration" value="${dialogue.duration}" step="0.1" min="0.1">
            </div>
            
            <button class="btn btn-primary" onclick="window.builderApp._saveDialogueChanges(${dialogue.id})" style="width: 100%; margin-top: 10px;">
              üíæ Save Changes
            </button>
          </div>
        `;
      }

      _saveDialogueChanges(id) {
        const updates = {
          speaker: document.getElementById('dialogueSpeaker').value,
          text: document.getElementById('dialogueText').value,
          display: document.getElementById('dialogueDisplay').value,
          timestamp: parseFloat(document.getElementById('dialogueTimestamp').value),
          duration: parseFloat(document.getElementById('dialogueDuration').value)
        };
        
        this.dialogueManager.updateDialogue(id, updates);
        this._renderDialogueCards();
        this._updateCodePreview();
        
        console.log('‚úÖ Dialogue updated:', id);
      }

      _editDialogue(id) {
        this._selectDialogue(id);
      }

      _deleteDialogue(id) {
        if (confirm('Delete this dialogue?')) {
          this.dialogueManager.deleteDialogue(id);
          this._renderDialogueCards();
          this._updateCodePreview();
          console.log('üóëÔ∏è Dialogue deleted:', id);
        }
      }

      _updateCodePreview() {
        const assets = this.state.assets;
        const dialogues = this.dialogueManager.exportDialogues();
        
        let code = `<span class="code-comment">// Scene Asset Analysis</span>\n`;
        code += `<span class="code-keyword">const</span> sceneAssets = {\n`;
        code += `  <span class="code-string">scene</span>: <span class="code-string">"${this.state.currentScene}"</span>,\n`;
        code += `  <span class="code-string">totalAssets</span>: <span class="code-number">${Object.values(assets).reduce((sum, arr) => sum + arr.length, 0)}</span>,\n\n`;
        
        code += `  <span class="code-comment">// Components (${assets.components.length})</span>\n`;
        code += `  <span class="code-string">components</span>: [\n`;
        assets.components.slice(0, 5).forEach((c, i) => {
          code += `    { <span class="code-string">name</span>: <span class="code-string">"${c.name}"</span>, <span class="code-string">namespace</span>: <span class="code-string">"${c.namespace}"</span> }${i < 4 && assets.components.length > 1 ? ',' : ''}\n`;
        });
        if (assets.components.length > 5) code += `    <span class="code-comment">// ... ${assets.components.length - 5} more</span>\n`;
        code += `  ],\n\n`;
        
        code += `  <span class="code-comment">// Functions (${assets.functions.length})</span>\n`;
        code += `  <span class="code-string">functions</span>: [${assets.functions.slice(0, 5).map(f => `<span class="code-string">"${f.name}"</span>`).join(', ')}${assets.functions.length > 5 ? ', ...' : ''}],\n\n`;
        
        code += `  <span class="code-comment">// Dialogues (${dialogues.count})</span>\n`;
        code += `  <span class="code-string">dialogues</span>: [\n`;
        dialogues.dialogues.forEach((d, i) => {
          code += `    {\n`;
          code += `      <span class="code-string">speaker</span>: <span class="code-string">"${d.speaker}"</span>,\n`;
          code += `      <span class="code-string">text</span>: <span class="code-string">"${d.text.substring(0, 50)}${d.text.length > 50 ? '...' : ''}"</span>,\n`;
          code += `      <span class="code-string">display</span>: <span class="code-string">"${d.display}"</span>,\n`;
          code += `      <span class="code-string">timestamp</span>: <span class="code-number">${d.timestamp}</span>\n`;
          code += `    }${i < dialogues.count - 1 ? ',' : ''}\n`;
        });
        code += `  ]\n`;
        code += `};\n\n`;
        code += `<span class="code-keyword">export</span> <span class="code-keyword">default</span> sceneAssets;`;
        
        this.ui.codePreview.innerHTML = code;
      }

      _renderHierarchyTree() {
        const hierarchy = this.analyzer.generateHierarchy();
        
        let html = `<div style="color: #3498db; font-weight: bold; margin-bottom: 15px;">üìÅ ${hierarchy.scene}</div>`;
        
        hierarchy.children.forEach(child => {
          html += `<div style="margin-left: 20px; margin-bottom: 10px;">`;
          html += `<div style="color: #f39c12; font-weight: bold;">‚îú‚îÄ ${child.name} (${child.count})</div>`;
          
          if (child.items.length > 0) {
            child.items.slice(0, 8).forEach((item, i) => {
              const isLast = i === Math.min(child.items.length - 1, 7);
              html += `<div style="margin-left: 20px; color: #bbb;">${isLast ? '‚îî‚îÄ' : '‚îú‚îÄ'} ${item}</div>`;
            });
            if (child.items.length > 8) {
              html += `<div style="margin-left: 20px; color: #666;">‚îî‚îÄ ... ${child.items.length - 8} more</div>`;
            }
          }
          html += `</div>`;
        });
        
        this.ui.hierarchyTree.innerHTML = html;
      }

      _setupEventListeners() {
        // Tab switching
        document.querySelectorAll('.tab-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const tab = btn.dataset.tab;
            
            // Update tabs
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            btn.classList.add('active');
            document.getElementById(`${tab}-tab`).classList.add('active');
            
            this.state.currentTab = tab;
            
            // Render hierarchy when switched to
            if (tab === 'hierarchy') {
              this._renderHierarchyTree();
            }
          });
        });

        // Analyze button
        document.getElementById('analyzeBtn').addEventListener('click', async () => {
          this.ui.loadingOverlay.style.display = 'flex';
          this.ui.loadingDetail.textContent = 'Re-analyzing scene...';
          
          const scenePath = `./src/scripts/scenes/${this.state.currentScene}.js`;
          this.state.assets = await this.analyzer.analyzeScene(scenePath);
          this._renderAssetGroups();
          this._updateCodePreview();
          
          setTimeout(() => {
            this.ui.loadingOverlay.style.display = 'none';
          }, 500);
        });

        // Add dialogue button
        document.getElementById('addDialogueBtn').addEventListener('click', () => {
          const dialogue = this.dialogueManager.createDialogue({
            speaker: 'New Speaker',
            text: 'Enter dialogue text here...',
            display: 'subtitle',
            timestamp: 0
          });
          this._renderDialogueCards();
          this._selectDialogue(dialogue.id);
        });

        // Cast to display button
        document.getElementById('castToDisplayBtn').addEventListener('click', () => {
          const selected = document.querySelector('.dialogue-card.selected');
          if (!selected) {
            alert('Please select a dialogue first');
            return;
          }
          
          const display = document.getElementById('displaySelect').value;
          const id = parseInt(selected.dataset.id);
          this.dialogueManager.updateDialogue(id, { display });
          this._renderDialogueCards();
          
          console.log(`‚úÖ Dialogue cast to ${display}`);
        });

        // Export button
        document.getElementById('exportBtn').addEventListener('click', () => {
          const data = {
            scene: this.state.currentScene,
            assets: this.state.assets,
            dialogues: this.dialogueManager.exportDialogues(),
            timestamp: Date.now()
          };
          
          const json = JSON.stringify(data, null, 2);
          const blob = new Blob([json], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `scene_${this.state.currentScene}_${Date.now()}.json`;
          a.click();
          URL.revokeObjectURL(url);
          
          navigator.clipboard.writeText(json);
          alert('‚úÖ Exported and copied to clipboard!');
        });

        // Import button
        document.getElementById('importBtn').addEventListener('click', () => {
          const input = document.createElement('input');
          input.type = 'file';
          input.accept = '.json';
          
          input.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            const text = await file.text();
            const data = JSON.parse(text);
            
            if (data.dialogues) {
              this.dialogueManager.importDialogues(data.dialogues);
              this._renderDialogueCards();
            }
            
            if (data.assets) {
              this.state.assets = data.assets;
              this._renderAssetGroups();
            }
            
            this._updateCodePreview();
            alert('‚úÖ Imported successfully!');
          });
          
          input.click();
        });

        // Copy code button
        document.getElementById('copyCodeBtn').addEventListener('click', () => {
          const code = this.ui.codePreview.innerText;
          navigator.clipboard.writeText(code);
          alert('‚úÖ Copied to clipboard!');
        });

        // Close button
        document.getElementById('closeBtn').addEventListener('click', () => {
          if (confirm('Close Sequence Builder?')) {
            window.close();
          }
        });
      }
    }

    // Initialize app
    const app = new EnhancedSequenceBuilder();
    app.init();
    
    // Make globally accessible
    window.builderApp = app;
    
    console.log('‚úÖ Enhanced Sequence Builder Ready');
    console.log('üí° Features: Asset Analysis | Dialogue Cards | Hierarchy View | Export/Import');
  </script>
</body>
</html>

