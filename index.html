<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Cell.real - Full Voxel Editor v2</title>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
      background: #000;
      color: #fff;
      overflow: hidden;
    }
    
    #app {
      position: fixed;
      inset: 0;
      background: #000;
    }
    
    /* Loading */
    #loading {
      position: fixed;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: #0a0a1a;
      z-index: 9999;
      transition: opacity 0.5s;
    }
    
    #loading.hidden {
      opacity: 0;
      pointer-events: none;
    }
    
    #loading h1 {
      font-size: 48px;
      font-weight: 700;
      letter-spacing: 0.1em;
      margin-bottom: 20px;
      background: linear-gradient(45deg, #4a7cff, #ff4a7c);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    
    .spinner {
      width: 50px;
      height: 50px;
      border: 4px solid #222;
      border-top-color: #4a7cff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* HUD */
    .hud {
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 10px;
      pointer-events: none;
    }
    
    .hud-item {
      background: rgba(0, 0, 0, 0.7);
      padding: 10px 15px;
      border-radius: 8px;
      font-size: 14px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
    }
    
    .hud-item strong {
      color: #4a7cff;
      margin-right: 8px;
    }
    
    /* Instructions */
    #instructions {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.8);
      padding: 15px 25px;
      border-radius: 12px;
      font-size: 13px;
      color: #ccc;
      border: 1px solid rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      z-index: 1000;
      max-width: 90%;
      text-align: center;
    }
    
    #instructions kbd {
      background: #222;
      padding: 3px 8px;
      border-radius: 4px;
      border: 1px solid #444;
      font-family: monospace;
      font-size: 12px;
      color: #4a7cff;
      margin: 0 2px;
    }
    
    #instructions.hidden {
      display: none;
    }
    
    /* Version badge */
    .version {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.7);
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 12px;
      color: #888;
      border: 1px solid rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      z-index: 1000;
    }
  </style>
</head>
<body>
  <!-- Loading -->
  <div id="loading">
    <h1>CELL.REAL v2</h1>
    <div class="spinner"></div>
    <p style="color: #888; margin-top: 10px;">Loading full editor with scene integration...</p>
  </div>
  
  <!-- App -->
  <div id="app"></div>
  
  <!-- HUD -->
  <div class="hud">
    <div class="hud-item">
      <strong>Mode:</strong> <span id="hud-mode">2D Spreadsheet</span>
    </div>
    <div class="hud-item">
      <strong>Execution:</strong> <span id="hud-execution">Disabled</span>
    </div>
    <div class="hud-item">
      <strong>Scene:</strong> <span id="hud-scene">FullEditor</span>
    </div>
  </div>
  
  <!-- Version -->
  <div class="version">
    v2.0 - Scene Integration
  </div>
  
  <!-- Instructions -->
  <div id="instructions">
    <kbd>Ctrl+E</kbd> Execution Mode ‚Ä¢
    <kbd>Ctrl+V</kbd> Toggle View ‚Ä¢
    <kbd>Arrow Keys</kbd> Navigate ‚Ä¢
    <kbd>Enter</kbd> Edit ‚Ä¢
    <kbd>F1</kbd> Hide
  </div>
  
  <!-- Import map -->
  <script type="importmap">
  {
    "imports": {
      "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
      "three/examples/jsm/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
    }
  }
  </script>
  
  <!-- Main application -->
  <script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/examples/jsm/controls/OrbitControls.js';
    import { FullEditorScene } from './src/scripts/scenes/FullEditorScene.js';
    
    // App state
    const app = {
      renderer: null,
      scene: null,
      camera: null,
      controls: null,
      editorScene: null,
      clock: new THREE.Clock(),
      running: false
    };
    
    // Initialize
    async function init() {
      try {
        console.log('üöÄ Cell.real v2 - Initializing with scene integration...');
        
        // Create renderer
        const appEl = document.getElementById('app');
        app.renderer = new THREE.WebGLRenderer({
          antialias: true,
          alpha: false
        });
        app.renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        app.renderer.setSize(window.innerWidth, window.innerHeight);
        app.renderer.outputColorSpace = THREE.SRGBColorSpace;
        app.renderer.setClearColor(0x000000, 1);
        appEl.appendChild(app.renderer.domElement);
        
        // Create camera
        app.camera = new THREE.PerspectiveCamera(
          75,
          window.innerWidth / window.innerHeight,
          0.1,
          1000
        );
        app.camera.position.set(10, 10, 10);
        
        // Create controls
        app.controls = new OrbitControls(app.camera, app.renderer.domElement);
        app.controls.enableDamping = true;
        app.controls.dampingFactor = 0.05;
        
        // Create editor scene
        app.editorScene = new FullEditorScene();
        app.editorScene.state.camera = app.camera; // Share camera
        await app.editorScene.init();
        app.scene = app.editorScene.getScene();
        
        // Set callbacks
        app.editorScene.setCallbacks({
          onFormulaExecute: (data, result) => {
            console.log('‚úÖ Formula executed:', data, result);
          },
          onCellChange: (data) => {
            console.log('üìù Cell changed:', data);
          }
        });
        
        // Start scene
        await app.editorScene.start();
        
        // Setup event handlers
        setupEvents();
        
        // Start animation loop
        app.running = true;
        animate();
        
        // Hide loading
        hideLoading();
        
        // Update HUD
        updateHUD();
        
        console.log('‚úÖ Cell.real v2 initialized successfully!');
        
        // Expose to window
        window.cellRealApp = app;
        window.editorScene = app.editorScene;
        
      } catch (error) {
        console.error('‚ùå Initialization failed:', error);
        document.getElementById('loading').innerHTML = 
          `<h2 style="color: #ff4444;">Error</h2><p>${error.message}</p>`;
      }
    }
    
    // Animation loop
    function animate() {
      if (!app.running) return;
      requestAnimationFrame(animate);
      
      const delta = app.clock.getDelta();
      const total = app.clock.getElapsedTime();
      
      // Update controls
      app.controls.update();
      
      // Update scene
      app.editorScene?.update(delta, total);
      
      // Render
      if (app.renderer && app.scene && app.camera) {
        app.renderer.render(app.scene, app.camera);
      }
    }
    
    // Setup events
    function setupEvents() {
      // Keyboard shortcuts
      document.addEventListener('keydown', (e) => {
        // Ctrl+E - Toggle execution mode
        if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
          e.preventDefault();
          app.editorScene?.toggleExecutionMode();
          updateHUD();
        }
        
        // Ctrl+V - Toggle view mode
        if ((e.ctrlKey || e.metaKey) && e.key === 'v') {
          e.preventDefault();
          app.editorScene?.toggleViewMode();
          updateHUD();
        }
        
        // F1 - Toggle instructions
        if (e.key === 'F1') {
          e.preventDefault();
          document.getElementById('instructions').classList.toggle('hidden');
        }
      });
      
      // Resize
      window.addEventListener('resize', () => {
        if (!app.camera || !app.renderer) return;
        app.camera.aspect = window.innerWidth / window.innerHeight;
        app.camera.updateProjectionMatrix();
        app.renderer.setSize(window.innerWidth, window.innerHeight);
      });
    }
    
    // Update HUD
    function updateHUD() {
      const mode = app.editorScene?.state.mode || '2d';
      const execution = app.editorScene?.state.executionMode || false;
      
      document.getElementById('hud-mode').textContent = 
        mode === '2d' ? '2D Spreadsheet' : '3D Voxel View';
      document.getElementById('hud-execution').textContent = 
        execution ? 'Enabled (Hand & Keyboard)' : 'Disabled';
    }
    
    // Hide loading
    function hideLoading() {
      const loading = document.getElementById('loading');
      loading.classList.add('hidden');
      setTimeout(() => loading.style.display = 'none', 500);
    }
    
    // Start
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  </script>
</body>
</html>

