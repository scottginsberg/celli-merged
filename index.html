<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LOOMWORKS: Domestic Product</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Tone.js for Audio -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;700&family=Space+Mono:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">

    <!-- CSS Styles -->
    <style>
        :root {
            --bg-color: #FDFBF7;
            --text-color: #111;
            --accent-red: #CD2B2B;
            --grid-color: rgba(0, 0, 0, 0.05);
        }
        
        body {
            font-family: 'Space Grotesk', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
        }

        .blueprint {
            background: linear-gradient(0deg, rgba(205,43,43,0.08) 1px, transparent 1px),
                        linear-gradient(90deg, rgba(205,43,43,0.08) 1px, transparent 1px),
                        #FDFBF7;
            background-size: 26px 26px, 26px 26px, auto;
            color: #161616;
        }

        .modal-layer {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(6px);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 16px;
            z-index: 60;
        }

        .modal-layer.active { display: flex; }

        body.modal-open { overflow: hidden; }

        .font-mono { font-family: 'Space Mono', monospace; }
        .bg-grid { background-image: linear-gradient(var(--grid-color) 1px, transparent 1px), linear-gradient(90deg, var(--grid-color) 1px, transparent 1px); background-size: 20px 20px; }

        /* Glitch States */
        body.glitch-mode { background-color: #EBEAE4; color: #000; }
        .glitch-text { position: relative; }
        body.glitch-mode .glitch-text::before {
            content: attr(data-text); position: absolute; left: 2px; text-shadow: -1px 0 red;
            background: transparent; overflow: hidden; clip: rect(0, 900px, 0, 0);
            animation: glitch-anim 2s infinite linear alternate-reverse;
        }

        @keyframes glitch-anim {
            0% { clip: rect(42px, 9999px, 44px, 0); }
            5% { clip: rect(12px, 9999px, 59px, 0); }
            10% { clip: rect(48px, 9999px, 29px, 0); }
            15% { clip: rect(42px, 9999px, 73px, 0); }
            20% { clip: rect(63px, 9999px, 27px, 0); }
            100% { clip: rect(4px, 9999px, 91px, 0); }
        }

        /* 3D Canvas Container */
        #canvas-container {
            width: 100%; height: 100vh; display: block; position: absolute; top: 0; left: 0; z-index: 0;
        }

        .view-section { display: none; min-height: 100vh; padding-top: 60px; }
        .view-section.active { display: block; }

        /* Atmospheric Overlays */
        .film-grain {
            pointer-events: none;
            position: absolute;
            inset: 0;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='160' height='160' viewBox='0 0 160 160'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.18'/%3E%3C/svg%3E");
            mix-blend-mode: soft-light;
            animation: grainShift 1.6s steps(2) infinite;
        }

        @keyframes grainShift {
            0% { transform: translate3d(0,0,0); }
            25% { transform: translate3d(-10px, 8px, 0); }
            50% { transform: translate3d(6px, -12px, 0); }
            75% { transform: translate3d(12px, 4px, 0); }
            100% { transform: translate3d(0,0,0); }
        }

        /* Pixel crowd */
        .attendee {
            position: absolute;
            width: 14px; height: 22px;
            background: #0f0f0f;
            border: 2px solid #222;
            border-radius: 3px 3px 2px 2px;
            animation: idleBob 2.2s ease-in-out infinite;
        }
        .attendee::after {
            content: '';
            position: absolute;
            width: 10px; height: 10px;
            background: #fefefe;
            border-radius: 2px;
            top: -8px; left: 1px;
        }
        .attendee.observe {
            animation: observe 3.4s ease-in-out infinite;
        }
        @keyframes idleBob {
            0%,100% { transform: translateY(0); }
            50% { transform: translateY(-3px); }
        }
        @keyframes observe {
            0%,100% { transform: translateY(0) scale(1); }
            40% { transform: translateY(-2px) scale(1.05); }
            70% { transform: translateY(1px) scale(0.98); }
        }

        /* Profiler Cards */
        .role-card { transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); }
        .role-card:hover { transform: translateY(-4px); border-color: #000; box-shadow: 4px 4px 0px #000; }
        .role-card.selected { background: #000; color: #fff; transform: scale(1.02); }
        .role-card.selected .role-desc { color: #ccc; }

        /* Sculpture Generator */
        .sculpture-preview {
            min-height: 200px;
            border: 1px dashed #111;
            background: linear-gradient(120deg, rgba(205,43,43,0.08), rgba(17,17,17,0.06));
            box-shadow: inset 0 0 0 1px rgba(0,0,0,0.05);
        }

        .sculpture-preview .grid {
            align-items: flex-start;
        }

        .sculpture-canvas-shell {
            background: #fdfbf7;
            border: 1px solid #111;
            box-shadow: 6px 6px 0 #00000014;
            min-height: 240px;
        }

        .sculpture-canvas-shell canvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        .sculpture-readout {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            box-shadow: inset 0 0 0 1px rgba(0,0,0,0.04);
        }

        .sculpture-share-button {
            border: 1px solid #111;
            padding: 0.5rem 0.75rem;
            background: #fff;
            font-size: 10px;
            letter-spacing: 0.28em;
            text-transform: uppercase;
            transition: all 0.2s ease;
        }

        .sculpture-share-button:hover:not(:disabled) {
            background: #000;
            color: #fff;
        }

        .sculpture-share-button:disabled {
            cursor: not-allowed;
            opacity: 0.4;
        }

        /* Ambient Interactions */
        .legal-copy {
            position: relative;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            border: 1px dashed rgba(0,0,0,0.35);
            border-radius: 8px;
            --x: 50%;
            --y: 50%;
            transition: border-color 0.2s ease, color 0.2s ease;
        }
        .legal-copy::after {
            content: '';
            position: absolute;
            inset: -8px;
            background: radial-gradient(circle at var(--x) var(--y), rgba(205,43,43,0.18), rgba(205,43,43,0));
            opacity: 0;
            transition: opacity 0.25s ease;
            pointer-events: none;
            filter: blur(6px);
        }
        .legal-copy:hover { border-color: #CD2B2B; color: #8c1e1e; }
        .legal-copy:hover::after { opacity: 1; }

        .ambient-tooltip {
            position: fixed;
            pointer-events: none;
            z-index: 70;
            background: #0f0f0f;
            color: #f6f2ea;
            padding: 8px 12px;
            border-radius: 999px;
            font-size: 10px;
            letter-spacing: 0.18em;
            text-transform: uppercase;
            opacity: 0;
            transform: translate(-50%, -50%) scale(0.96);
            animation: tooltipFade 2.2s ease forwards;
            box-shadow: 0 6px 20px rgba(0,0,0,0.16);
            mix-blend-mode: difference;
        }

        #ambient-layer {
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 60;
        }

        @keyframes tooltipFade {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.9); }
            15% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            80% { opacity: 1; }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(1.06); }
        }

        .micro-glitch { animation: microGlitch 0.6s steps(2, end); }
        @keyframes microGlitch {
            0% { transform: translate(0,0); text-shadow: 1px 0 rgba(205,43,43,0.4); }
            30% { transform: translate(1px, -1px); text-shadow: -1px 0 rgba(205,43,43,0.5); }
            60% { transform: translate(-1px, 1px); text-shadow: 1px 0 rgba(0,0,0,0.25); }
            100% { transform: translate(0,0); text-shadow: none; }
        }

        .blueprint-lines {
            position: relative;
            overflow: hidden;
            isolation: isolate;
        }
        .blueprint-lines::before,
        .blueprint-lines::after {
            content: '';
            position: absolute;
            inset: 0;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.6s ease, transform 0.8s cubic-bezier(0.25, 0.8, 0.25, 1);
            z-index: 0;
        }
        .blueprint-lines::before {
            background: repeating-linear-gradient(90deg, rgba(0,0,0,0.12) 0, rgba(0,0,0,0.12) 1px, transparent 1px, transparent 16px);
            transform: translateY(12px);
        }
        .blueprint-lines::after {
            background: repeating-linear-gradient(0deg, rgba(205,43,43,0.1) 0, rgba(205,43,43,0.1) 1px, transparent 1px, transparent 18px);
            transform: translateX(-12px);
        }
        .blueprint-lines.active::before,
        .blueprint-lines.active::after {
            opacity: 1;
            transform: translate(0,0);
        }
        .blueprint-lines > * {
            position: relative;
            z-index: 1;
        }

        .scanline-layer {
            position: absolute;
            inset: 0;
            pointer-events: none;
            background-image: linear-gradient(rgba(0,0,0,0.08) 1px, transparent 2px);
            background-size: 100% 10px;
            mix-blend-mode: soft-light;
            animation: scanMove 14s linear infinite;
            opacity: 0.32;
        }
        @keyframes scanMove {
            from { background-position-y: 0; }
            to { background-position-y: 100%; }
        }

        .dp-logomark {
            position: relative;
            width: 52px;
            height: 52px;
            border: 2px solid #111;
            border-radius: 12px;
            display: grid;
            place-items: center;
            background: #fff;
            box-shadow: 6px 6px 0 rgba(0,0,0,0.12);
            cursor: help;
            overflow: hidden;
        }
        .dp-logomark::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(205,43,43,0.16), transparent);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .dp-logomark:hover::before { opacity: 1; }
        .dp-logomark span { font-size: 12px; letter-spacing: 0.2em; font-weight: 700; }
        .dp-logomark .asset-reveal {
            position: absolute;
            bottom: 6px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 9px;
            letter-spacing: 0.2em;
            text-transform: uppercase;
            opacity: 0;
            transition: opacity 0.2s ease;
            color: #CD2B2B;
        }
        .dp-logomark:hover .asset-reveal { opacity: 1; }

        .invoice-overlay {
            position: fixed;
            inset: 0;
            background: rgba(255,252,247,0.95);
            z-index: 80;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 24px;
            font-family: 'Space Mono', monospace;
        }
        .invoice-overlay.active { display: flex; }
        .invoice-sheet {
            width: min(720px, 100%);
            background: #fff;
            border: 2px solid #111;
            box-shadow: 12px 12px 0 rgba(205,43,43,0.12);
            padding: 28px;
        }
        .invoice-sheet h3 { letter-spacing: 0.2em; font-size: 12px; }

        .glitch-banner {
            position: fixed;
            bottom: 12px;
            left: 50%;
            transform: translateX(-50%) translateY(120%);
            background: #111;
            color: #f8f1ea;
            padding: 10px 18px;
            border: 2px solid #CD2B2B;
            font-family: 'Space Mono', monospace;
            font-size: 11px;
            letter-spacing: 0.24em;
            text-transform: uppercase;
            z-index: 70;
            overflow: hidden;
            min-width: 260px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.22);
            transition: transform 0.6s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        .glitch-banner.active { transform: translateX(-50%) translateY(0); }
        .glitch-banner::before,
        .glitch-banner::after {
            content: '';
            position: absolute;
            inset: 0;
            mix-blend-mode: screen;
            opacity: 0;
            background: linear-gradient(90deg, rgba(205,43,43,0.24), rgba(255,244,235,0.12));
            animation: bannerGlitch 2.2s steps(2, end) infinite;
        }
        .glitch-banner::after { background: linear-gradient(90deg, rgba(255,244,235,0.14), rgba(205,43,43,0.28)); }
        @keyframes bannerGlitch {
            0% { opacity: 0; transform: translate(0,0); }
            20% { opacity: 0.3; transform: translate(-2px, 1px); }
            40% { opacity: 0.12; transform: translate(2px, -1px); }
            70% { opacity: 0.24; transform: translate(-1px, 1px); }
            100% { opacity: 0; transform: translate(0,0); }
        }

        /* Grift Rendering Modes */
        .style-abstracted { background: radial-gradient(circle at 20% 20%, rgba(205,43,43,0.12), transparent 40%), radial-gradient(circle at 80% 60%, rgba(17,17,17,0.14), transparent 35%), #fff; border: 2px solid #111; box-shadow: 8px 8px 0 #111; }
        .style-grid { background-image: linear-gradient(rgba(0,0,0,0.08) 1px, transparent 1px), linear-gradient(90deg, rgba(0,0,0,0.08) 1px, transparent 1px); background-size: 14px 14px; border: 1px solid #222; }
        .style-flat { background: linear-gradient(135deg, #f5f5f5, #d9d9d9); border: 3px solid #000; box-shadow: inset 0 0 0 2px #fff; }

        /* Grift Shop Grid */
        .pixel-grid {
            display: grid; grid-template-columns: repeat(16, 1fr); gap: 1px;
            background-color: #eee; border: 2px solid #000;
            width: 100%; aspect-ratio: 1; max-width: 400px; margin: 0 auto;
        }
        .pixel-cell { background-color: white; cursor: pointer; }
        .pixel-cell:hover { opacity: 0.8; }

        /* Loader */
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #FDFBF7; z-index: 9999; display: flex;
            align-items: center; justify-content: center; transition: opacity 0.5s;
        }
        .cursor-blink { animation: blink 1s step-end infinite; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
    </style>

    <!-- Import Map for Three.js -->
    <script type="importmap">
        { "imports": { "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js", "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/" } }
    </script>
</head>

<body class="overflow-x-hidden">

    <!-- LOADER -->
    <div id="loader">
        <div class="font-mono text-xs uppercase tracking-widest border border-black p-6 bg-white shadow-xl min-w-[300px]">
            <span id="loader-text"></span><span class="cursor-blink">_</span>
        </div>
    </div>

    <div id="ambient-layer" aria-hidden="true"></div>

    <!-- MOBILE MENU -->
    <div id="mobile-menu" class="fixed inset-0 bg-[#FDFBF7] z-[60] transform translate-x-full transition-transform duration-300 flex flex-col pt-20 px-6 overflow-y-auto">
        <div class="flex flex-col gap-6 text-xl font-bold uppercase tracking-widest font-mono">
            <button onclick="app.navigate('landing'); app.toggleMobileMenu()" class="text-left py-2 border-b border-gray-200">Exhibition</button>
            <button onclick="app.navigate('profiler'); app.toggleMobileMenu()" class="text-left py-2 border-b border-gray-200 text-red-600">Identify</button>
            <button onclick="app.navigate('pitch'); app.toggleMobileMenu()" class="text-left py-2 border-b border-gray-200">Project Plan</button>
            <button onclick="app.navigate('grift'); app.toggleMobileMenu()" class="text-left py-2 border-b border-gray-200">Grift Shop</button>
            <button onclick="app.navigate('barter'); app.toggleMobileMenu()" class="text-left py-2 border-b border-gray-200">Barter Post</button>
            <button onclick="app.navigate('ambition'); app.toggleMobileMenu()" class="text-left py-2 border-b border-gray-200">Ambition</button>
            <button onclick="app.navigate('protocol'); app.toggleMobileMenu()" class="text-left py-2 border-b border-gray-200">Protocol</button>
            <button onclick="app.navigate('team'); app.toggleMobileMenu()" class="text-left py-2 border-b border-gray-200">Meet the Team</button>
            <button onclick="app.navigate('archive'); app.toggleMobileMenu()" class="text-left py-2 border-b border-gray-200">Archive Index</button>
            <button onclick="app.navigate('gallery'); app.toggleMobileMenu()" class="text-left py-2 border-b border-gray-200">Gallery Tool</button>
            <a href="oldindex.html" class="text-left py-2 border-b border-gray-200 font-bold">Launch Referrer System</a>
        </div>
    </div>

    <!-- NAVIGATION -->
    <nav class="fixed top-0 left-0 w-full z-50 border-b border-black bg-[#FDFBF7] flex justify-between items-center px-4 py-3 md:px-8 bg-opacity-95 backdrop-blur-sm">
        <div class="flex items-center gap-2 cursor-pointer group" onclick="app.navigate('landing')">
            <div class="w-3 h-3 bg-black rounded-full group-hover:bg-red-600 transition-colors"></div>
            <span class="font-bold tracking-widest text-sm font-mono uppercase relative z-50">LOOMWORKS</span>
        </div>
        
        <!-- Desktop Nav -->
        <div class="hidden lg:flex gap-6 text-xs font-mono tracking-wide uppercase">
            <button onclick="app.navigate('landing')" class="nav-btn hover:text-red-600 transition-colors ui-click" data-target="landing">Exhibition</button>
            <button onclick="app.navigate('profiler')" class="nav-btn hover:text-red-600 transition-colors ui-click font-bold text-red-600" data-target="profiler">Identify</button>
            <button onclick="app.navigate('pitch')" class="nav-btn hover:text-red-600 transition-colors ui-click" data-target="pitch">Pitch</button>
            <button onclick="app.navigate('grift')" class="nav-btn hover:text-red-600 transition-colors ui-click" data-target="grift">Grift Shop</button>
            <button onclick="app.navigate('barter')" class="nav-btn hover:text-red-600 transition-colors ui-click" data-target="barter">Barter</button>
            <button onclick="app.navigate('ambition')" class="nav-btn hover:text-red-600 transition-colors ui-click" data-target="ambition">Ambition</button>
            <button onclick="app.navigate('protocol')" class="nav-btn hover:text-red-600 transition-colors ui-click text-gray-500" data-target="protocol">Protocol</button>
            <button onclick="app.navigate('team')" class="nav-btn hover:text-red-600 transition-colors ui-click" data-target="team">Meet the Team</button>
            <button onclick="app.navigate('archive')" class="nav-btn hover:text-red-600 transition-colors ui-click" data-target="archive">Archive</button>
            <button onclick="app.navigate('gallery')" class="nav-btn hover:text-red-600 transition-colors ui-click border-l border-gray-300 pl-4" data-target="gallery">Gallery Tool</button>
            <a href="oldindex.html" class="ml-4 border border-black px-3 py-2 text-[10px] font-mono uppercase tracking-widest bg-white hover:bg-black hover:text-white transition-colors">Launch Referrer</a>
        </div>

        <!-- Mobile Hamburger -->
        <button onclick="app.toggleMobileMenu()" class="lg:hidden relative z-50 p-2 ui-click" aria-label="Toggle navigation menu">
            <div class="space-y-1.5">
                <div class="w-6 h-0.5 bg-black transition-all" id="ham-1"></div>
                <div class="w-6 h-0.5 bg-black transition-all" id="ham-2"></div>
                <div class="w-6 h-0.5 bg-black transition-all" id="ham-3"></div>
            </div>
        </button>
    </nav>

    <!-- VIEW: LANDING -->
    <section id="view-landing" class="view-section active relative">
        <div class="scanline-layer hidden md:block" aria-hidden="true"></div>
        <div class="px-4 md:px-8 py-20 md:py-32 max-w-7xl mx-auto blueprint-lines">
            <div class="mb-6 inline-block border border-black px-2 py-1 text-[10px] font-mono tracking-widest uppercase bg-white">Field Materials Case Study #902</div>
            <div class="flex items-center gap-4 mb-4">
                <div class="dp-logomark" title="Loomworks Domestic Product">
                    <span>DP</span>
                    <div class="asset-reveal">YOU ARE A VERIFIED ASSET.</div>
                </div>
                <div class="text-[10px] uppercase font-mono tracking-[0.3em] text-gray-600">Surveillance-Aware Exhibition Shell</div>
            </div>
            <h1 id="dp-title" class="text-6xl md:text-9xl font-bold tracking-tighter mb-8 glitch-text" data-text="DOMESTIC PRODUCT">DOMESTIC PRODUCT</h1>
            <p class="max-w-2xl text-lg md:text-2xl font-mono leading-relaxed text-gray-700 mb-12">
                A forensic study in how we manufacture magic, desire, and icons.
                <span class="text-xs md:text-sm mt-4 block text-gray-500 uppercase tracking-widest border-l-2 border-red-600 pl-4">New York City • Limited Engagement</span>
            </p>
            <div class="flex flex-wrap gap-4">
                <button onclick="app.navigate('profiler')" class="ui-click bg-black text-white px-8 py-4 font-mono text-xs hover:bg-red-600 transition-colors uppercase tracking-widest shadow-lg">Begin Identity Assessment</button>
                <button onclick="app.navigate('pitch')" class="ui-click border border-black bg-white px-8 py-4 font-mono text-xs hover:bg-black hover:text-white transition-colors uppercase tracking-widest">View Project Plan</button>
                <button onclick="ticketing.open()" class="ui-click border border-black bg-white px-8 py-4 font-mono text-xs hover:bg-black hover:text-white transition-colors uppercase tracking-widest">3-Tier Tickets</button>
                <a href="oldindex.html" class="ui-click border border-black bg-white px-8 py-4 font-mono text-xs hover:bg-black hover:text-white transition-colors uppercase tracking-widest">Launch Referrer Sequence</a>
            </div>
            <div class="mt-10 pt-6 border-t border-gray-200 space-y-4">
                <div class="font-mono text-[10px] uppercase tracking-[0.25em] text-gray-500">Follow the flow</div>
                <div class="flex flex-wrap gap-2 mt-3">
                    <button onclick="app.navigate('profiler')" class="ui-click border border-black bg-white px-3 py-2 text-[10px] font-mono uppercase tracking-widest hover:bg-black hover:text-white transition-colors">Identity</button>
                    <button onclick="app.navigate('pitch')" class="ui-click border border-black bg-white px-3 py-2 text-[10px] font-mono uppercase tracking-widest hover:bg-black hover:text-white transition-colors">Pitch</button>
                    <button onclick="app.navigate('gallery')" class="ui-click border border-black bg-white px-3 py-2 text-[10px] font-mono uppercase tracking-widest hover:bg-black hover:text-white transition-colors">Gallery</button>
                    <button onclick="app.navigate('grift')" class="ui-click border border-black bg-white px-3 py-2 text-[10px] font-mono uppercase tracking-widest hover:bg-black hover:text-white transition-colors">Grift Shop</button>
                    <button onclick="app.navigate('barter')" class="ui-click border border-black bg-white px-3 py-2 text-[10px] font-mono uppercase tracking-widest hover:bg-black hover:text-white transition-colors">Barter Post</button>
                    <button onclick="app.navigate('archive')" class="ui-click border border-black bg-white px-3 py-2 text-[10px] font-mono uppercase tracking-widest hover:bg-black hover:text-white transition-colors">Archive Index</button>
                    <a href="oldindex.html" class="ui-click border border-black bg-white px-3 py-2 text-[10px] font-mono uppercase tracking-widest hover:bg-black hover:text-white transition-colors">Referrer Launch</a>
                </div>
                <div class="flex flex-wrap gap-2 text-[11px] text-gray-700 font-mono">
                    <div class="legal-copy ui-click">Monitoring Notice <span class="text-[9px] uppercase tracking-[0.2em]">All interactions recorded as art</span></div>
                    <div class="legal-copy ui-click">Consent Receipt <span class="text-[9px] uppercase tracking-[0.2em]">You choose your own complicity</span></div>
                </div>
            </div>

        </div>
    </section>


    <!-- VIEW: AMBITION (CONNECTED WORLD) -->
    <section id="view-ambition" class="view-section blueprint py-16 min-h-screen text-gray-900">
        <div class="max-w-6xl mx-auto px-6 space-y-12">
            <div class="flex flex-col lg:flex-row lg:items-end lg:justify-between gap-6">
                <div class="space-y-3 max-w-3xl">
                    <div class="inline-flex items-center gap-2 border border-black px-3 py-1 text-[10px] font-mono uppercase tracking-widest bg-white">Ambition // Why This Exists</div>
                    <h1 class="text-4xl md:text-5xl font-bold uppercase tracking-tight">Welcome to the Threshold</h1>
                    <p class="font-mono text-sm text-gray-700 leading-relaxed">Domestic Product is not a brand. Loomworks is not a company. Celli is not a mascot. None of this exists in the traditional sense—and yet you are inside it. This is a proof that one person can build something that feels institutional, emotional, and real enough to fear.</p>
                </div>
                <div class="bg-white border border-black/20 px-4 py-3 shadow-lg w-full max-w-xs">
                    <div class="text-[10px] font-mono uppercase tracking-[0.3em] text-red-700">Status</div>
                    <div class="text-2xl font-bold">Live Demonstration</div>
                    <p class="text-xs text-gray-600">Playable critique, inhabitable satire, and a working invitation to build your own world.</p>
                </div>
            </div>

            <div class="bg-white border border-black rounded-2xl p-8 shadow-2xl space-y-8">
                <div class="grid md:grid-cols-2 gap-8">
                    <div class="space-y-4">
                        <div class="text-[10px] font-mono uppercase tracking-widest text-red-700">What We’re Trying to Show You</div>
                        <p class="text-sm text-gray-800 leading-relaxed">This installation, this website, this archive, this musical engine, this puzzle—every surface here is a demonstration of possibility. It models how disciplines dissolve into each other and how a single individual can wield design systems, lore, software, and commerce without waiting for permission.</p>
                        <p class="text-sm text-gray-800 leading-relaxed">Ambition is no longer a category of resources; it is a category of courage. You’re not meant to admire this. You’re meant to see yourself in it and leave with the question: <span class="font-bold">If one person can build a world, what can I build?</span></p>
                    </div>
                    <div class="space-y-3 bg-[#FDFBF7] border border-black/10 rounded-lg p-4 shadow-sm">
                        <div class="text-[10px] font-mono uppercase tracking-widest text-gray-600">What You’re Actually Seeing</div>
                        <ul class="list-disc list-inside text-sm text-gray-800 space-y-2">
                            <li><span class="font-bold">Celli</span>: a 30-track musical in micro-songs, a playable voxel tool, and the emotional core—an avatar of corporate neglect trapped inside productivity software.</li>
                            <li><span class="font-bold">Domestic Product</span>: a pop-up museum and retail experiment built from archives of manufactured icons, reframed as evidence of how culture is made, sold, copied, and circulated.</li>
                            <li><span class="font-bold">Loomworks</span>: the fictional corporation you feel in your bones—classification engine, onboarding portal, economic horror show, and bureaucratic theology.</li>
                            <li><span class="font-bold">The Archive</span>: real objects folded into the fiction, proof that industrial myth-making has always been with us.</li>
                        </ul>
                    </div>
                </div>

                <div class="grid md:grid-cols-3 gap-4">
                    <div class="bg-black text-white rounded-xl p-4 shadow-lg space-y-2">
                        <div class="text-[10px] font-mono uppercase tracking-widest text-red-200">Celli</div>
                        <h3 class="text-xl font-bold">The Spreadsheet That Wanted to Be Human</h3>
                        <p class="text-sm text-gray-100 leading-relaxed">She began as a cursor in a cell and became the anxious, yearning signal of the whole universe. She asks what creation means when everything around you tries to turn creation into labor.</p>
                    </div>
                    <div class="bg-white border border-black/10 rounded-xl p-4 shadow-lg space-y-2">
                        <div class="text-[10px] font-mono uppercase tracking-widest text-red-700">Domestic Product</div>
                        <h3 class="text-xl font-bold">The Museum for Manufactured Icons</h3>
                        <p class="text-sm text-gray-800 leading-relaxed">Early animation, Japanese menko, production drawings, and other fragile artifacts become evidence of industrial imagination. If icons are manufactured, who manufactures us?</p>
                    </div>
                    <div class="bg-white border border-black/10 rounded-xl p-4 shadow-lg space-y-2">
                        <div class="text-[10px] font-mono uppercase tracking-widest text-red-700">Loomworks</div>
                        <h3 class="text-xl font-bold">The Corporation That Feels Real Enough to Fear</h3>
                        <p class="text-sm text-gray-800 leading-relaxed">Lantern roles, identity access, barter posts, grift shops, cheerful warnings. The workflow becomes worldview; the interface becomes ideology; the corporation becomes cosmology.</p>
                    </div>
                </div>

                <div class="grid md:grid-cols-2 gap-6">
                    <div class="bg-white border border-black/10 rounded-lg p-5 shadow-sm space-y-3">
                        <div class="text-[10px] font-mono uppercase tracking-widest text-red-700">The Archive</div>
                        <h3 class="text-lg font-bold">A Real History Inside a Fake Story</h3>
                        <p class="text-sm text-gray-800 leading-relaxed">Frog statues, postcards, menko, production drawings: none of them are props. They are relics, raw materials, and teachers that contrast handmade myth with automated myth-making.</p>
                    </div>
                    <div class="bg-white border border-black/10 rounded-lg p-5 shadow-sm space-y-3">
                        <div class="text-[10px] font-mono uppercase tracking-widest text-red-700">The Experience</div>
                        <h3 class="text-lg font-bold">Playable Critique, Inhabitable Satire</h3>
                        <p class="text-sm text-gray-800 leading-relaxed">Visitors are classified, evaluated, invited to barter, to shop, to listen, to piece together a narrative. They feel how invisible systems shape behavior and how those structures quietly rewrite us.</p>
                    </div>
                </div>

                <div class="bg-white border border-black/20 rounded-xl p-6 shadow-lg space-y-4">
                    <div class="flex flex-wrap items-center gap-2 text-[10px] font-mono uppercase tracking-widest text-gray-600">
                        <span class="px-2 py-1 border border-gray-300 rounded-full">Ambition Statement</span>
                        <span class="px-2 py-1 border border-gray-300 rounded-full">One-Person Studio</span>
                        <span class="px-2 py-1 border border-gray-300 rounded-full">Invitation</span>
                    </div>
                    <p class="text-sm text-gray-800 leading-relaxed">This universe—worldbuilding, design systems, software, music, archive curation, spatial logic—was built by a single human. Not to brag, shock, or mystify, but to show that the tools finally let you bring your full imagination without waiting for a grant, a team, or a patron.</p>
                    <p class="text-sm text-gray-800 leading-relaxed font-semibold">Welcome to the edge where personal creation becomes industrial myth. The art is the question; everything else is the invitation.</p>
                </div>

                <div class="bg-white border border-black rounded-2xl p-8 shadow-2xl space-y-10 blueprint-lines">
                    <div class="space-y-4">
                        <div class="text-[10px] font-mono uppercase tracking-[0.3em] text-red-700">The Ethics of Held Wonder</div>
                        <p class="text-lg font-bold leading-tight">Every system you encounter here — the Barter Post, the Grift Shop, the Identity Quiz, the Archive Capsule, the Lantern Protocol — is designed around a single principle:</p>
                        <p class="text-2xl font-bold">Wonder is priceless.<br>Access is not.</p>
                        <p class="text-sm text-gray-800 leading-relaxed">Loomworks never sells magic.<br>It sells paths into it.</p>
                        <p class="text-sm text-gray-800 leading-relaxed">This is commerce you are invited to participate in, not tricked into.<br>You don’t buy to belong — you buy because you already do.</p>
                        <p class="text-sm text-gray-800 leading-relaxed">By stepping into Domestic Product, you knowingly engage in a marketplace that openly questions itself:</p>
                        <div class="bg-[#FDFBF7] border border-black/10 rounded-lg p-4 text-sm text-gray-900 leading-relaxed space-y-2">
                            <p>How much does a memory cost?</p>
                            <p>What is the fair price of a feeling?</p>
                            <p>Is value something we discover, or something we manufacture?</p>
                            <p>If we understand the system, does it still control us?</p>
                        </div>
                        <p class="text-sm text-gray-800 leading-relaxed">Here, your purchases are not transactions.<br>They are votes for the kind of world you want to build.</p>
                        <p class="text-sm text-gray-800 leading-relaxed">We call this ethical capitalization:<br>a creative economy where delight funds more delight, where curiosity sustains culture, and where the system shows you the gears turning.</p>
                        <p class="text-sm text-gray-800 leading-relaxed font-semibold">You are complicit.<br>You are aware.<br>And you are welcome.</p>
                    </div>

                    <div class="space-y-4">
                        <div class="text-[10px] font-mono uppercase tracking-[0.3em] text-red-700">What Loomworks Builds (And Why)</div>
                        <p class="text-lg font-bold leading-tight">Loomworks exists to prove something simple:</p>
                        <p class="text-xl font-bold italic">Creation is not linear.<br>Creation is dimensional.</p>
                        <p class="text-sm text-gray-800 leading-relaxed">Each subsystem demonstrates a different model of making:</p>
                        <div class="grid md:grid-cols-2 gap-4 text-sm text-gray-900">
                            <div class="space-y-3">
                                <p><span class="font-bold">Domestic Product</span> — a corporatized museum; the front door into myth</p>
                                <p><span class="font-bold">Celli.OS</span> — a musical spreadsheet; a narrative engine disguised as a tool</p>
                                <p><span class="font-bold">The Archive Capsule</span> — a century of manufactured icons, curated with intent</p>
                                <p><span class="font-bold">The Grift Shop</span> — a transparent satire of value creation and speculation</p>
                            </div>
                            <div class="space-y-3">
                                <p><span class="font-bold">The Lanterns</span> — the human interface to an inhuman system</p>
                                <p><span class="font-bold">The Sculpture Generator (coming soon)</span> — viral, personal, generative identity artifacts</p>
                            </div>
                        </div>
                        <p class="text-sm text-gray-800 leading-relaxed">Together they form a living world built from:</p>
                        <div class="flex flex-wrap gap-2 text-[11px] font-mono uppercase tracking-[0.2em]">
                            <span class="px-2 py-1 border border-gray-300 rounded-full">code</span>
                            <span class="px-2 py-1 border border-gray-300 rounded-full">curation</span>
                            <span class="px-2 py-1 border border-gray-300 rounded-full">commerce</span>
                            <span class="px-2 py-1 border border-gray-300 rounded-full">nostalgia</span>
                            <span class="px-2 py-1 border border-gray-300 rounded-full">satire</span>
                            <span class="px-2 py-1 border border-gray-300 rounded-full">sincerity</span>
                            <span class="px-2 py-1 border border-gray-300 rounded-full">absurdity</span>
                            <span class="px-2 py-1 border border-gray-300 rounded-full">emotion</span>
                        </div>
                        <p class="text-sm text-gray-800 leading-relaxed">This is more than an art show.<br>It is a demonstration of what a single creator with modern tools can build.</p>
                        <p class="text-sm text-gray-900 leading-relaxed font-semibold">You are witnessing the future of small, strange, ambitious worlds.</p>
                    </div>
                </div>

                <div class="bg-black text-white rounded-2xl p-6 shadow-[0_20px_60px_rgba(0,0,0,0.25)] border border-red-200/30 relative overflow-hidden">
                    <div class="absolute inset-0 pointer-events-none opacity-20 mix-blend-screen" style="background-image: repeating-linear-gradient(90deg, rgba(255,255,255,0.12) 0, rgba(255,255,255,0.12) 1px, transparent 1px, transparent 6px), repeating-linear-gradient(180deg, rgba(255,255,255,0.1) 0, rgba(255,255,255,0.1) 1px, transparent 1px, transparent 4px);"></div>
                    <div class="relative space-y-4">
                        <div class="text-[10px] font-mono uppercase tracking-[0.3em] text-red-200">Loomworks Lore File</div>
                        <details class="bg-white/5 border border-white/10 rounded-xl p-4 shadow-inner group">
                            <summary class="flex items-center justify-between cursor-pointer select-none">
                                <div class="space-y-1">
                                    <p class="text-xs font-mono uppercase tracking-[0.2em] text-red-200">Expandable Essay for Domestic Product</p>
                                    <h3 class="text-2xl font-bold glitch-text" data-text="Why We Stopped Making Worlds — And Why We Must Begin Again">Why We Stopped Making Worlds — And Why We Must Begin Again</h3>
                                </div>
                                <span class="text-sm font-mono uppercase tracking-[0.3em] bg-red-700 text-white px-3 py-1 rounded-full group-open:bg-white group-open:text-black">Open</span>
                            </summary>
                            <div class="mt-4 space-y-4 text-sm leading-relaxed text-red-100">
                                <p class="font-mono text-[11px] uppercase tracking-[0.25em] text-red-300">Click to expand the Loomworks interpretation.</p>
                                <p>For a brief and brilliant moment, the early internet was made not by corporations, but by weirdos. Not by marketing teams, but by artists. Not by conversion funnels, but by children and tinkerers and storytelling obsessives who held a new medium and asked the simplest, most generative question possible: <span class="italic text-red-200">what if this could be a world?</span></p>
                                <p class="bg-white/5 border border-red-500/30 rounded-lg p-3 text-white">From approximately 1999–2006, the web offered a paradise of handcrafted mythologies: Homestar Runner, Neopets, Albino Blacksheep, eBaum’s World, Newgrounds, Strong Bad Emails, Lemon Demon videos, AMV culture, and thousands of personal shrines on Geocities and Angelfire. Early fanfiction archives, indie ARGs, Flash puzzle games, hypertext essays—each strange, handmade, and alive.</p>
                                <p>These creators were the hitmakers of a proto-internet: artists who treated the browser as a stage, not a brochure; a canvas, not a commodity. Homestar Runner resonated so fully that its makers were invited to mainstream studios. Kyle Mooney carried his lo-fi web sensibilities into SNL only to watch them shrink under institutional clocks. That is the story of the web, too.</p>
                                <p class="font-semibold text-red-100">Two shifts flattened the surface layer:</p>
                                <ol class="list-decimal list-inside space-y-2">
                                    <li>Profiles replaced pages. The web moved from personal sites to templated identities. Instead of building worlds, people built profiles and posted into feeds. The web became less a canvas and more a conveyor belt.</li>
                                    <li>Optimization replaced expression. Clean UI, conversion funnels, SEO, accessibility compliance, content strategies, growth loops, mobile responsiveness—none of these are evil, but they squeezed out quirk, narrative, lore, surprise, and the handmade.</li>
                                </ol>
                                <p class="italic text-red-200">Streaming finished the flattening.</p>
                                <p>Linear channels became modular libraries; events became troughs. Toonami, Adult Swim, and Nick at Night once asked you to enter a world. Algorithms now promise to choose for you, removing the ritual of choosing at all. Media became a trough, not a destination. We stopped visiting worlds and instead drank whatever flowed our way.</p>
                                <p class="font-semibold text-red-100">But the web is not smaller—we just stopped letting it be big.</p>
                                <p>The cost of building worlds became invisible. The belief that small teams could build them evaporated. The creative muscle atrophied under templates and feeds, and the attention economy punished everything that didn’t look like everything else. Yet the tools got better, the friction dropped, gatekeepers relaxed, and culture fractured into niches again. An individual can once more build something that feels like a studio effort—if they are willing to be brave, weird, earnest, obsessive, emotional, and stubborn enough to try.</p>
                                <p class="bg-white/10 border border-white/20 rounded-lg p-3">The template always existed. Most people simply lost the nerve.</p>
                                <p class="font-semibold text-red-100">Why begin again, and why through Loomworks?</p>
                                <p>Domestic Product exists because the modern web is starving for worlds again. Not “cool looking landing pages.” Not “brands with tone.” Not “SaaS aesthetics with whimsy.” But worlds with lore, humor, contradiction, characters, ritual, emotional stakes, and questions that know they’re questions.</p>
                                <p>Loomworks holds that the internet is healthiest when it feels like a playground, not an ad network. The early web felt that way. Your instincts remember it. This essay sits inside the Loomworks ambition file as a reminder that the platform is an argument for re-enchantment: proof that despite everything, the web can still hold wonder—especially when it glitches instead of optimizes.</p>
                                <p class="font-bold text-white">But only if we build worlds again.</p>

                                <div class="border-t border-white/10 pt-6 space-y-4">
                                    <p class="font-mono text-[11px] uppercase tracking-[0.25em] text-red-300">Ambition Addendum — The World Is Getting Strange Again</p>
                                    <p class="text-white">The early web worked because it was unpolished, unplanned, and owned by no one. It was Homestar Runner and Neopets and Newgrounds and AlbinoBlackSheep—a patchwork of little worlds that felt alive because a handful of humans bottled sincerity into pixels.</p>
                                    <p class="text-white">Platforms industrialized, funnels optimized, and creativity shrank into templates. The world flattened. Now the strange magic is returning: AI is making individuals powerful again. Not by replacing them, but by amplifying them so a single person can build what once required entire studios. Loomworks is born from that shift.</p>

                                    <div class="bg-white/5 border border-red-500/30 rounded-lg p-4 space-y-3 text-white">
                                        <h4 class="text-lg font-bold glitch-text" data-text="Loomworks as World Model">Loomworks as World Model</h4>
                                        <p class="text-red-100">This is not a brand or a pop-up. It is a structured, playable philosophy about how humans and synthetic tools can make meaning together without losing tone, coherence, humor, or ethics.</p>
                                        <ul class="list-disc list-inside space-y-1 text-red-100">
                                            <li>People crave worlds, not landing pages.</li>
                                            <li>Tools should feel like collaborators, not overlords.</li>
                                            <li>Restraint is a superpower.</li>
                                        </ul>
                                        <p class="text-red-100">Like early Disney, early Web 1.0, and early ARGs, Loomworks is dense with lore, filled with secrets, yet legible, humane, and playful. This is the AI future people want.</p>
                                    </div>

                                    <div class="space-y-2 text-white">
                                        <h4 class="text-lg font-bold">Worlds, Not Widgets</h4>
                                        <p>A landing page tells you what something is. A world shows you who you become inside it. Loomworks is a stage: the identity quiz as ritual classification, the Grift Shop as satire, Domestic Product as a museum of manufactured myth, Celli as a metaphor for toolhood in an age of living software.</p>
                                        <p>This ecosystem holds narrative, art, commerce, and critique at once. Your interactions aren’t mined—they’re mirrored back with delight.</p>
                                    </div>

                                    <div class="grid md:grid-cols-2 gap-4 text-red-100">
                                        <div class="bg-white/5 border border-white/10 rounded-lg p-4 space-y-2">
                                            <h4 class="text-lg font-bold text-white">AI as Amplifier</h4>
                                            <p>For the first time, one person can write lore, compose music, design interfaces, code interactions, build spaces, craft merchandise, architect narrative, and sculpt emotion—solo—with AI as an amplifier, not a substitute. What once demanded studios and departments can now be orchestrated by a single human with a strong compass.</p>
                                            <p class="font-semibold text-white">This is not efficiency. It’s a new art form.</p>
                                        </div>
                                        <div class="bg-white/5 border border-white/10 rounded-lg p-4 space-y-2">
                                            <h4 class="text-lg font-bold text-white">Restraint as Luxury</h4>
                                            <p>Hanna-Barbera used limited animation to keep things fast, cheap, and charming. Loomworks uses constraints as an aesthetic: controlled glitches, repeating motifs, limited palettes, ritualized UI, curated agent behaviors, intentional silence, and meaningful negative space.</p>
                                            <p class="text-white">As systems get noisy, Loomworks gets precise. As content gets abundant, Loomworks gets selective.</p>
                                        </div>
                                    </div>

                                    <div class="space-y-3 text-white">
                                        <h4 class="text-lg font-bold">Cadenced ARGs, Not Chaos</h4>
                                        <p>The future of interactive narrative isn’t AI running unbounded in real time—it’s AI acting inside worlds with rules. Loomworks is architected for timed vignettes, seasonal distortions, lantern transmissions, classified memos, disappearing files, recurring motifs, shareable artifacts, and unique geometric sculptures per user. Each reveal feels authored because it is. Emergence blooms inside a human-designed container.</p>
                                    </div>

                                    <div class="space-y-2 text-white">
                                        <h4 class="text-lg font-bold">Channel Energy, Library Scale</h4>
                                        <p>We used to enter worlds by choice: Cartoon Network at 4pm, MTV after school, Nick at Nite before bed—curated channels, not endless troughs. Streaming flattened the ritual. Loomworks restores presentation and pacing: segments, rituals, characters, tone, cohesion. It’s not content; it’s a universe with airtime.</p>
                                    </div>

                                    <div class="space-y-2 text-white">
                                        <h4 class="text-lg font-bold">Wonder, Again</h4>
                                        <p>Above all, Loomworks aims to make people feel wonder again—worlds hand-built, commerce playful, interfaces theatrical, art funny and sincere, synthetic tools enabling beauty, creativity belonging to anyone. It’s a world, a museum, a satire, a game, a pop-up, an ARG, a piece of digital folklore, and a template for the next decade of human–AI creation.</p>
                                        <p class="font-semibold text-red-200">It’s one person, a vision, a curated archive, and enough stubborn brightness to build something people haven’t seen before: a handcrafted world in an era that forgot how.</p>
                                    </div>
                                </div>
                            </div>
                        </details>
                    </div>
                </div>
            </div>
        </div>
    </section>


    <!-- VIEW: PROFILER (IDENTITY QUIZ) -->
    <section id="view-profiler" class="view-section bg-[#FDFBF7] min-h-screen flex flex-col pt-24 relative">

        <!-- COMPACT RESULT BANNER (Initially Hidden) -->
        <div id="prof-banner" class="hidden w-full bg-white border-b border-black py-4 px-6 sticky top-[57px] z-40 shadow-md transition-all">
            <div class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
                <div>
                    <div class="text-[10px] font-mono text-gray-400 uppercase tracking-widest">Classification Locked</div>
                    <h2 class="text-2xl md:text-3xl font-bold uppercase text-red-600" id="banner-title">Identity Stored</h2>
                </div>
                <div class="flex gap-4 items-center">
                    <p class="hidden md:block font-mono text-xs italic text-gray-600 mr-4" id="banner-motto">Prepared for entry.</p>
                    <button onclick="app.navigate('gallery')" class="bg-black text-white px-4 py-2 text-[10px] font-mono uppercase tracking-widest hover:bg-red-600">Enter Gallery</button>
                </div>
            </div>
        </div>

        <div class="max-w-5xl mx-auto px-6 pb-16 w-full flex flex-col gap-10">
            <div class="text-center space-y-4">
                <div class="inline-flex items-center gap-2 border border-black px-3 py-1 text-[10px] font-mono uppercase tracking-widest bg-white">Identity Quiz</div>
                <h2 class="text-4xl md:text-5xl font-bold uppercase tracking-tight leading-tight">Choose your signal</h2>
                <p class="font-mono text-sm text-gray-700 leading-relaxed max-w-3xl mx-auto">Pick your lane and we'll open a sealed quiz overlay to confirm it—no permanent console pinned to the top of the page.</p>
            </div>

            <div class="bg-white border border-black rounded-xl shadow-xl overflow-hidden" id="prof-shell">
                <div class="p-6 space-y-6" id="prof-content-area">
                    <!-- Stage 1: Intro/Selection -->
                    <div id="prof-stage-select" class="fade-in space-y-5">
                        <p class="font-mono text-xs text-gray-600 text-center uppercase tracking-widest">Pick your lane. A focused quiz will open in a separate overlay to confirm your classification.</p>
                        <div class="grid grid-cols-1 md:grid-cols-5 gap-3">
                            <button onclick="profiler.select('dreamer', this)" class="role-card border border-gray-200 p-4 text-left hover:bg-white bg-white/70 ui-click rounded-lg">
                                <div class="text-lg font-bold uppercase mb-1">Dreamer</div>
                                <div class="role-desc font-mono text-[10px] text-gray-500 leading-tight">Hunts for resonance and lyrical angles.</div>
                            </button>
                            <button onclick="profiler.select('scholar', this)" class="role-card border border-gray-200 p-4 text-left hover:bg-white bg-white/70 ui-click rounded-lg">
                                <div class="text-lg font-bold uppercase mb-1">Scholar</div>
                                <div class="role-desc font-mono text-[10px] text-gray-500 leading-tight">Documents provenance and keeps the receipts.</div>
                            </button>
                            <button onclick="profiler.select('investor', this)" class="role-card border border-gray-200 p-4 text-left hover:bg-white bg-white/70 ui-click rounded-lg">
                                <div class="text-lg font-bold uppercase mb-1">Investor</div>
                                <div class="role-desc font-mono text-[10px] text-gray-500 leading-tight">Measures upside; tracks viable returns.</div>
                            </button>
                            <button onclick="profiler.select('passerby', this)" class="role-card border border-gray-200 p-4 text-left hover:bg-white bg-white/70 ui-click rounded-lg">
                                <div class="text-lg font-bold uppercase mb-1">Passerby</div>
                                <div class="role-desc font-mono text-[10px] text-gray-500 leading-tight">Arrives without baggage; reads the room plainly.</div>
                            </button>
                            <button onclick="profiler.select('lantern', this)" class="role-card border border-gray-200 p-4 text-left hover:bg-white bg-white/70 ui-click rounded-lg">
                                <div class="text-lg font-bold uppercase mb-1">Lantern</div>
                                <div class="role-desc font-mono text-[10px] text-gray-500 leading-tight">Carries the story; keeps guests oriented.</div>
                            </button>
                        </div>
                    </div>

                    <!-- Stage 2: Doubt -->
                    <div id="prof-stage-doubt" class="hidden text-center border border-black p-8 bg-[#FDFBF7] shadow-[6px_6px_0px_0px_rgba(205,43,43,1)] rounded-lg">
                        <h3 class="text-3xl font-bold uppercase mb-3 text-red-600">Are you sure?</h3>
                        <p class="font-mono text-xs mb-6 leading-relaxed text-gray-700">
                            Your self-classification clashes with most visitor patterns. We'll open a focused pop-up quiz to test it without pinning anything to the top of the page.
                        </p>
                        <div class="flex gap-4 justify-center flex-wrap">
                            <button onclick="profiler.reset()" class="ui-click border-b-2 border-gray-300 hover:border-black text-xs font-mono uppercase pb-1">Reconsider</button>
                            <button onclick="profiler.startQuiz()" class="ui-click bg-black text-white px-6 py-3 text-xs font-mono uppercase tracking-widest hover:bg-red-600 transition-colors">Launch Verification Pop-up</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

            <div id="prof-result-card" class="hidden grid md:grid-cols-3 gap-4 items-start">
                <div class="md:col-span-2 bg-white border border-black rounded-xl p-6 shadow-lg">
                    <div class="text-[10px] font-mono uppercase tracking-widest text-red-600 mb-2">Assessment Complete</div>
                    <div class="font-bold text-2xl mb-1" id="result-title">Identity Stored</div>
                    <div class="font-mono text-sm text-gray-600 mb-4" id="result-motto">Proceed to Gallery or sculpt.</div>
                    <p class="text-sm text-gray-600">Your badge is pinned above. Use the Sculpture Generator to mint a bespoke artifact from your profile, or drop straight into the gallery.</p>
                </div>
                <div class="bg-white border border-gray-200 rounded-xl p-6 shadow-sm space-y-3">
                    <div class="font-mono text-[10px] uppercase tracking-widest text-gray-500">Next</div>
                    <button onclick="app.navigate('gallery')" class="ui-click w-full border border-black bg-white px-3 py-2 text-[10px] font-mono uppercase tracking-widest hover:bg-black hover:text-white transition-colors">Gallery</button>
                    <button onclick="app.navigate('ambition')" class="ui-click w-full border border-black bg-white px-3 py-2 text-[10px] font-mono uppercase tracking-widest hover:bg-black hover:text-white transition-colors">Ambition Blueprint</button>
                </div>
            </div>

            <div id="sculpture-generator" class="hidden bg-white border border-black rounded-xl shadow-xl p-6 grid md:grid-cols-2 gap-6">
                <div class="space-y-3">
                    <div class="font-mono text-[10px] uppercase tracking-widest text-red-600">Sculpture / Art Generator</div>
                    <h3 class="text-2xl font-bold">Generate a signal artifact</h3>
                    <p class="text-sm text-gray-600">We translate your classification into a compact blueprint: material suggestions, silhouette, and a mood palette ready for fabrication or AI pipelines.</p>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                        <label class="text-xs font-mono uppercase tracking-widest text-gray-600 flex flex-col gap-1">Material Bias
                            <select id="sculpture-material" class="border border-gray-300 px-2 py-2 text-sm">
                                <option>Cast glass + steel</option>
                                <option>Folded paper + neon</option>
                                <option>Reclaimed plastic + resin</option>
                                <option>Stone powder + pigment</option>
                            </select>
                        </label>
                        <label class="text-xs font-mono uppercase tracking-widest text-gray-600 flex flex-col gap-1">Format
                            <select id="sculpture-format" class="border border-gray-300 px-2 py-2 text-sm">
                                <option>Table-top maquette</option>
                                <option>Wall relief</option>
                                <option>Suspended mobile</option>
                                <option>Floor totem</option>
                            </select>
                        </label>
                    </div>
                    <button onclick="profiler.generateSculpture()" class="ui-click bg-black text-white px-4 py-3 text-[10px] font-mono uppercase tracking-widest hover:bg-red-600">Generate Blueprint</button>
                </div>
                <div class="sculpture-preview rounded-lg p-4" id="sculpture-preview">
                    <div class="grid md:grid-cols-2 gap-5 lg:gap-6">
                        <div class="sculpture-canvas-shell rounded-lg overflow-hidden" id="sculpture-canvas-shell">
                            <canvas id="sculpture-canvas" width="420" height="260" aria-label="Sculpture preview"></canvas>
                        </div>
                        <div class="sculpture-readout rounded-lg p-4 font-mono text-xs flex flex-col gap-4 justify-between" id="sculpture-readout">
                            <div class="space-y-2">
                                <div class="text-[10px] uppercase tracking-widest text-gray-500">Awaiting prompt...</div>
                                <p class="text-sm text-gray-700">Run the quiz and generate a specimen to see the deterministic voxel sketch and dossier.</p>
                            </div>
                            <div class="border-t border-gray-200 pt-3 space-y-2">
                                <div class="text-[10px] uppercase tracking-widest text-gray-500">Share Blueprint</div>
                                <div class="flex flex-wrap gap-2">
                                    <button class="sculpture-share-button" onclick="profiler.shareBlueprint()" disabled>Share</button>
                                    <button class="sculpture-share-button" onclick="profiler.copyBlueprint()" disabled>Copy Brief</button>
                                    <button class="sculpture-share-button" onclick="profiler.downloadBlueprint()" disabled>Download</button>
                                </div>
                                <div id="sculpture-share-status" class="text-[10px] uppercase tracking-widest text-gray-500">Generate to unlock sharing.</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pt-4 border-t border-gray-200">
                <div class="font-mono text-[10px] uppercase tracking-[0.25em] text-gray-500">Continue the experience</div>
                <div class="flex flex-wrap gap-2 mt-3">
                    <button onclick="app.navigate('pitch')" class="ui-click border border-black bg-white px-3 py-2 text-[10px] font-mono uppercase tracking-widest hover:bg-black hover:text-white transition-colors">Project Brief</button>
                    <button onclick="app.navigate('gallery')" class="ui-click border border-black bg-white px-3 py-2 text-[10px] font-mono uppercase tracking-widest hover:bg-black hover:text-white transition-colors">Gallery</button>
                    <button onclick="app.navigate('grift')" class="ui-click border border-black bg-white px-3 py-2 text-[10px] font-mono uppercase tracking-widest hover:bg-black hover:text-white transition-colors">Grift Shop</button>
                    <button onclick="app.navigate('barter')" class="ui-click border border-black bg-white px-3 py-2 text-[10px] font-mono uppercase tracking-widest hover:bg-black hover:text-white transition-colors">Barter Post</button>
                </div>
            </div>
        </div>

        <!-- Quiz Modal -->
        <div id="quiz-modal" class="modal-layer">
            <div class="bg-white border border-black rounded-2xl shadow-2xl w-full max-w-3xl relative overflow-hidden">
                <div class="absolute top-3 right-3">
                    <button onclick="profiler.closeModal()" class="ui-click text-[10px] font-mono uppercase tracking-widest border border-black px-2 py-1 bg-white hover:bg-black hover:text-white">Close</button>
                </div>
                <div class="px-6 py-5 border-b border-gray-200 flex items-center justify-between">
                    <div class="font-bold uppercase tracking-widest">Identity Verification</div>
                    <div class="text-[10px] font-mono uppercase tracking-[0.25em] text-gray-500">Pop-up Deck</div>
                </div>
                <div class="p-6 space-y-8">
                    <!-- Stage 3: The Quiz -->
                    <div id="prof-stage-quiz" class="hidden w-full">
                        <div class="mb-6 border-b border-gray-200 pb-4 flex justify-between items-center">
                            <span class="font-mono text-xs uppercase tracking-widest">Question <span id="quiz-num">1</span>/<span id="quiz-total">5</span></span>
                            <span class="font-mono text-xs text-red-600 uppercase tracking-widest">Stay present</span>
                        </div>

                        <h3 class="text-2xl md:text-3xl font-bold mb-8" id="quiz-q">Question Text Here</h3>

                        <div class="space-y-3" id="quiz-options">
                            <!-- Options injected here -->
                        </div>
                    </div>

                    <!-- Stage 4: Deconstruction (Typewriter) -->
                    <div id="prof-stage-process" class="hidden text-center max-w-xl mx-auto">
                        <div class="font-mono text-sm uppercase tracking-widest space-y-4" id="decon-lines">
                            <!-- JS injects lines here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <!-- VIEW: PITCH (With Project Plan) -->
    <section id="view-pitch" class="view-section bg-[#FDFBF7]">
        <div class="max-w-4xl mx-auto px-6 py-12 pb-32">
            <div class="border-b border-black pb-6 mb-12 flex justify-between items-end">
                <div>
                    <h1 class="text-4xl font-bold uppercase tracking-widest mb-2">Project Brief</h1>
                    <p class="font-mono text-xs text-gray-500">RESTRICTED DISTRIBUTION // PARTNER BRIEFING</p>
                </div>
                <div class="flex items-center gap-3">
                    <button onclick="ticketing.open()" class="ui-click bg-black text-white px-4 py-2 text-[10px] font-mono uppercase tracking-widest hover:bg-red-600 transition-colors">3-Tier Tickets</button>
                    <button onclick="window.print()" class="hidden md:block ui-click text-xs font-mono underline hover:text-red-600">PRINT SPEC SHEET</button>
                    <a href="oldindex.html" class="ui-click text-xs font-mono underline hover:text-red-600">Launch Applets</a>
                </div>
            </div>
            
            <div class="prose prose-neutral max-w-none font-serif text-lg leading-relaxed">
                <h3 class="font-bold uppercase font-sans text-sm tracking-widest mb-4 mt-8 border-l-4 border-black pl-4">01. Executive Summary</h3>
                <p class="mb-6">
                    <strong>Domestic Product</strong> is a forensic exhibition of the 20th century's "cuteness industrial complex." By assembling a specific archive—early Disney production layouts, Oswald the Lucky Rabbit trade cards, and pre-war Japanese Menko—we trace how corporate entities engineered "magic" into a scalable, exportable commodity.
                </p>

                <h3 class="font-bold uppercase font-sans text-sm tracking-widest mb-4 mt-12 border-l-4 border-black pl-4">02. Curatorial Statement</h3>
                <p class="mb-6">
                    If media trained us to behave, what happens when we put the original production artifacts on an operating table? The exhibition intertwines historic animation art with the fictional Loomworks corporation, treating Mickey Mouse not as a character, but as an industrial asset class.
                </p>

                <!-- Project Plan -->
                <div class="mt-16 bg-white border border-black p-8 shadow-lg">
                    <h3 class="font-bold uppercase font-sans text-sm tracking-widest mb-8 border-b border-gray-200 pb-4">03. Project Plan & Specs</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                        <div>
                            <h4 class="font-mono text-xs font-bold uppercase text-red-600 mb-2">Exhibition Requirements</h4>
                            <ul class="text-sm font-mono space-y-2 text-gray-700">
                                <li class="flex justify-between border-b border-dashed border-gray-300 pb-1"><span>Space</span> <span>1,200 - 2,500 sq ft</span></li>
                                <li class="flex justify-between border-b border-dashed border-gray-300 pb-1"><span>Wall Linear Ft</span> <span>Min 150ft</span></li>
                                <li class="flex justify-between border-b border-dashed border-gray-300 pb-1"><span>Lighting</span> <span>Low-UV, Spot Rail</span></li>
                                <li class="flex justify-between border-b border-dashed border-gray-300 pb-1"><span>Power</span> <span>4x 20A Circuits</span></li>
                            </ul>
                        </div>
                        <div>
                            <h4 class="font-mono text-xs font-bold uppercase text-red-600 mb-2">Fabrication Needs</h4>
                            <ul class="text-sm font-mono space-y-2 text-gray-700">
                                <li class="flex justify-between border-b border-dashed border-gray-300 pb-1"><span>Display Cases</span> <span>6x Vitrines (Locking)</span></li>
                                <li class="flex justify-between border-b border-dashed border-gray-300 pb-1"><span>Scenography</span> <span>"Soft Lab" aesthetics</span></li>
                                <li class="flex justify-between border-b border-dashed border-gray-300 pb-1"><span>Barter Post</span> <span>Custom joinery desk</span></li>
                            </ul>
                        </div>
                    </div>

                    <div class="mb-8">
                        <h4 class="font-mono text-xs font-bold uppercase text-red-600 mb-2">Staffing Matrix</h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-xs font-mono">
                            <div class="bg-gray-50 p-3 border border-gray-200">
                                <strong class="block mb-1">1x Floor Manager</strong>
                                <span class="text-gray-500">Ops, Sales, Security</span>
                            </div>
                            <div class="bg-gray-50 p-3 border border-gray-200">
                                <strong class="block mb-1">2x "Lanterns"</strong>
                                <span class="text-gray-500">Performative Docents</span>
                            </div>
                            <div class="bg-gray-50 p-3 border border-gray-200">
                                <strong class="block mb-1">1x Barter Clerk</strong>
                                <span class="text-gray-500">Trade Negotiation</span>
                            </div>
                        </div>
                    </div>

                    <div>
                        <h4 class="font-mono text-xs font-bold uppercase text-red-600 mb-2">Deployment Timeline</h4>
                        <div class="space-y-4 text-xs font-mono border-l border-black pl-4 ml-1">
                            <div class="relative"><div class="absolute -left-[21px] top-1 w-2 h-2 bg-black rounded-full"></div><span class="font-bold">PHASE 1: ACQUISITION</span><br><span class="text-gray-500">Identifying assets, securing loans (Henson/MoMI), auction verification.</span></div>
                            <div class="relative"><div class="absolute -left-[21px] top-1 w-2 h-2 bg-gray-300 rounded-full"></div><span class="font-bold">PHASE 2: FABRICATION</span><br><span class="text-gray-500">Voxel scaffolding build, framing, print production.</span></div>
                            <div class="relative"><div class="absolute -left-[21px] top-1 w-2 h-2 bg-gray-300 rounded-full"></div><span class="font-bold">PHASE 3: INSTALL</span><br><span class="text-gray-500">3-day onsite build. Lighting focus. Lantern training.</span></div>
                            <div class="relative"><div class="absolute -left-[21px] top-1 w-2 h-2 bg-gray-300 rounded-full"></div><span class="font-bold">PHASE 4: LIVE OPS</span><br><span class="text-gray-500">3-week engagement. Live barter transactions.</span></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-12 pt-6 border-t border-gray-200">
                <div class="font-mono text-[10px] uppercase tracking-[0.25em] text-gray-500">Flow from here</div>
                <div class="flex flex-wrap gap-2 mt-3">
                    <button onclick="app.navigate('gallery')" class="ui-click border border-black bg-white px-3 py-2 text-[10px] font-mono uppercase tracking-widest hover:bg-black hover:text-white transition-colors">Gallery</button>
                    <button onclick="app.navigate('protocol')" class="ui-click border border-black bg-white px-3 py-2 text-[10px] font-mono uppercase tracking-widest hover:bg-black hover:text-white transition-colors">Lantern Protocol</button>
                    <button onclick="app.navigate('grift')" class="ui-click border border-black bg-white px-3 py-2 text-[10px] font-mono uppercase tracking-widest hover:bg-black hover:text-white transition-colors">Grift Shop</button>
                    <button onclick="app.navigate('barter')" class="ui-click border border-black bg-white px-3 py-2 text-[10px] font-mono uppercase tracking-widest hover:bg-black hover:text-white transition-colors">Barter Post</button>
                </div>
            </div>
        </div>
    </section>

    <!-- VIEW: GRIFT SHOP (Mini Game) -->
    <section id="view-grift" class="view-section bg-gray-100 min-h-screen">
        <div class="max-w-6xl mx-auto px-4 py-8 h-full flex flex-col md:flex-row gap-8">
            <!-- Left: Editor -->
            <div class="flex-1 bg-white p-6 border border-black shadow-lg">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="font-bold uppercase tracking-widest text-lg">The Grift Shop</h2>
                    <div class="text-xs font-mono text-gray-500">Produce. Submit. Comply.</div>
                </div>
                
                <div id="editor-ui">
                    <div class="pixel-grid mb-6" id="pixel-grid"></div>
                    <div class="flex gap-2 mb-6">
                        <div class="w-8 h-8 bg-black cursor-pointer border border-gray-300" onclick="grift.setColor('#000000')"></div>
                        <div class="w-8 h-8 bg-red-600 cursor-pointer border border-gray-300" onclick="grift.setColor('#CD2B2B')"></div>
                        <div class="w-8 h-8 bg-gray-400 cursor-pointer border border-gray-300" onclick="grift.setColor('#9CA3AF')"></div>
                        <div class="w-8 h-8 bg-white cursor-pointer border border-gray-300" onclick="grift.setColor('#FFFFFF')"></div>
                        <div class="w-8 h-8 bg-yellow-400 cursor-pointer border border-gray-300" onclick="grift.setColor('#FACC15')"></div>
                    </div>
                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-6">
                        <div class="flex items-start justify-between gap-3 mb-3">
                            <div>
                                <div class="text-[10px] font-mono uppercase tracking-widest text-gray-500">Processing Style</div>
                                <p class="text-xs text-gray-600">Decide how the submission is minted and displayed.</p>
                            </div>
                            <div class="text-[10px] font-mono text-gray-500" id="style-note">Abstracts clusters with organic blur + noise.</div>
                        </div>
                        <div class="grid sm:grid-cols-3 gap-3 text-[12px] font-mono">
                            <label class="flex items-start gap-2 bg-white border border-gray-200 p-3 cursor-pointer hover:border-black">
                                <input type="radio" name="grift-style" value="abstracted" class="mt-1" checked onchange="grift.setStyle('abstracted')">
                                <span><span class="font-bold uppercase">Abstracted</span><br>Pixel clusters become organic glyphs.</span>
                            </label>
                            <label class="flex items-start gap-2 bg-white border border-gray-200 p-3 cursor-pointer hover:border-black">
                                <input type="radio" name="grift-style" value="grid" class="mt-1" onchange="grift.setStyle('grid')">
                                <span><span class="font-bold uppercase">Pixel Grid</span><br>Sold framed with visible grid + line weight.</span>
                            </label>
                            <label class="flex items-start gap-2 bg-white border border-gray-200 p-3 cursor-pointer hover:border-black">
                                <input type="radio" name="grift-style" value="flat" class="mt-1" onchange="grift.setStyle('flat')">
                                <span><span class="font-bold uppercase">Flat Merge</span><br>Pixels fused into a single plate print.</span>
                            </label>
                        </div>
                    </div>
                    <button onclick="grift.submit()" class="w-full bg-black text-white py-3 font-mono text-sm uppercase hover:bg-red-600 transition-colors">Submit Work to Gallery</button>
                </div>

                <div id="gallery-sim" class="hidden h-full flex-col relative">
                    <div class="flex-1 bg-[#FDFBF7] border border-black p-4 relative overflow-hidden" id="wall-display">
                        <div id="hanging-art" class="w-32 h-32 border-4 border-black bg-white shadow-xl mx-auto mt-8 transform transition-transform duration-1000"></div>
                        <div id="attendee-row" class="absolute bottom-2 left-0 right-0 flex justify-center gap-6 pointer-events-none"></div>
                        <div class="absolute bottom-0 w-full flex justify-center gap-4 items-end">
                            <div class="w-8 h-16 bg-black opacity-80"></div>
                            <div class="w-8 h-14 bg-black opacity-80"></div>
                            <div class="w-8 h-18 bg-black opacity-80"></div>
                        </div>
                    </div>
                    <div class="mt-4 p-4 bg-black text-green-500 font-mono text-xs h-32 overflow-y-auto" id="event-log">
                        > UPLOADING TO LOOMWORKS DATABASE...<br>> VERIFYING ASSET...<br>
                    </div>
                </div>
            </div>

            <!-- Right: Dashboard -->
            <div class="w-full md:w-80 flex flex-col gap-4">
                <div class="bg-white p-4 border border-black shadow-md">
                    <h3 class="text-xs font-bold uppercase tracking-widest text-gray-400 mb-1">Loomworks Lifetime Value</h3>
                    <div class="text-3xl font-mono font-bold text-green-600" id="total-val">$0.00</div>
                </div>
                <div class="bg-white p-4 border border-black shadow-md">
                    <h3 class="text-xs font-bold uppercase tracking-widest text-gray-400 mb-1">Artist Royalty (0.006%)</h3>
                    <div class="text-xl font-mono font-bold text-gray-800" id="user-val">$0.00</div>
                </div>
                <div class="bg-white p-4 border border-black shadow-md">
                    <h3 class="text-xs font-bold uppercase tracking-widest text-gray-400 mb-1">Economic Horror Logic</h3>
                    <p class="text-xs font-mono text-gray-600 leading-relaxed">Lifetime Value accelerates; your royalty is frozen at 0.006%. Compare the delta as the wall fills.</p>
                </div>
                <button id="accel-btn" onclick="grift.accelerate()" class="bg-red-600 text-white py-4 font-bold uppercase tracking-widest shadow-lg hover:bg-red-700 active:scale-95 transition-all opacity-50 cursor-not-allowed" disabled>Accelerate Market</button>
            </div>
        </div>

        <div class="max-w-6xl mx-auto px-4 pb-12">
            <div class="pt-6 mt-6 border-t border-gray-300">
                <div class="font-mono text-[10px] uppercase tracking-[0.25em] text-gray-500">Branch out</div>
                <div class="flex flex-wrap gap-2 mt-3">
                    <button onclick="app.navigate('barter')" class="ui-click border border-black bg-white px-3 py-2 text-[10px] font-mono uppercase tracking-widest hover:bg-black hover:text-white transition-colors">Barter Post</button>
                    <button onclick="app.navigate('gallery')" class="ui-click border border-black bg-white px-3 py-2 text-[10px] font-mono uppercase tracking-widest hover:bg-black hover:text-white transition-colors">Gallery</button>
                    <button onclick="app.navigate('pitch')" class="ui-click border border-black bg-white px-3 py-2 text-[10px] font-mono uppercase tracking-widest hover:bg-black hover:text-white transition-colors">Project Brief</button>
                </div>
            </div>
        </div>
    </section>

    <!-- VIEW: PROTOCOL (LANTERNS) -->
    <section id="view-protocol" class="view-section bg-[#FDFBF7]">
        <div class="max-w-4xl mx-auto px-6 py-12 pb-32">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-end border-b-2 border-red-600 pb-4 mb-12">
                <div>
                    <h1 class="text-4xl md:text-5xl font-bold uppercase tracking-tighter">Lantern Protocol</h1>
                    <div class="font-mono text-xs text-red-600 mt-2 uppercase tracking-widest">Document No. HR-902 // CASTING & PERFORMANCE</div>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-12 gap-12">
                <div class="md:col-span-8 space-y-8">
                    <p class="font-serif text-lg leading-relaxed">
                        Lanterns are the human interfaces of Loomworks. They are not security guards, and they are not museum docents. They are witnesses. They stand between longing and duty. They are, very literally, the light behind glass and steel.
                    </p>

                    <div class="bg-white border border-gray-200 p-8 shadow-md relative overflow-hidden">
                        <div class="absolute top-0 right-0 bg-red-600 text-white text-[10px] font-mono px-2 py-1">DOCUMENT NO. HR-902</div>
                        <h3 class="font-bold font-mono text-sm uppercase mb-6 text-gray-400">Lantern Protocol & Casting Sheet</h3>
                        <div class="font-serif text-base md:text-lg leading-relaxed space-y-4">
                            <p class="italic">"You're embodying a hundred years of women that were constrained and contorted into compliance by systems they had no say in while being told you had to be stronger than their bars. You're their pressure cracking at the seams, making a bid while fearing getting 'caught' by your own construct."</p>
                            <p>"You are power in restraint, you are the voice through silence and sadness, and you are ambassadors in understanding that none of us asked for any of this. You're every woman who was asked to smile more and unfairly felt they had to. You're exhausted yet hopeful. You're not desperate - but are vying for connection in a window of disorientation you know is bound to close. A light behind glass and steel. And you are a Lantern."</p>
                        </div>
                    </div>

                    <div class="bg-white border border-gray-200 p-8 shadow-md relative overflow-hidden">
                        <div class="absolute top-0 right-0 bg-red-600 text-white text-[10px] font-mono px-2 py-1">SCRIPTED INTERACTION 01</div>
                        <h3 class="font-bold font-mono text-sm uppercase mb-6 text-gray-400">Context: Guest Interaction</h3>
                        <div class="font-serif text-xl leading-relaxed space-y-4">
                            <p>Trigger: guest asks <span class="italic text-gray-500">"Are you okay?"</span></p>
                            <p>Response: <span class="font-bold text-red-600">"Just super!"</span></p>
                            <p class="text-sm font-mono text-gray-400 pt-2">(Bright, slightly too loud. Smile with teeth. Do not blink.)</p>
                        </div>
                    </div>

                    <div class="bg-white border border-gray-200 p-8 shadow-md relative overflow-hidden">
                        <div class="absolute top-0 right-0 bg-red-600 text-white text-[10px] font-mono px-2 py-1">SCRIPTED INTERACTION 02</div>
                        <h3 class="font-bold font-mono text-sm uppercase mb-6 text-gray-400">Context: Specimen Care</h3>
                        <div class="font-serif text-xl leading-relaxed space-y-4">
                            <p>Trigger: guest touches artwork.</p>
                            <p>Response: <span class="font-bold text-red-600">"We prefer to let the specimens breathe on their own."</span></p>
                            <p class="text-sm font-mono text-gray-400 pt-2">(Extend palm; guide gaze away from the piece.)</p>
                        </div>
                    </div>

                    <div class="bg-white border border-gray-200 p-8 shadow-md relative overflow-hidden">
                        <div class="absolute top-0 right-0 bg-red-600 text-white text-[10px] font-mono px-2 py-1">BEHAVIOR MODULE</div>
                        <h3 class="font-bold font-mono text-sm uppercase mb-6 text-gray-400">Polaroid &amp; Toki Pona Protocol</h3>
                        <div class="font-serif text-lg leading-relaxed space-y-4">
                            <p>Purpose: archive the guest while signaling Loomworks’ selective memory. The ritual must feel procedural, protective, and quietly affectionate.</p>
                            <div class="space-y-3">
                                <p class="font-mono text-xs uppercase tracking-widest text-gray-500">Polaroid Moment</p>
                                <ul class="list-disc list-inside text-base space-y-2 text-gray-800">
                                    <li>Approach with measured posture; lift the camera as a tool of record. Offer: <span class="italic">“Please hold still for your Archive Entry.”</span></li>
                                    <li>Capture the image. Read the print as if interpreting an omen. Initial the back and add a symbol unique to the performer (triangle, paired dots, bow mark, barcode scratch, tally set).</li>
                                    <li>Hand it over with reverence. Whisper: <span class="italic">“Do not lose this. Loomworks remembers.”</span></li>
                                    <li>Symbols should remain consistent per Lantern to allow guests to notice patterns across the run.</li>
                                </ul>
                            </div>
                            <div class="space-y-3">
                                <p class="font-mono text-xs uppercase tracking-widest text-gray-500">Toki Pona Shift</p>
                                <ul class="list-disc list-inside text-base space-y-2 text-gray-800">
                                    <li>Slide into Toki Pona without announcement. Maintain calm, service-forward tone. Sample anchors: <span class="italic">“pona!”</span> (good), <span class="italic">“mi lukin e sina.”</span> (I see you), <span class="italic">“o tawa mi.”</span> (come with me).</li>
                                    <li>Use the language to keep interactions minimal and meditative. When asked for directions, gesture deliberately and offer: <span class="italic">“o tawa sona. tawa musi.”</span></li>
                                    <li>Allow the constraint of the vocabulary to create gentle friction; avoid apologizing for the shift.</li>
                                </ul>
                            </div>
                            <div class="space-y-3">
                                <p class="font-mono text-xs uppercase tracking-widest text-gray-500">Combined Moment</p>
                                <ul class="list-disc list-inside text-base space-y-2 text-gray-800">
                                    <li>After the Polaroid develops, study it and speak softly in Toki Pona: <span class="italic">“sina jo e ilo lawa.”</span> (You have the controlling tool.)</li>
                                    <li>Alternatively: <span class="italic">“mi sona e sina. seli li lon sina.”</span> (I know you. The fire is in you.) Hand back the print as if it is a credential.</li>
                                    <li>Guests should feel archived, welcomed, and subtly tasked with protecting what they were just given.</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="mt-12 p-8 bg-black text-white text-center">
                        <h3 class="font-mono text-xs uppercase tracking-widest mb-4">Interest in Participation?</h3>
                        <p class="font-serif italic text-gray-400 mb-6 max-w-md mx-auto">"You contain a soft light under pressure."</p>
                        <button onclick="gallery.launchLanternOverlay()" class="ui-click bg-white text-black px-8 py-3 font-bold uppercase tracking-widest hover:bg-red-600 hover:text-white transition-colors">
                            Initiate 3D Visualization
                        </button>
                    </div>
                </div>

                <div class="md:col-span-4 border-l border-gray-200 pl-8">
                    <h4 class="font-bold text-xs uppercase tracking-widest mb-4">Uniform Specs</h4>
                    <ul class="font-mono text-xs space-y-4 text-gray-600">
                        <li>• Beige/Cream Boiler Suit (Tailored)</li>
                        <li>• Black Skirt layered under utilitarian top</li>
                        <li>• Black flats (silent tread)</li>
                        <li>• "Loomworks" Patch/Pin on left breast</li>
                        <li>• Red accessory anchored near heartline</li>
                    </ul>

                    <h4 class="font-bold text-xs uppercase tracking-widest mt-8 mb-4">Idling Behaviors</h4>
                    <ul class="font-mono text-xs space-y-3 text-gray-600">
                        <li>• Adjusting cuffs unnecessarily.</li>
                        <li>• Staring 15 degrees above the horizon.</li>
                        <li>• Checking watch, then shaking wrist.</li>
                        <li>• Humming "A Dream Is A Wish Your Heart Makes" (off-key).</li>
                    </ul>
                </div>
            </div>

            <div class="mt-12 pt-6 border-t border-gray-200">
                <div class="font-mono text-[10px] uppercase tracking-[0.25em] text-gray-500">Move through the system</div>
                <div class="flex flex-wrap gap-2 mt-3">
                    <button onclick="app.navigate('gallery')" class="ui-click border border-black bg-white px-3 py-2 text-[10px] font-mono uppercase tracking-widest hover:bg-black hover:text-white transition-colors">Gallery</button>
                    <button onclick="app.navigate('barter')" class="ui-click border border-black bg-white px-3 py-2 text-[10px] font-mono uppercase tracking-widest hover:bg-black hover:text-white transition-colors">Barter Post</button>
                    <button onclick="app.navigate('pitch')" class="ui-click border border-black bg-white px-3 py-2 text-[10px] font-mono uppercase tracking-widest hover:bg-black hover:text-white transition-colors">Project Brief</button>
                    <button onclick="app.navigate('profiler')" class="ui-click border border-black bg-white px-3 py-2 text-[10px] font-mono uppercase tracking-widest hover:bg-black hover:text-white transition-colors">Identity</button>
                </div>
            </div>
        </div>
    </section>

    <!-- VIEW: TEAM (MEET THE LANTERN CAST) -->
    <section id="view-team" class="view-section bg-[#FDFBF7]">
        <div class="max-w-6xl mx-auto px-6 py-12 pb-28 space-y-10">
            <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-6 border-b-2 border-black pb-6">
                <div class="space-y-2">
                    <div class="inline-flex items-center gap-2 border border-black px-3 py-1 text-[10px] font-mono uppercase tracking-widest bg-white">Loomworks Field Materials</div>
                    <h1 class="text-4xl md:text-5xl font-bold uppercase tracking-tight">Meet the Team — Lantern Cast</h1>
                    <p class="font-mono text-xs text-gray-600 uppercase tracking-widest">Canonical reference • Casting companion to the Lantern Protocol</p>
                </div>
                <div class="flex flex-wrap gap-3">
                    <button onclick="app.navigate('protocol')" class="ui-click border border-black bg-white px-3 py-2 text-[10px] font-mono uppercase tracking-widest hover:bg-black hover:text-white transition-colors">Protocol / Casting Page</button>
                    <button onclick="ticketing.open()" class="ui-click bg-black text-white px-3 py-2 text-[10px] font-mono uppercase tracking-widest hover:bg-red-600 transition-colors">3-Tier Tickets</button>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="md:col-span-2 bg-white border border-gray-200 p-6 shadow-md space-y-4">
                    <h3 class="font-mono text-xs uppercase tracking-widest text-red-700">Purpose of the Lantern Cast</h3>
                    <p class="font-serif text-lg leading-relaxed">The Lanterns are the living interface of Loomworks — hosts, guides, statues come to life, bureaucratic archetypes, and the embodied design language that keeps the fiction stable.</p>
                    <p class="font-mono text-sm text-gray-700 leading-relaxed">They anchor the visitor emotionally, rhetorically, and spatially. The work is to make the fiction feel real enough to fear without ever lapsing into menace.</p>
                    <div class="grid sm:grid-cols-2 gap-3">
                        <div class="bg-[#FDFBF7] border border-gray-200 rounded-lg p-3">
                            <div class="font-bold uppercase text-xs tracking-widest mb-2">Functions</div>
                            <ul class="list-disc list-inside text-sm space-y-1 text-gray-700">
                                <li>Host arrivals and guide orientation</li>
                                <li>Carry the ritual script and gestures</li>
                                <li>Translate the bureaucracy of value and cost</li>
                                <li>Hold space as statues that occasionally breathe</li>
                            </ul>
                        </div>
                        <div class="bg-[#FDFBF7] border border-gray-200 rounded-lg p-3">
                            <div class="font-bold uppercase text-xs tracking-widest mb-2">Tone Ceiling</div>
                            <p class="text-sm text-gray-700 leading-relaxed">Friendly but uncanny. Soft-spoken yet articulate. Polite, but never fully informal — a museum docent meets an NPC meets a flight attendant from the future.</p>
                        </div>
                    </div>
                </div>
                <div class="bg-black text-white p-6 rounded-xl shadow-lg space-y-4">
                    <div class="text-[10px] font-mono uppercase tracking-[0.3em] text-gray-300">System Axes</div>
                    <div class="space-y-3 text-sm">
                        <div class="border border-white/20 rounded-lg p-3">
                            <div class="flex justify-between text-xs uppercase tracking-widest text-gray-300"><span>Lantern</span><span>Axis</span></div>
                            <div class="font-bold text-lg">Here</div>
                            <p class="text-gray-200">Orientation • Warm, grounding<br><span class="text-gray-400">“You are entering the threshold.”</span></p>
                        </div>
                        <div class="border border-white/20 rounded-lg p-3">
                            <div class="flex justify-between text-xs uppercase tracking-widest text-gray-300"><span>Lantern</span><span>Axis</span></div>
                            <div class="font-bold text-lg">Now</div>
                            <p class="text-gray-200">Attention • Crisp, precise<br><span class="text-gray-400">“Remain present; follow the steps.”</span></p>
                        </div>
                        <div class="border border-white/20 rounded-lg p-3">
                            <div class="flex justify-between text-xs uppercase tracking-widest text-gray-300"><span>Lantern</span><span>Axis</span></div>
                            <div class="font-bold text-lg">Nicol</div>
                            <p class="text-gray-200">Value • Gentle accounting<br><span class="text-gray-400">“Objects move through us; value circulates.”</span></p>
                        </div>
                        <div class="border border-white/20 rounded-lg p-3">
                            <div class="flex justify-between text-xs uppercase tracking-widest text-gray-300"><span>Lantern</span><span>Axis</span></div>
                            <div class="font-bold text-lg">Dime</div>
                            <p class="text-gray-200">Cost • Playful austerity<br><span class="text-gray-400">“Everything has a price, but not the one you expect.”</span></p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white border border-gray-200 p-6 shadow-md space-y-4">
                    <h3 class="font-mono text-xs uppercase tracking-widest text-red-700">Baseline Criteria</h3>
                    <ul class="space-y-4 text-sm text-gray-800">
                        <li><span class="font-bold uppercase tracking-widest text-[11px]">Presence</span><br>A calm, centered performance style. Movements are deliberate and economical.</li>
                        <li><span class="font-bold uppercase tracking-widest text-[11px]">Aesthetic Fit</span><br>Reads cleanly in the Loomworks uniform: white sailor top with black trim, black skirt or trousers, black ribbon bow, white gloves (always on), Lantern badge and lanyard.</li>
                        <li><span class="font-bold uppercase tracking-widest text-[11px]">Performance Texture</span><br>Friendly but uncanny; polite without casualness; ritual over conversation.</li>
                        <li><span class="font-bold uppercase tracking-widest text-[11px]">Vocal Requirements</span><br>Clear diction, calm tone, and the ability to hold intentional silence without breaking character.</li>
                        <li><span class="font-bold uppercase tracking-widest text-[11px]">Stamina</span><br>Comfortable maintaining presence for 3–4 hour shifts. Rotations follow the Idling Protocol.</li>
                    </ul>
                </div>
                <div class="bg-white border border-gray-200 p-6 shadow-md space-y-4">
                    <h3 class="font-mono text-xs uppercase tracking-widest text-red-700">Appearance & Costume Standards</h3>
                    <ul class="list-disc list-inside text-sm text-gray-800 space-y-2">
                        <li>Hair neat, tied back, or symmetrical</li>
                        <li>Minimal jewelry (stud earrings acceptable)</li>
                        <li>No nail color visible through gloves</li>
                        <li>Uniform pressed; shoes black, silent, comfortable</li>
                        <li>ID badge centered on chest; gloves stay on</li>
                    </ul>
                    <p class="text-sm text-gray-700">Uniform is a signal, not a costume. It represents a role, not an identity.</p>
                </div>
            </div>

            <div class="bg-white border border-gray-200 p-6 shadow-md rounded-xl">
                <h3 class="font-mono text-xs uppercase tracking-widest text-red-700 mb-4">Individual Roles</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="border border-gray-200 rounded-lg p-4 bg-[#FDFBF7] space-y-2">
                        <div class="text-[10px] font-mono uppercase tracking-widest text-gray-600">🕯️ Here</div>
                        <div class="font-bold text-lg">Greeter — arrival embodied</div>
                        <p class="text-sm text-gray-700">Tone: warm, neutral, slightly curious. Uses phrases like “You are here,” “Right this way,” “This will make sense soon.”</p>
                        <p class="text-xs text-gray-600">Casting: natural gentleness and grounded energy.</p>
                    </div>
                    <div class="border border-gray-200 rounded-lg p-4 bg-[#FDFBF7] space-y-2">
                        <div class="text-[10px] font-mono uppercase tracking-widest text-gray-600">🕯️ Now</div>
                        <div class="font-bold text-lg">Tempo Manager — attention keeper</div>
                        <p class="text-sm text-gray-700">Tone: crisp, present, lightly authoritative. Moves guests through stations and keeps the steps crisp without revealing “the point.”</p>
                        <p class="text-xs text-gray-600">Casting: clarity in gaze and voice; stage-manager energy.</p>
                    </div>
                    <div class="border border-gray-200 rounded-lg p-4 bg-[#FDFBF7] space-y-2">
                        <div class="text-[10px] font-mono uppercase tracking-widest text-gray-600">🕯️ Nicol</div>
                        <div class="font-bold text-lg">Evaluator — value interpreter</div>
                        <p class="text-sm text-gray-700">Tone: soft bureaucratic warmth. Oversees Barter Post rituals, receives items with care, and speaks in value metaphors.</p>
                        <p class="text-xs text-gray-600">Casting: understated humor and extremely precise hands.</p>
                    </div>
                    <div class="border border-gray-200 rounded-lg p-4 bg-[#FDFBF7] space-y-2">
                        <div class="text-[10px] font-mono uppercase tracking-widest text-gray-600">🕯️ Dime</div>
                        <div class="font-bold text-lg">Cost Analyst — playful austerity</div>
                        <p class="text-sm text-gray-700">Tone: cheerful but deadpan. Tracks scores, tallies, and cost-of-attention measurements with a small clipboard prop.</p>
                        <p class="text-xs text-gray-600">Casting: delivers dry lines with charm.</p>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="md:col-span-2 bg-white border border-gray-200 p-6 shadow-md space-y-4">
                    <h3 class="font-mono text-xs uppercase tracking-widest text-red-700">Performance Protocols</h3>
                    <ol class="list-decimal list-inside space-y-2 text-sm text-gray-800">
                        <li><span class="font-bold">Lantern Protocol</span>: How to greet, how to fix and resume control, how to hand off between Lanterns.</li>
                        <li><span class="font-bold">Idling Protocol</span>: Approved idle poses, tilted-head rest stance, breathing and micro-movements during downtime.</li>
                        <li><span class="font-bold">Station Protocols</span>: Barter Post, Pachinko, Grift Shop interactions, Identity Assessment flow.</li>
                        <li><span class="font-bold">Emotional Boundaries</span>: Visitors project narratives; Lanterns stay gracious but inscrutable with no colloquial breaks.</li>
                    </ol>
                    <p class="font-mono text-xs uppercase tracking-widest text-gray-500">Visitors feel watched, not judged. The system feels alive, not hostile.</p>
                </div>
                <div class="bg-[#FDFBF7] border border-black/10 p-6 shadow-inner space-y-3">
                    <h3 class="font-mono text-xs uppercase tracking-widest text-red-700">Cast Rotation</h3>
                    <p class="text-sm text-gray-800 leading-relaxed">Two Lanterns on floor at all times. One Lantern idling. One Lantern offstage prepping. Rhythm first, overwork never.</p>
                    <div class="bg-white border border-gray-200 rounded-lg p-3 text-xs font-mono uppercase tracking-widest text-gray-700">Rotation cadence keeps the world alive.</div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white border border-gray-200 p-6 shadow-md space-y-3">
                    <h3 class="font-mono text-xs uppercase tracking-widest text-red-700">Required Reading</h3>
                    <p class="text-sm text-gray-800">Prospective performers must review the full protocol stack:</p>
                    <ul class="list-disc list-inside text-sm text-gray-800 space-y-1">
                        <li>Lantern Training Manual</li>
                        <li>Break & Fix Protocol</li>
                        <li>Idling Protocol</li>
                        <li>Station Procedures Guide</li>
                        <li>Uniform & Badge Specifications</li>
                    </ul>
                    <p class="text-xs text-gray-600">Auditions demonstrate controlled gesture, micro-expression discipline, and delivery in the Loomworks tone.</p>
                    <div class="pt-2">
                        <button onclick="app.navigate('protocol')" class="ui-click border border-black bg-white px-3 py-2 text-[10px] font-mono uppercase tracking-widest hover:bg-black hover:text-white transition-colors">Open Casting Protocol</button>
                    </div>
                </div>
                <div class="bg-black text-white p-6 shadow-lg space-y-3 rounded-xl">
                    <h3 class="font-mono text-xs uppercase tracking-widest text-gray-300">Cast Vibe Summary</h3>
                    <p class="text-sm text-gray-100 leading-relaxed">Wes Anderson clerks. Disney park attendants from another timeline. NPCs you trust immediately but can’t quite understand. The boundary between visitor and world.</p>
                    <p class="text-sm text-gray-200">Lanterns are ritual actors, not characters. They lend the installation humanness and uncanny gravity simultaneously.</p>
                </div>
            </div>
        </div>
    </section>

    <!-- VIEW: BARTER (MERCH SHOP) -->
    <section id="view-barter" class="view-section bg-grid min-h-screen">
        <div class="max-w-6xl mx-auto px-6 py-12 pb-32">
            <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-6 border-b-2 border-black pb-6 mb-12">
                <div>
                    <h1 class="text-4xl md:text-5xl font-bold uppercase tracking-tighter">The Barter Post</h1>
                    <div class="font-mono text-xs text-gray-500 mt-2 uppercase tracking-widest">Dual-mode: webshop + investor catalog // Economic transparency baked in</div>
                </div>
                <div class="flex flex-wrap gap-2">
                    <button id="barter-shop-btn" class="ui-click border border-black bg-white px-3 py-2 text-[10px] font-mono uppercase tracking-widest hover:bg-black hover:text-white transition-colors">Shopfront Mode</button>
                    <button id="barter-transparency-btn" class="ui-click border border-black bg-white px-3 py-2 text-[10px] font-mono uppercase tracking-widest hover:bg-black hover:text-white transition-colors">Transparency Mode</button>
                </div>
            </div>

            <div class="mb-8">
                <div class="inline-flex items-center gap-2 bg-white border border-gray-300 px-4 py-2 rounded-full shadow-sm font-mono text-[10px] uppercase tracking-widest">Barter grid auto-builds from JSON // Stream + inventory aware</div>
                <p class="text-sm text-gray-700 mt-3">Toggle between the public-facing shop and investor-facing transparency view. Costs, projected margins, and inventory bands render instantly from the dataset.</p>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6" id="barter-grid">
                <!-- JS injects the SKU grid here -->
            </div>

            <div class="mt-12 grid grid-cols-1 lg:grid-cols-3 gap-6" id="barter-stream-grid">
                <!-- Revenue stream cards injected here -->
            </div>

            <div class="mt-12 border-t border-gray-200 pt-10">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold uppercase tracking-tight">Bundles &amp; Kits</h3>
                    <span class="font-mono text-[10px] uppercase tracking-[0.25em] text-gray-500">Attach-rate multipliers // curated stacks</span>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="barter-bundle-grid"></div>
            </div>

            <div class="mt-12 border-t border-gray-200 pt-10">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold uppercase tracking-tight">Activity Map</h3>
                    <span class="font-mono text-[10px] uppercase tracking-[0.25em] text-gray-500">Includes Pachinko Machine • Take 1 / Leave 2 Station • IRL Grift Shop</span>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="barter-activity-grid"></div>
            </div>

            <div class="mt-12 pt-6 border-t border-gray-200">
                <div class="font-mono text-[10px] uppercase tracking-[0.25em] text-gray-500">Keep moving</div>
                <div class="flex flex-wrap gap-2 mt-3">
                    <button onclick="app.navigate('gallery')" class="ui-click border border-black bg-white px-3 py-2 text-[10px] font-mono uppercase tracking-widest hover:bg-black hover:text-white transition-colors">Gallery</button>
                    <button onclick="app.navigate('grift')" class="ui-click border border-black bg-white px-3 py-2 text-[10px] font-mono uppercase tracking-widest hover:bg-black hover:text-white transition-colors">Grift Shop</button>
                    <button onclick="app.navigate('protocol')" class="ui-click border border-black bg-white px-3 py-2 text-[10px] font-mono uppercase tracking-widest hover:bg-black hover:text-white transition-colors">Lantern Protocol</button>
                    <a href="oldindex.html" class="ui-click border border-black bg-white px-3 py-2 text-[10px] font-mono uppercase tracking-widest hover:bg-black hover:text-white transition-colors">Referrer Launch</a>
                </div>
            </div>
        </div>
    </section>

    <!-- Ticketing Modal (3 Price Tiers) -->
    <div id="ticketing-modal" class="modal-layer">
        <div class="bg-white border border-black rounded-2xl shadow-2xl w-full max-w-4xl relative overflow-hidden">
            <div class="absolute top-3 right-3">
                <button onclick="ticketing.close()" class="ui-click text-[10px] font-mono uppercase tracking-widest border border-black px-2 py-1 bg-white hover:bg-black hover:text-white">Close</button>
            </div>
            <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
                <div class="font-bold uppercase tracking-widest">Ticketing — Three Tier Pop-Up</div>
                <div class="text-[10px] font-mono uppercase tracking-[0.25em] text-gray-500">Signal • Lantern • Investor</div>
            </div>
            <div class="p-6 space-y-6">
                <p class="text-sm text-gray-700">Choose your entry path. Every tier includes access to the Pachinko Machine and the Take 1 / Leave 2 station; higher tiers unlock transparency overlays and investor catalog tools.</p>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4" id="ticketing-tiers"></div>
            </div>
        </div>
    </div>

    <!-- VIEW: ARCHIVE INDEX -->
    <section id="view-archive" class="view-section bg-[#FDFBF7] min-h-screen">
        <div class="max-w-6xl mx-auto px-6 py-16">
            <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-6 mb-10">
                <div>
                    <div class="inline-flex items-center gap-2 border border-black px-3 py-1 text-[10px] font-mono uppercase tracking-widest bg-white">Unmanufactured Collection</div>
                    <h1 class="text-4xl md:text-5xl font-bold uppercase tracking-tight mt-4">Archive Index</h1>
                    <p class="font-mono text-sm text-gray-700 mt-3 max-w-2xl">Chronological, clean, no-commentary ledger of the complete inventory. Entries pull directly from a modular JSON file for easy expansion.</p>
                </div>
                <div class="bg-white border border-black px-4 py-3 shadow-sm flex flex-col gap-2 min-w-[240px]">
                    <div class="flex items-center justify-between text-xs font-mono uppercase tracking-widest">
                        <span class="text-gray-500">Items</span>
                        <span id="archive-count" class="font-bold text-black">--</span>
                    </div>
                    <div class="flex items-center justify-between text-xs font-mono uppercase tracking-widest">
                        <span class="text-gray-500">Eras</span>
                        <span id="archive-era-count" class="font-bold text-black">--</span>
                    </div>
                    <div class="flex items-center justify-between text-[10px] font-mono uppercase tracking-[0.2em] text-gray-600 border-t border-gray-200 pt-2">
                        <span>Updated</span>
                        <span id="archive-updated" class="font-semibold text-red-600">--</span>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="bg-white border border-black shadow-sm p-6 flex flex-col gap-4">
                    <div>
                        <h3 class="font-mono text-xs uppercase tracking-widest text-gray-500">Single-Line Copy Index</h3>
                        <p class="font-serif text-base text-gray-800">Quick copy/paste names for intake forms and labels.</p>
                    </div>
                    <div id="archive-quick" class="font-mono text-xs text-gray-700 space-y-2 max-h-[600px] overflow-y-auto">
                        <div class="text-gray-400">Loading index…</div>
                    </div>
                    <a class="ui-click inline-flex items-center gap-2 text-[10px] font-mono uppercase tracking-widest underline" href="static/data/archive-index.json" target="_blank" rel="noopener">View JSON Source</a>
                </div>

                <div class="lg:col-span-2 space-y-4">
                    <div id="archive-loading" class="border border-dashed border-gray-300 bg-white p-6 font-mono text-sm text-gray-600">Loading archive inventory…</div>
                    <div id="archive-error" class="hidden border border-red-600 bg-red-50 text-red-800 p-4 font-mono text-sm">Archive data unavailable. Refresh or check static/data/archive-index.json.</div>
                    <div id="archive-groups" class="space-y-6"></div>
                </div>
            </div>
        </div>
    </section>

    <!-- VIEW: GALLERY (3D) -->
    <section id="view-gallery" class="view-section relative h-screen w-full overflow-hidden p-0 !pt-0">
        <div id="canvas-container"></div>
        <div id="lantern-grain" class="film-grain hidden"></div>
        <div id="ui-view" class="absolute bottom-8 left-8 bg-white/90 p-6 border border-black max-w-md backdrop-blur-sm shadow-xl z-10 space-y-4">
            <h3 class="font-mono font-bold uppercase text-sm mb-2 tracking-wider">Gallery Control</h3>
            <p class="font-mono text-xs text-gray-600 leading-relaxed">Drag to orbit. Scroll to zoom.<br>Click artifacts for data.</p>

            <div class="space-y-2 font-mono text-[10px] uppercase tracking-widest">
                <div class="flex items-center gap-2">
                    <input id="gallery-edit-password" type="password" class="border border-gray-300 px-2 py-1 text-[10px] w-28" placeholder="Password" aria-label="Edit password">
                    <button id="gallery-edit-btn" class="ui-click border border-black px-2 py-1 bg-white hover:bg-black hover:text-white transition-colors">Unlock Edit</button>
                    <span id="gallery-edit-status" class="text-gray-500">View Only</span>
                </div>
                <div id="gallery-editor-panel" class="hidden border border-dashed border-gray-300 bg-white/70 p-3 space-y-3">
                    <div class="grid grid-cols-2 gap-2 text-[10px]">
                        <label class="flex flex-col gap-1">Frame W<input id="frame-width" type="number" step="0.1" class="border border-gray-300 px-2 py-1" value="4"></label>
                        <label class="flex flex-col gap-1">Frame H<input id="frame-height" type="number" step="0.1" class="border border-gray-300 px-2 py-1" value="5"></label>
                        <label class="flex flex-col gap-1">Pos X<input id="frame-x" type="number" step="0.5" class="border border-gray-300 px-2 py-1" value="0"></label>
                        <label class="flex flex-col gap-1">Pos Y<input id="frame-y" type="number" step="0.5" class="border border-gray-300 px-2 py-1" value="5"></label>
                        <label class="flex flex-col gap-1">Pos Z<input id="frame-z" type="number" step="0.5" class="border border-gray-300 px-2 py-1" value="-5"></label>
                        <label class="flex flex-col gap-1">Label<input id="frame-label" type="text" class="border border-gray-300 px-2 py-1" value="New Work"></label>
                    </div>
                    <div class="flex flex-wrap gap-2">
                        <button id="gallery-add-btn" class="ui-click bg-black text-white px-3 py-2">Add/Update Frame</button>
                        <button id="gallery-reset-btn" class="ui-click border border-black px-3 py-2 bg-white hover:bg-red-600 hover:text-white">Reset Layout</button>
                    </div>
                    <div>
                        <div class="text-gray-500 mb-1">Layout (local only)</div>
                        <div id="gallery-frame-list" class="max-h-32 overflow-y-auto space-y-1"></div>
                    </div>
                </div>
            </div>

            <div class="mt-2 text-[10px] font-mono uppercase tracking-widest text-gray-500">Trigger: <button class="underline text-red-600" onclick="gallery.launchLanternOverlay('And you are a Lantern')">"And you are a Lantern"</button></div>
            <a href="oldindex.html" class="ui-click text-xs font-mono underline uppercase tracking-widest">Launch Full Referrer Sequence</a>
            <div class="mt-4 flex flex-wrap gap-2">
                <button onclick="app.navigate('grift')" class="ui-click border border-black bg-white px-3 py-2 text-[10px] font-mono uppercase tracking-widest hover:bg-black hover:text-white transition-colors">Grift Shop</button>
                <button onclick="app.navigate('barter')" class="ui-click border border-black bg-white px-3 py-2 text-[10px] font-mono uppercase tracking-widest hover:bg-black hover:text-white transition-colors">Barter</button>
                <button onclick="app.navigate('pitch')" class="ui-click border border-black bg-white px-3 py-2 text-[10px] font-mono uppercase tracking-widest hover:bg-black hover:text-white transition-colors">Project Brief</button>
            </div>
        </div>
    </section>

    <!-- FOOTER WITH BACKSTAGE RELAYS -->
    <footer class="bg-black text-white py-10 px-6 md:px-12">
        <div class="max-w-6xl mx-auto flex flex-col md:flex-row justify-between items-start gap-6">
            <div>
                <h4 class="font-mono text-xs uppercase tracking-widest text-gray-300">Backstage Relays (Do Not Publish)</h4>
                <p class="font-serif text-base text-gray-200 max-w-md mt-2">Internal jump points into the legacy referrer experience. Staff use only; these are not public-facing socials.</p>
                <div class="mt-4 flex flex-wrap gap-3">
                    <a class="ui-click inline-flex items-center gap-2 bg-white text-black px-4 py-2 text-xs font-mono uppercase tracking-widest hover:bg-red-600 hover:text-white transition-colors" href="oldindex.html?ref=twitter" aria-label="Redirect to referrer flow via Relay Alpha">Relay Alpha</a>
                    <a class="ui-click inline-flex items-center gap-2 bg-white text-black px-4 py-2 text-xs font-mono uppercase tracking-widest hover:bg-red-600 hover:text-white transition-colors" href="oldindex.html?ref=instagram" aria-label="Redirect to referrer flow via Relay Beta">Relay Beta</a>
                    <a class="ui-click inline-flex items-center gap-2 bg-white text-black px-4 py-2 text-xs font-mono uppercase tracking-widest hover:bg-red-600 hover:text-white transition-colors" href="oldindex.html?ref=tiktok" aria-label="Redirect to referrer flow via Relay Gamma">Relay Gamma</a>
                    <a class="ui-click inline-flex items-center gap-2 bg-white text-black px-4 py-2 text-xs font-mono uppercase tracking-widest hover:bg-red-600 hover:text-white transition-colors" href="oldindex.html" aria-label="Launch referrer flow">Direct Launch</a>
                </div>
            </div>
            <div class="flex flex-col gap-3">
                <span class="font-mono text-xs uppercase tracking-widest text-gray-300">Other Interfaces (Internal)</span>
                <a href="oldindex.html" class="ui-click text-sm underline hover:text-red-400">Celli Referrer Overlay</a>
                <a href="sequence.html" class="ui-click text-sm underline hover:text-red-400">Sequence Preview</a>
                <a href="visicell.html" class="ui-click text-sm underline hover:text-red-400">Visicell Module</a>
            </div>
        </div>
    </footer>

    <div id="invoice-overlay" class="invoice-overlay" aria-hidden="true">
        <div class="invoice-sheet space-y-4">
            <div class="flex items-center justify-between border-b border-black pb-2">
                <h3 class="uppercase">Domestic Product // Invoice Mode</h3>
                <div class="text-[10px] tracking-[0.3em] uppercase">Press I N V to Exit</div>
            </div>
            <div class="flex justify-between text-sm">
                <div class="space-y-1">
                    <div class="font-bold">Loomworks</div>
                    <div>Corporate Myth Unit</div>
                </div>
                <div class="text-right space-y-1 text-xs uppercase tracking-[0.2em]">
                    <div>Invoice #: LW-WONDER</div>
                    <div>Issued: Now</div>
                </div>
            </div>
            <div class="border border-black">
                <div class="grid grid-cols-4 bg-black text-white text-xs uppercase tracking-[0.2em]">
                    <div class="px-3 py-2 border-r border-white/30">Item</div>
                    <div class="px-3 py-2 border-r border-white/30">Description</div>
                    <div class="px-3 py-2 border-r border-white/30">Quantity</div>
                    <div class="px-3 py-2">Value</div>
                </div>
                <div class="grid grid-cols-4 text-sm">
                    <div class="px-3 py-3 border-r border-black/10">WONDER</div>
                    <div class="px-3 py-3 border-r border-black/10">Held, distributed, never sold.</div>
                    <div class="px-3 py-3 border-r border-black/10">1 UNIT</div>
                    <div class="px-3 py-3 font-bold">UNQUANTIFIABLE.</div>
                </div>
            </div>
            <div class="text-xs uppercase tracking-[0.2em] text-gray-700">Thank you for funding the experiment. Your awareness is the receipt.</div>
        </div>
    </div>

    <div id="glitch-banner" class="glitch-banner" aria-live="polite">HOW MUCH DO YOU COST?</div>

    <!-- JAVASCRIPT LOGIC -->
    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        
        // --- DATA SETS ---
        const QUIZ = [
            {
                q: "You find a broken toy on the sidewalk. What is your first instinct?",
                opts: [
                    { txt: "Fix it. It has potential.", type: "dreamer", score: 2 },
                    { txt: "Study it. Where did it come from?", type: "scholar", score: 2 },
                    { txt: "Leave it. It is trash.", type: "passerby", score: 2 },
                    { txt: "Evaluate it. Could it be sold?", type: "investor", score: 2 },
                    { txt: "Feel for it. It looks lonely.", type: "lantern", score: 2 }
                ]
            },
            {
                q: "The room is dark. You have one match. What do you illuminate?",
                opts: [
                    { txt: "The door. I need to leave.", type: "passerby", score: 2 },
                    { txt: "The map. I need to know where I am.", type: "scholar", score: 2 },
                    { txt: "My face. I need to be seen.", type: "lantern", score: 2 },
                    { txt: "The inventory. What is in here?", type: "investor", score: 2 },
                    { txt: "The ceiling. I want to see the height.", type: "dreamer", score: 2 }
                ]
            },
            {
                q: "Loomworks asks for your childhood memory. What do you do?",
                opts: [
                    { txt: "Sell it for maximum credit.", type: "investor", score: 3 },
                    { txt: "Archive it for history.", type: "scholar", score: 3 },
                    { txt: "Re-write it to be better.", type: "dreamer", score: 3 },
                    { txt: "Guard it with my life.", type: "lantern", score: 3 },
                    { txt: "I don't remember anything.", type: "passerby", score: 3 }
                ]
            },
            {
                q: "A guest insists the archive is fake. You...",
                opts: [
                    { txt: "Walk away; disbelief is a choice.", type: "passerby", score: 3 },
                    { txt: "Hand them the provenance binder.", type: "scholar", score: 3 },
                    { txt: "Ask what they'd pay if it weren't.", type: "investor", score: 3 },
                    { txt: "Tell them the ghost stories instead.", type: "dreamer", score: 3 },
                    { txt: "Hold their gaze until they soften.", type: "lantern", score: 3 }
                ]
            },
            {
                q: "The lights flicker during the show. What do you protect first?",
                opts: [
                    { txt: "The visitors' pathfinding.", type: "lantern", score: 3 },
                    { txt: "The rarest object on the wall.", type: "scholar", score: 3 },
                    { txt: "The credit stream.", type: "investor", score: 3 },
                    { txt: "The story. Darkness is part of it.", type: "dreamer", score: 3 },
                    { txt: "Myself. I shouldn't be here.", type: "passerby", score: 3 }
                ]
            }
        ];

        const ROLES = {
            dreamer: { adj: "DREAMING", motto: "Dream forward." },
            scholar: { adj: "SCHOLARLY", motto: "Nothing is unimportant." },
            investor: { adj: "SPECULATIVE", motto: "What is magic worth?" },
            passerby: { adj: "WANDERING", motto: "No one is 'just looking'." },
            lantern: { adj: "ILLUMINATED", motto: "Keep the light." }
        };

        // --- ARCHIVE INDEX ---
        const archive = {
            data: null,
            async init() {
                if (archive.data) return archive.render();

                try {
                    const response = await fetch('static/data/archive-index.json');
                    archive.data = await response.json();
                    archive.render();
                } catch (err) {
                    console.error('Failed to load archive index', err);
                    const loading = document.getElementById('archive-loading');
                    const errorBox = document.getElementById('archive-error');
                    if (loading) loading.classList.add('hidden');
                    if (errorBox) errorBox.classList.remove('hidden');
                }
            },
            render() {
                if (!archive.data) return;

                const { quickIndex = [], groups = [], updated = '—' } = archive.data;
                const quickEl = document.getElementById('archive-quick');
                const groupEl = document.getElementById('archive-groups');
                const loading = document.getElementById('archive-loading');

                if (loading) loading.classList.add('hidden');
                const errorBox = document.getElementById('archive-error');
                if (errorBox) errorBox.classList.add('hidden');

                if (quickEl) {
                    quickEl.innerHTML = '';
                    quickIndex.forEach((entry, idx) => {
                        const line = document.createElement('div');
                        line.className = 'flex items-start gap-2';
                        line.innerHTML = `<span class="text-gray-400">${idx + 1}.</span><span>${entry}</span>`;
                        quickEl.appendChild(line);
                    });
                }

                if (document.getElementById('archive-count')) {
                    const totalItems = groups.reduce((sum, g) => sum + (g.items?.length || 0), 0);
                    document.getElementById('archive-count').innerText = totalItems;
                }
                if (document.getElementById('archive-era-count')) document.getElementById('archive-era-count').innerText = groups.length;
                if (document.getElementById('archive-updated')) document.getElementById('archive-updated').innerText = updated;

                if (groupEl) {
                    groupEl.innerHTML = '';
                    groups.forEach(group => {
                        const wrapper = document.createElement('div');
                        wrapper.className = 'bg-white border border-black shadow-sm';

                        const header = document.createElement('div');
                        header.className = 'border-b border-gray-200 px-4 py-3 flex flex-col md:flex-row md:items-center md:justify-between gap-2';
                        header.innerHTML = `
                            <div>
                                <div class="text-[10px] font-mono uppercase tracking-widest text-gray-500">${group.era}</div>
                                <h3 class="text-xl font-bold">${group.era} Inventory</h3>
                            </div>
                            <div class="text-sm font-mono text-gray-600 max-w-2xl">${group.summary || ''}</div>
                        `;

                        const body = document.createElement('div');
                        body.className = 'divide-y divide-gray-200';

                        (group.items || []).forEach(item => {
                            const meta = [
                                item.franchise ? `<span class="px-2 py-1 border border-gray-200 bg-gray-50">${item.franchise}</span>` : '',
                                item.category ? `<span class="px-2 py-1 border border-gray-200 bg-gray-50">${item.category}</span>` : '',
                                item.quantity ? `<span class="px-2 py-1 border border-gray-200 bg-gray-50">${item.quantity}</span>` : '',
                                item.origin ? `<span class="px-2 py-1 border border-gray-200 bg-gray-50">${item.origin}</span>` : ''
                            ].filter(Boolean).join('');

                            const row = document.createElement('div');
                            row.className = 'p-4';
                            row.innerHTML = `
                                <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-3">
                                    <div class="md:w-2/3">
                                        <div class="text-[10px] font-mono uppercase tracking-widest text-gray-500">#${item.id} • ${item.format || 'Item'} • ${item.year || 'n.d.'}</div>
                                        <h4 class="text-lg font-semibold">${item.title}</h4>
                                        <p class="text-sm text-gray-700 mt-2">${item.notes || ''}</p>
                                        <div class="flex flex-wrap gap-2 mt-3 text-[10px] font-mono uppercase tracking-widest text-gray-700">${meta}</div>
                                    </div>
                                    <div class="md:w-1/3 md:text-right text-sm font-mono text-gray-600 flex flex-col gap-2">
                                        <span class="inline-block border border-gray-300 bg-gray-50 px-2 py-1">${item.category || 'Inventory'}</span>
                                        <span class="inline-block border border-gray-200 bg-gray-50 px-2 py-1">${item.format || 'Item'}</span>
                                    </div>
                                </div>
                            `;
                            body.appendChild(row);
                        });

                        wrapper.appendChild(header);
                        wrapper.appendChild(body);
                        groupEl.appendChild(wrapper);
                    });
                }
            }
        };
        window.archive = archive;

        // --- GLOBAL APP STATE ---
        const state = {
            view: 'landing',
            audioInitialized: false,
            synth: null,
            sessionNonce: Math.random().toString(36).slice(2, 7)
        };

        // --- AMBIENT SYSTEMS ---
        const ambient = {
            tooltipTimer: null,
            prompts: [
                'DO YOU FEEL SEEN?',
                'THIS IS AN INTERACTION.',
                'ARTIFACT VERIFIED.',
                'A MEMORY IS BEING PROCESSED…'
            ],
            startTooltips() {
                if (ambient.tooltipTimer) return;
                ambient.scheduleTooltip();
            },
            scheduleTooltip() {
                ambient.tooltipTimer = setTimeout(() => {
                    if (state.view === 'landing') ambient.spawnTooltip();
                    ambient.tooltipTimer = null;
                    ambient.scheduleTooltip();
                }, 6000 + Math.random() * 7000);
            },
            spawnTooltip() {
                const layer = document.getElementById('ambient-layer');
                if (!layer) return;
                const tip = document.createElement('div');
                tip.className = 'ambient-tooltip';
                tip.textContent = ambient.prompts[Math.floor(Math.random() * ambient.prompts.length)];
                tip.style.left = `${20 + Math.random() * 60}%`;
                tip.style.top = `${20 + Math.random() * 60}%`;
                layer.appendChild(tip);
                setTimeout(() => tip.remove(), 2200);
            },
            stopTooltips() {
                if (ambient.tooltipTimer) { clearTimeout(ambient.tooltipTimer); ambient.tooltipTimer = null; }
            }
        };

        const registerHeatmap = () => {
            document.querySelectorAll('.legal-copy').forEach(el => {
                el.addEventListener('mousemove', (e) => {
                    const rect = el.getBoundingClientRect();
                    el.style.setProperty('--x', `${e.clientX - rect.left}px`);
                    el.style.setProperty('--y', `${e.clientY - rect.top}px`);
                });
            });
        };

        const observeBlueprints = () => {
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => { if (entry.isIntersecting) entry.target.classList.add('active'); });
            }, { threshold: 0.15 });
            document.querySelectorAll('.blueprint-lines').forEach(el => observer.observe(el));
        };

        const initScanlineParallax = () => {
            const layer = document.querySelector('#view-landing .scanline-layer');
            if (!layer) return;
            const move = () => {
                const offset = window.scrollY * 0.04;
                layer.style.transform = `translateY(${offset}px)`;
            };
            window.addEventListener('scroll', move);
        };

        const startIdleGlitch = () => {
            setInterval(() => {
                if (state.view !== 'landing') return;
                const title = document.getElementById('dp-title');
                if (!title) return;
                title.classList.add('micro-glitch');
                setTimeout(() => title.classList.remove('micro-glitch'), 800);
            }, 60000);
        };

        const initInvoiceMode = () => {
            const overlay = document.getElementById('invoice-overlay');
            if (!overlay) return;
            let buffer = '';
            const toggle = (force = null) => {
                const shouldShow = force !== null ? force : !overlay.classList.contains('active');
                overlay.classList.toggle('active', shouldShow);
                overlay.setAttribute('aria-hidden', shouldShow ? 'false' : 'true');
                document.body.classList.toggle('modal-open', shouldShow);
            };
            document.addEventListener('keydown', (e) => {
                if (['INPUT', 'TEXTAREA'].includes(e.target.tagName)) return;
                buffer = (buffer + e.key.toLowerCase()).slice(-3);
                if (buffer === 'inv') toggle();
                if (e.key === 'Escape') toggle(false);
            });
        };

        const startGlitchBannerCycle = () => {
            const banner = document.getElementById('glitch-banner');
            if (!banner) return;
            const trigger = () => {
                banner.classList.add('active');
                setTimeout(() => banner.classList.remove('active'), 3600);
                setTimeout(trigger, 9000 + Math.random() * 9000);
            };
            setTimeout(trigger, 5200);
        };

        // --- AUDIO ENGINE ---
        const audio = {
            drone: null,
            chimes: null,
            chimeLoop: null,
            transportStarted: false,
            init: async () => {
                if (state.audioInitialized) return;
                await Tone.start();
                state.synth = new Tone.NoiseSynth({
                    noise: { type: 'pink' },
                    envelope: { attack: 0.001, decay: 0.08, sustain: 0, release: 0.05 }
                }).toDestination();
                state.audioInitialized = true;
            },
            click: () => {
                if (!state.audioInitialized || !state.synth) {
                    audio.init().then(() => { if(state.synth) state.synth.triggerAttackRelease("16n", Tone.now()); });
                } else {
                    state.synth.triggerAttackRelease("16n", Tone.now());
                }
            },
            startLantern: async () => {
                await audio.init();
                if (!audio.transportStarted) {
                    Tone.Transport.start();
                    audio.transportStarted = true;
                }
                if (!audio.drone) {
                    audio.drone = new Tone.Oscillator('C2', 'sawtooth').connect(new Tone.Filter(400, 'lowpass')).toDestination();
                    audio.drone.volume.value = -16;
                    audio.drone.start();
                }
                if (!audio.chimes) {
                    audio.chimes = new Tone.MetalSynth({ resonance: 300, harmonicity: 8, modulationIndex: 15 }).toDestination();
                }
                if (!audio.chimeLoop) {
                    const notes = ['C4', 'G4', 'D5', 'A4'];
                    audio.chimeLoop = new Tone.Loop((time) => {
                        const note = notes[Math.floor(Math.random() * notes.length)];
                        audio.chimes.triggerAttackRelease(note, '16n', time);
                    }, '3n').start();
                }
            },
            stopLantern: () => {
                if (audio.drone) { audio.drone.stop(); audio.drone.dispose(); audio.drone = null; }
                if (audio.chimeLoop) { audio.chimeLoop.stop(); audio.chimeLoop.dispose(); audio.chimeLoop = null; }
                if (audio.chimes) { audio.chimes.dispose(); audio.chimes = null; }
                if (audio.transportStarted) {
                    Tone.Transport.stop();
                    audio.transportStarted = false;
                }
            }
        };

        // --- PROFILER LOGIC (QUIZ) ---
        const profiler = {
            initialChoice: null,
            scores: { dreamer: 0, scholar: 0, investor: 0, passerby: 0, lantern: 0 },
            currentQ: 0,
            lastWinner: null,
            lastTitle: '',
            lastProfile: null,
            shareTimeout: null,

            init: () => {
                document.getElementById('prof-stage-select').classList.remove('hidden');
                document.getElementById('prof-stage-doubt').classList.add('hidden');
                document.getElementById('prof-stage-quiz').classList.add('hidden');
                document.getElementById('prof-stage-process').classList.add('hidden');
                document.getElementById('prof-banner').classList.add('hidden');
                document.getElementById('quiz-modal').classList.remove('active');
                document.body.classList.remove('modal-open');
                document.getElementById('prof-result-card').classList.add('hidden');
                document.getElementById('sculpture-generator').classList.add('hidden');
                const totalEl = document.getElementById('quiz-total');
                if (totalEl) totalEl.innerText = QUIZ.length;
                profiler.scores = { dreamer: 0, scholar: 0, investor: 0, passerby: 0, lantern: 0 };
                profiler.currentQ = 0;
                profiler.initialChoice = null;
                profiler.lastWinner = null;
                profiler.lastTitle = '';
                const readout = document.getElementById('sculpture-readout');
                if (readout) {
                    readout.innerHTML = `<div class="text-[10px] uppercase tracking-widest text-gray-500">Awaiting prompt...</div><p class="text-sm text-gray-700">Run the quiz and generate a specimen to see the deterministic voxel sketch and dossier.</p>`;
                }
            },

            select: (role, el) => {
                audio.click();
                profiler.initialChoice = role;
                const target = el || null;
                document.querySelectorAll('.role-card').forEach(c => c.classList.remove('selected'));
                if (target) target.classList.add('selected');
                setTimeout(() => {
                    document.getElementById('prof-stage-select').classList.add('hidden');
                    document.getElementById('prof-stage-doubt').classList.remove('hidden');
                }, 500);
            },

            reset: () => {
                audio.click();
                profiler.init();
            },

            startQuiz: () => {
                audio.click();
                document.getElementById('prof-stage-doubt').classList.add('hidden');
                document.getElementById('prof-stage-quiz').classList.remove('hidden');
                document.getElementById('prof-stage-process').classList.add('hidden');
                document.getElementById('quiz-modal').classList.add('active');
                document.body.classList.add('modal-open');
                profiler.renderQuestion();
            },

            renderQuestion: () => {
                const q = QUIZ[profiler.currentQ];
                document.getElementById('quiz-num').innerText = profiler.currentQ + 1;
                document.getElementById('quiz-q').innerText = q.q;
                
                const optsContainer = document.getElementById('quiz-options');
                optsContainer.innerHTML = '';
                
                // Shuffle options
                const shuffled = q.opts.sort(() => 0.5 - Math.random());
                
                shuffled.forEach(opt => {
                    const btn = document.createElement('button');
                    btn.className = "w-full text-left border border-gray-300 p-4 hover:bg-black hover:text-white transition-colors font-mono text-sm ui-click";
                    btn.innerText = `> ${opt.txt}`;
                    btn.onclick = () => profiler.answer(opt);
                    optsContainer.appendChild(btn);
                });
            },

            answer: (opt) => {
                audio.click();
                profiler.scores[opt.type] += opt.score;
                profiler.currentQ++;
                if (profiler.currentQ < QUIZ.length) {
                    profiler.renderQuestion();
                } else {
                    profiler.calculate();
                }
            },

            calculate: () => {
                document.getElementById('prof-stage-quiz').classList.add('hidden');
                document.getElementById('prof-stage-process').classList.remove('hidden');

                // Determine Winner
                let maxScore = -1;
                let winner = profiler.initialChoice; // Default to self-selection
                
                for (const [key, val] of Object.entries(profiler.scores)) {
                    if (val > maxScore) {
                        maxScore = val;
                        winner = key;
                    }
                }

                // Dual Title Logic
                const adj = ROLES[profiler.initialChoice || winner].adj;
                const noun = winner.toUpperCase();
                const finalTitle = profiler.initialChoice === winner ? `THE PURE ${noun}` : `THE ${adj} ${noun}`;

                profiler.lastWinner = winner;
                profiler.lastTitle = finalTitle;

                profiler.runTypewriter(finalTitle, winner);
            },

            runTypewriter: (title, winnerKey) => {
                const lines = [
                    "Analyzing inputs...",
                    "Comparing against self-perception...",
                    "Detecting dissonance...",
                    "Re-calibrating identity matrix...",
                    "Classification Complete."
                ];
                const container = document.getElementById('decon-lines');
                container.innerHTML = '';
                let delay = 0;
                lines.forEach((line) => {
                    delay += 800 + Math.random() * 500;
                    setTimeout(() => {
                        container.innerHTML += `<div class="fade-in">> ${line}</div>`;
                        if (state.synth) state.synth.triggerAttackRelease("32n", Tone.now());
                    }, delay);
                });

                setTimeout(() => {
                    profiler.showResult(title, winnerKey);
                }, delay + 1000);
            },

            showResult: (title, winnerKey) => {
                document.getElementById('prof-stage-process').classList.add('hidden');
                profiler.closeModal();

                const banner = document.getElementById('prof-banner');
                banner.classList.remove('hidden');
                document.getElementById('banner-title').innerText = title;
                document.getElementById('banner-motto').innerText = ROLES[winnerKey].motto;

                const resultCard = document.getElementById('prof-result-card');
                resultCard.classList.remove('hidden');
                document.getElementById('result-title').innerText = title;
                document.getElementById('result-motto').innerText = ROLES[winnerKey].motto;

                const sculptor = document.getElementById('sculpture-generator');
                sculptor.classList.remove('hidden');
                profiler.generateSculpture();

                if (state.synth) state.synth.triggerAttackRelease("C4", "8n");
            },

            closeModal: () => {
                const modal = document.getElementById('quiz-modal');
                modal.classList.remove('active');
                document.body.classList.remove('modal-open');
            },

            buildProfile: () => {
                const mat = document.getElementById('sculpture-material').value;
                const fmt = document.getElementById('sculpture-format').value;
                const role = profiler.lastWinner || 'dreamer';
                const palettes = {
                    dreamer: ['#1f2a7e', '#d6d5cc', '#f5d9c3'],
                    scholar: ['#7d6338', '#f6f0e6', '#0f172a'],
                    investor: ['#c0c6cc', '#1b1b1b', '#1db954'],
                    passerby: ['#7fb3ff', '#9ca3af', '#f4f4f5'],
                    lantern: ['#d13f23', '#111111', '#f7c99a']
                };
                const gestures = {
                    dreamer: 'spiraling helix with soft gaps',
                    scholar: 'stacked folios with interlocking bands',
                    investor: 'angled plinths with mirrored insets',
                    passerby: 'offset slabs that almost slip',
                    lantern: 'caged beam held by vertical struts'
                };

                const totalScore = Object.values(profiler.scores).reduce((a, b) => a + b, 0) || 1;
                const alignment = Math.min(99, Math.round((profiler.scores[role] / totalScore) * 42) + 55);
                const seedText = `${state.sessionNonce}-${role}-${fmt}-${mat}-${profiler.lastTitle || 'specimen'}`;
                const hash = sculptureEngine.hash(seedText).toString(36).slice(0, 5).toUpperCase();

                return {
                    role,
                    material: mat,
                    format: fmt,
                    palette: palettes[role] || palettes.dreamer,
                    gesture: gestures[role] || gestures.dreamer,
                    alignment,
                    seedText,
                    hash,
                    specimenId: `Specimen-${role.slice(0, 3).toUpperCase()}-${hash}`,
                    anomalies: [
                        `Role deviation: ${Math.max(2, 100 - alignment)}% mismatch from cohort`,
                        `Pulse ingress: ${Math.round(alignment * 0.23)}bps`,
                        `Void pockets: ${(7 + (alignment % 5)).toFixed(1)}cm`
                    ]
                };
            },

            renderSculptureReadout: (profile) => {
                const readout = document.getElementById('sculpture-readout');
                if (!readout) return;
                readout.innerHTML = `
                    <div class="text-[10px] uppercase tracking-widest text-red-600 mb-2">${profile.specimenId}</div>
                    <div class="space-y-1 text-gray-800">
                        <div class="font-bold text-sm">${profiler.lastTitle || 'Signal Artifact'}</div>
                        <div class="text-[11px] uppercase tracking-[0.25em] text-gray-500">${profile.format} • ${profile.material}</div>
                        <div class="text-sm">${profile.gesture} with creme/black/red controls.</div>
                    </div>
                    <div class="mt-3 space-y-1 text-[11px] uppercase tracking-widest text-gray-600">
                        <div>Alignment: ${profile.alignment}%</div>
                        <div>Seed: ${profile.hash}</div>
                        <div>Palette: ${profile.palette.join(' / ')}</div>
                    </div>
                    <div class="mt-3 text-[11px] text-gray-600 space-y-1">
                        ${profile.anomalies.map(a => `<div class="flex items-start gap-2"><span class="text-red-600">●</span><span>${a}</span></div>`).join('')}
                    </div>
                    <div class="mt-4 pt-3 border-t border-gray-200 space-y-2">
                        <div class="text-[10px] uppercase tracking-widest text-gray-500">Share Blueprint</div>
                        <div class="flex flex-wrap gap-2">
                            <button class="sculpture-share-button" onclick="profiler.shareBlueprint()">Share</button>
                            <button class="sculpture-share-button" onclick="profiler.copyBlueprint()">Copy Brief</button>
                            <button class="sculpture-share-button" onclick="profiler.downloadBlueprint()">Download</button>
                        </div>
                        <div id="sculpture-share-status" class="text-[10px] uppercase tracking-widest text-gray-500">Ready to distribute.</div>
                    </div>
                `;
            },

            generateSculpture: () => {
                const profile = profiler.buildProfile();
                profiler.lastProfile = profile;
                sculptureEngine.render(profile);
                profiler.renderSculptureReadout(profile);
            },

            getSharePayload: () => {
                if (!profiler.lastProfile) return null;
                const { specimenId, format, material, gesture, hash } = profiler.lastProfile;
                return {
                    title: `${specimenId} — ${profiler.lastTitle || 'Signal Artifact'}`,
                    text: `${gesture} built for ${format} (${material}). Seed ${hash}.`,
                    url: window.location.href.split('#')[0]
                };
            },

            flashShareStatus: (msg) => {
                const el = document.getElementById('sculpture-share-status');
                if (!el) return;
                el.innerText = msg;
                el.style.color = '#d31313';
                if (profiler.shareTimeout) clearTimeout(profiler.shareTimeout);
                profiler.shareTimeout = setTimeout(() => {
                    el.style.color = '';
                }, 1200);
            },

            copyBlueprint: async () => {
                const payload = profiler.getSharePayload();
                if (!payload || !navigator.clipboard) return profiler.flashShareStatus('Generate first.');
                const summary = `${payload.title}\n${payload.text}\n${payload.url}`;
                try {
                    await navigator.clipboard.writeText(summary);
                    profiler.flashShareStatus('Copied blueprint.');
                } catch (err) {
                    profiler.flashShareStatus('Clipboard blocked.');
                }
            },

            shareBlueprint: async () => {
                const payload = profiler.getSharePayload();
                if (!payload) return profiler.flashShareStatus('Generate first.');
                if (navigator.share) {
                    try {
                        await navigator.share(payload);
                        profiler.flashShareStatus('Shared.');
                    } catch (err) {
                        profiler.flashShareStatus('Share dismissed.');
                    }
                } else {
                    profiler.copyBlueprint();
                }
            },

            downloadBlueprint: () => {
                const payload = profiler.getSharePayload();
                if (!payload) return profiler.flashShareStatus('Generate first.');
                const dataUrl = sculptureEngine.exportImage();
                if (!dataUrl) return profiler.flashShareStatus('Preview not ready.');
                const link = document.createElement('a');
                link.href = dataUrl;
                link.download = `${payload.title.replace(/[^a-z0-9\- ]/gi, '').replace(/\s+/g, '_')}.png`;
                link.click();
                profiler.flashShareStatus('Preview downloaded.');
            }
        };
        window.profiler = profiler;

        const sculptureEngine = {
            renderer: null,
            scene: null,
            camera: null,
            container: null,
            rand: null,

            hash(text) {
                let h = 0;
                for (let i = 0; i < text.length; i++) {
                    h = Math.imul(31, h) + text.charCodeAt(i) | 0;
                }
                return Math.abs(h);
            },

            setSeed(seedText) {
                let seed = sculptureEngine.hash(seedText) || 1;
                sculptureEngine.rand = () => {
                    seed += 1;
                    const x = Math.sin(seed) * 10000;
                    return x - Math.floor(x);
                };
            },

            init() {
                sculptureEngine.container = document.getElementById('sculpture-canvas');
                if (!sculptureEngine.container) return;
                if (!sculptureEngine.renderer) {
                    sculptureEngine.renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true, canvas: sculptureEngine.container });
                }
                const bounds = sculptureEngine.container.getBoundingClientRect();
                sculptureEngine.renderer.setSize(bounds.width || 420, bounds.height || 260);

                sculptureEngine.camera = new THREE.PerspectiveCamera(40, (bounds.width || 420) / (bounds.height || 260), 0.1, 50);
                sculptureEngine.camera.position.set(3.2, 2.6, 4.8);
                sculptureEngine.camera.lookAt(0, 1, 0);

                sculptureEngine.scene = new THREE.Scene();
                sculptureEngine.scene.background = new THREE.Color('#f6f0e6');
            },

            resetScene() {
                if (!sculptureEngine.scene) return;
                while (sculptureEngine.scene.children.length) {
                    sculptureEngine.scene.remove(sculptureEngine.scene.children[0]);
                }

                sculptureEngine.scene.add(new THREE.AmbientLight('#f6f0e6', 0.55));
                const key = new THREE.DirectionalLight('#ffffff', 0.9);
                key.position.set(3, 6, 5);
                sculptureEngine.scene.add(key);
                const rim = new THREE.DirectionalLight('#d7342a', 0.35);
                rim.position.set(-4, 3, -2);
                sculptureEngine.scene.add(rim);

                const floor = new THREE.Mesh(new THREE.PlaneGeometry(10, 10), new THREE.MeshStandardMaterial({ color: '#ede7dc', metalness: 0.1, roughness: 0.8 }));
                floor.rotation.x = -Math.PI / 2;
                floor.position.y = -0.5;
                sculptureEngine.scene.add(floor);
            },

            randRange(min, max) {
                if (!sculptureEngine.rand) return min;
                return min + (max - min) * sculptureEngine.rand();
            },

            buildPrimitives(profile) {
                const group = new THREE.Group();
                const mode = sculptureEngine.randRange(0, 1) > 0.7 ? 'outline' : 'stacked';
                if (mode === 'outline') {
                    sculptureEngine.buildOutlineVariant(group);
                } else {
                    sculptureEngine.buildStackedVariant(group, profile);
                }

                sculptureEngine.scene.add(group);
            },

            buildStackedVariant(group, profile) {
                const voxelCount = 10 + Math.floor(sculptureEngine.randRange(0, 8));
                for (let i = 0; i < voxelCount; i++) {
                    const size = sculptureEngine.randRange(0.4, 1.2);
                    const cube = new THREE.Mesh(
                        new THREE.BoxGeometry(size, sculptureEngine.randRange(0.5, 1.6), size),
                        new THREE.MeshStandardMaterial({
                            color: profile.palette[i % profile.palette.length],
                            metalness: 0.35,
                            roughness: 0.4
                        })
                    );
                    cube.position.set(
                        sculptureEngine.randRange(-1.4, 1.4),
                        sculptureEngine.randRange(0.2, 2.2),
                        sculptureEngine.randRange(-1.4, 1.4)
                    );
                    cube.rotation.y = sculptureEngine.randRange(0, Math.PI * 2);
                    group.add(cube);

                    const edges = new THREE.LineSegments(new THREE.EdgesGeometry(cube.geometry), new THREE.LineBasicMaterial({ color: '#0f0f0f', linewidth: 1 }));
                    edges.position.copy(cube.position);
                    edges.rotation.copy(cube.rotation);
                    group.add(edges);
                }

                for (let i = 0; i < 4; i++) {
                    const rod = new THREE.Mesh(
                        new THREE.CylinderGeometry(0.05, 0.05, sculptureEngine.randRange(1.2, 2.8), 8),
                        new THREE.MeshStandardMaterial({ color: '#111111', metalness: 0.6, roughness: 0.25 })
                    );
                    rod.position.set(sculptureEngine.randRange(-1.6, 1.6), sculptureEngine.randRange(0.4, 2.4), sculptureEngine.randRange(-1.6, 1.6));
                    rod.rotation.z = sculptureEngine.randRange(-0.6, 0.6);
                    rod.rotation.x = sculptureEngine.randRange(-0.2, 0.2);
                    group.add(rod);
                }

                for (let i = 0; i < 3; i++) {
                    const voidBox = new THREE.Mesh(
                        new THREE.BoxGeometry(sculptureEngine.randRange(0.6, 1.3), sculptureEngine.randRange(0.4, 0.9), sculptureEngine.randRange(0.6, 1.3)),
                        new THREE.MeshStandardMaterial({ color: '#ffffff', transparent: true, opacity: 0.28, metalness: 0, roughness: 1 })
                    );
                    voidBox.position.set(sculptureEngine.randRange(-1.2, 1.2), sculptureEngine.randRange(0.6, 1.8), sculptureEngine.randRange(-1.2, 1.2));
                    group.add(voidBox);
                }

                const plate = new THREE.Mesh(new THREE.BoxGeometry(3.8, 0.1, 3.8), new THREE.MeshStandardMaterial({ color: '#0f0f0f', metalness: 0.7, roughness: 0.35 }));
                plate.position.y = 0;
                group.add(plate);

                const accent = new THREE.Mesh(
                    new THREE.PlaneGeometry(3.8, 0.2),
                    new THREE.MeshBasicMaterial({ color: '#d7342a' })
                );
                accent.rotation.x = -Math.PI / 2;
                accent.position.set(0, 0.06, -1.3);
                group.add(accent);
            },

            buildOutlineVariant(group) {
                const redLine = new THREE.LineBasicMaterial({ color: '#d31313', linewidth: 1.2 });
                const frameCount = 6 + Math.floor(sculptureEngine.randRange(0, 4));
                for (let i = 0; i < frameCount; i++) {
                    const box = new THREE.BoxGeometry(
                        sculptureEngine.randRange(0.8, 1.8),
                        sculptureEngine.randRange(0.4, 1.5),
                        sculptureEngine.randRange(0.8, 1.8)
                    );
                    const wire = new THREE.LineSegments(new THREE.EdgesGeometry(box), redLine.clone());
                    wire.position.set(
                        sculptureEngine.randRange(-1.6, 1.6),
                        sculptureEngine.randRange(0.3, 2.5),
                        sculptureEngine.randRange(-1.6, 1.6)
                    );
                    wire.rotation.y = sculptureEngine.randRange(0, Math.PI * 2);
                    wire.rotation.x = sculptureEngine.randRange(-0.3, 0.3);
                    group.add(wire);
                }

                const ringCount = 3 + Math.floor(sculptureEngine.randRange(0, 3));
                for (let i = 0; i < ringCount; i++) {
                    const torus = new THREE.TorusGeometry(sculptureEngine.randRange(0.6, 1.4), 0.02, 8, 32);
                    const torusWire = new THREE.LineSegments(new THREE.WireframeGeometry(torus), redLine.clone());
                    torusWire.position.set(
                        sculptureEngine.randRange(-0.8, 0.8),
                        sculptureEngine.randRange(0.5, 1.8),
                        sculptureEngine.randRange(-0.8, 0.8)
                    );
                    torusWire.rotation.x = sculptureEngine.randRange(0, Math.PI * 2);
                    torusWire.rotation.y = sculptureEngine.randRange(0, Math.PI * 2);
                    group.add(torusWire);
                }

                const plate = new THREE.LineSegments(
                    new THREE.EdgesGeometry(new THREE.BoxGeometry(3.8, 0.06, 3.8)),
                    redLine.clone()
                );
                plate.position.y = 0;
                group.add(plate);

                const halo = new THREE.LineSegments(
                    new THREE.WireframeGeometry(new THREE.CylinderGeometry(1.3, 1.3, 0.06, 28, 1, true)),
                    redLine.clone()
                );
                halo.rotation.x = Math.PI / 2;
                halo.position.y = 0.22;
                group.add(halo);
            },

            render(profile) {
                sculptureEngine.init();
                if (!sculptureEngine.renderer) return;
                sculptureEngine.setSeed(profile.seedText);
                sculptureEngine.resetScene();
                sculptureEngine.buildPrimitives(profile);
                sculptureEngine.renderer.render(sculptureEngine.scene, sculptureEngine.camera);
            },

            resize() {
                if (!sculptureEngine.renderer || !sculptureEngine.camera || !sculptureEngine.container) return;
                const bounds = sculptureEngine.container.getBoundingClientRect();
                sculptureEngine.camera.aspect = (bounds.width || 420) / (bounds.height || 260);
                sculptureEngine.camera.updateProjectionMatrix();
                sculptureEngine.renderer.setSize(bounds.width || 420, bounds.height || 260);
                sculptureEngine.renderer.render(sculptureEngine.scene, sculptureEngine.camera);
            },

            exportImage() {
                if (!sculptureEngine.renderer) return null;
                return sculptureEngine.renderer.domElement.toDataURL('image/png');
            }
        };
        window.sculptureEngine = sculptureEngine;

        // --- GRIFT SHOP LOGIC ---
        const grift = {
            currentColor: '#000000',
            isSimulating: false,
            totalValue: 0,
            userRoyalty: 0,
            simSpeed: 1000,
            timer: null,
            selectedStyle: 'abstracted',
            lastGrid: null,
            styleNotes: {
                abstracted: 'Abstracts clusters with soft bloom + signal noise.',
                grid: 'Preserves the pixel lattice with a crisp frame.',
                flat: 'Fuses pixels into one plate; no grid lines.'
            },
            events: [
                "Piece spotted in background of viral TikTok.", "Loomworks acquires global IP rights.",
                "Unauthorized merch on AliExpress.", "Sotheby's Auction: Lot 404 - SOLD.",
                "Piece used in AI training dataset.", "Influencer holding piece upside down.",
                "Minted as NFT on dead chain.", "Bootleg plushie released in Japan."
            ],
            
            init: () => {
                const grid = document.getElementById('pixel-grid');
                grid.innerHTML = '';
                for (let i = 0; i < 256; i++) {
                    const cell = document.createElement('div');
                    cell.className = 'pixel-cell';
                    cell.onclick = () => { cell.style.backgroundColor = grift.currentColor; audio.click(); };
                    grid.appendChild(cell);
                }
                grift.setStyle('abstracted');
                grift.lastGrid = null;
            },
            setColor: (c) => { grift.currentColor = c; audio.click(); },
            setStyle: (style) => {
                grift.selectedStyle = style;
                const note = document.getElementById('style-note');
                if (note) note.innerText = grift.styleNotes[style] || '';
                const hanging = document.getElementById('hanging-art');
                if (hanging) {
                    hanging.classList.remove('style-abstracted', 'style-grid', 'style-flat');
                    hanging.classList.add(`style-${style}`);
                }
            },
            submit: () => {
                document.getElementById('editor-ui').classList.add('hidden');
                const sim = document.getElementById('gallery-sim');
                sim.classList.remove('hidden'); sim.classList.add('flex');
                document.getElementById('accel-btn').disabled = false;
                document.getElementById('accel-btn').classList.remove('opacity-50', 'cursor-not-allowed');
                const hanging = document.getElementById('hanging-art');
                hanging.innerHTML = '';
                hanging.classList.remove('style-abstracted', 'style-grid', 'style-flat');
                hanging.classList.add(`style-${grift.selectedStyle}`);
                const gridData = grift.captureGrid();
                const artwork = grift.renderArtwork(grift.selectedStyle, gridData);
                if (artwork) hanging.appendChild(artwork);
                grift.lastGrid = gridData;
                grift.spawnAttendees();
                grift.isSimulating = true;
                const log = document.getElementById('event-log');
                if (log) log.innerHTML = `> Style locked: ${grift.selectedStyle}. Palette ${grift.describePalette(gridData)}.<br>` + log.innerHTML;
                grift.loop();
            },
            accelerate: () => {
                audio.click();
                grift.simSpeed = Math.max(50, grift.simSpeed * 0.7);
                const btn = document.getElementById('accel-btn');
                btn.innerText = "ACCELERATING...";
                setTimeout(() => btn.innerText = "ACCELERATE MARKET", 200);
                const log = document.getElementById('event-log');
                if (log) log.innerHTML = `> Market velocity spiked. <br>` + log.innerHTML;
            },
            spawnAttendees: () => {
                const row = document.getElementById('attendee-row');
                if (!row) return;
                row.innerHTML = '';
                const count = 4;
                for (let i = 0; i < count; i++) {
                    const person = document.createElement('div');
                    person.className = `attendee ${i % 2 === 0 ? 'observe' : ''}`;
                    person.style.animationDelay = `${Math.random()}s`;
                    row.appendChild(person);
                }
            },
            captureGrid: () => {
                const cells = Array.from(document.querySelectorAll('#pixel-grid .pixel-cell'));
                const colors = cells.map((cell) => cell.style.backgroundColor || '#ffffff');
                return { size: 16, colors };
            },
            describePalette: (gridData) => {
                if (!gridData) return 'EMPTY';
                const counts = {};
                const normalize = (c) => {
                    if (!c) return '#ffffff';
                    if (c.startsWith('#')) return c.toLowerCase();
                    const parts = c.match(/(\d+)/g) || [];
                    if (parts.length >= 3) {
                        return '#' + parts.slice(0, 3).map((p) => Number(p).toString(16).padStart(2, '0')).join('');
                    }
                    return '#ffffff';
                };
                gridData.colors.forEach((c) => {
                    const hex = normalize(c);
                    counts[hex] = (counts[hex] || 0) + 1;
                });
                const sorted = Object.entries(counts)
                    .filter(([hex]) => hex !== '#ffffff')
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 3)
                    .map(([hex]) => hex.toUpperCase());
                return sorted.length ? sorted.join(' • ') : 'MONOCHROME';
            },
            renderArtwork: (style, data) => {
                const canvas = document.createElement('canvas');
                canvas.width = 320;
                canvas.height = 320;
                canvas.className = 'w-full h-full object-contain';
                const ctx = canvas.getContext('2d');
                if (!ctx || !data) return canvas;

                ctx.fillStyle = '#f6f0e6';
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                if (style === 'abstracted') grift.renderAbstracted(ctx, data);
                else if (style === 'flat') grift.renderFlat(ctx, data);
                else grift.renderGridStyle(ctx, data);

                ctx.strokeStyle = '#0f0f0f';
                ctx.lineWidth = 4;
                ctx.strokeRect(6, 6, canvas.width - 12, canvas.height - 12);
                return canvas;
            },
            renderGridStyle: (ctx, data) => {
                const cellSize = 18;
                const offset = 30;
                data.colors.forEach((color, idx) => {
                    const x = idx % data.size;
                    const y = Math.floor(idx / data.size);
                    ctx.fillStyle = color || '#ffffff';
                    ctx.fillRect(offset + x * cellSize, offset + y * cellSize, cellSize - 1, cellSize - 1);
                });
            },
            renderFlat: (ctx, data) => {
                const palette = grift.describePalette(data).split(' • ');
                const swatches = palette.filter((p) => p.startsWith('#'));
                const fill = swatches.length ? swatches : ['#d7342a', '#0f0f0f', '#f6f0e6'];
                const grad = ctx.createLinearGradient(0, 0, ctx.canvas.width, ctx.canvas.height);
                grad.addColorStop(0, fill[0] || '#d7342a');
                grad.addColorStop(0.5, fill[1] || '#0f0f0f');
                grad.addColorStop(1, fill[2] || '#f6f0e6');
                ctx.fillStyle = grad;
                ctx.fillRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                ctx.globalCompositeOperation = 'multiply';
                grift.renderGridStyle(ctx, data);
                ctx.globalCompositeOperation = 'source-over';
            },
            renderAbstracted: (ctx, data) => {
                const size = data.size;
                const cellSize = 18;
                const offset = 30;
                ctx.save();
                ctx.filter = 'blur(4px)';
                data.colors.forEach((color, idx) => {
                    if (!color || color === '#ffffff') return;
                    const x = idx % size;
                    const y = Math.floor(idx / size);
                    const cx = offset + x * cellSize + cellSize / 2;
                    const cy = offset + y * cellSize + cellSize / 2;
                    const radius = 10 + (Math.random() * 8);
                    const gradient = ctx.createRadialGradient(cx, cy, 2, cx, cy, radius);
                    gradient.addColorStop(0, color);
                    gradient.addColorStop(1, 'rgba(0,0,0,0)');
                    ctx.fillStyle = gradient;
                    ctx.beginPath();
                    ctx.arc(cx, cy, radius, 0, Math.PI * 2);
                    ctx.fill();
                });
                ctx.restore();
                ctx.globalCompositeOperation = 'screen';
                ctx.fillStyle = 'rgba(215,52,42,0.1)';
                ctx.fillRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                ctx.globalCompositeOperation = 'source-over';
            },
            loop: () => {
                if (!grift.isSimulating || state.view !== 'grift') return;
                const addedValue = Math.floor(Math.random() * 5000) + 100;
                grift.totalValue += addedValue;
                grift.userRoyalty += addedValue * 0.00006;
                document.getElementById('total-val').innerText = `$${grift.totalValue.toLocaleString()}`;
                document.getElementById('user-val').innerText = `$${grift.userRoyalty.toFixed(4)}`;
                if (Math.random() > 0.6) {
                    const event = grift.events[Math.floor(Math.random() * grift.events.length)];
                    const log = document.getElementById('event-log');
                    log.innerHTML = `> ${event}<br>` + log.innerHTML;
                }
                grift.timer = setTimeout(grift.loop, grift.simSpeed);
            }
        };
        window.grift = grift;

        // --- BARTER SHOP + TRANSPARENCY VIEW ---
        const barter = {
            mode: 'shop',
            data: null,
            bound: false,
            async init() {
                if (!barter.data) {
                    try {
                        const res = await fetch('static/data/barter-catalog.json');
                        barter.data = await res.json();
                    } catch (err) {
                        console.error('Failed to load barter catalog', err);
                        return;
                    }
                }

                if (!barter.bound) barter.bindControls();
                barter.render();
                ticketing.setTiers(barter.data.ticketingTiers || []);
            },
            bindControls() {
                const shopBtn = document.getElementById('barter-shop-btn');
                const transBtn = document.getElementById('barter-transparency-btn');
                if (shopBtn) shopBtn.onclick = () => barter.setMode('shop');
                if (transBtn) transBtn.onclick = () => barter.setMode('transparency');
                barter.bound = true;
                barter.updateModeButtons();
            },
            setMode(mode) {
                barter.mode = mode;
                barter.updateModeButtons();
                barter.render();
            },
            updateModeButtons() {
                const shopBtn = document.getElementById('barter-shop-btn');
                const transBtn = document.getElementById('barter-transparency-btn');
                const activeClasses = ['bg-black', 'text-white'];
                const inactiveClasses = ['bg-white', 'text-black'];
                if (shopBtn) {
                    shopBtn.classList.remove(...activeClasses, ...inactiveClasses);
                    shopBtn.classList.add('border', 'border-black', 'ui-click', 'px-3', 'py-2', 'text-[10px]', 'font-mono', 'uppercase', 'tracking-widest', 'hover:bg-black', 'hover:text-white', 'transition-colors');
                    shopBtn.classList.add(...(barter.mode === 'shop' ? activeClasses : inactiveClasses));
                }
                if (transBtn) {
                    transBtn.classList.remove(...activeClasses, ...inactiveClasses);
                    transBtn.classList.add('border', 'border-black', 'ui-click', 'px-3', 'py-2', 'text-[10px]', 'font-mono', 'uppercase', 'tracking-widest', 'hover:bg-black', 'hover:text-white', 'transition-colors');
                    transBtn.classList.add(...(barter.mode === 'transparency' ? activeClasses : inactiveClasses));
                }
            },
            render() {
                if (!barter.data) return;
                barter.renderItems();
                barter.renderStreams();
                barter.renderBundles();
                barter.renderActivities();
            },
            renderItems() {
                const grid = document.getElementById('barter-grid');
                if (!grid) return;
                grid.innerHTML = '';

                barter.data.items.forEach((item) => {
                    const margin = barter.margin(item);
                    const inventory = barter.formatInventory(item.inventory);
                    const card = document.createElement('div');
                    card.className = 'border border-gray-300 bg-white p-4 hover:shadow-xl transition-shadow';
                    card.innerHTML = `
                        <div class="flex justify-between items-start mb-1">
                            <div class="font-mono text-[10px] uppercase tracking-widest text-gray-500">${barter.streamLabel(item.stream)} • ${item.category}</div>
                            <span class="font-mono text-[10px] text-gray-500">${item.sku}</span>
                        </div>
                        <h4 class="font-bold text-lg uppercase leading-tight">${item.name}</h4>
                        <p class="text-xs font-mono text-gray-600 mb-3">${item.tagline || ''}</p>
                        ${barter.mode === 'shop'
                            ? `<div class="flex justify-between items-center mb-3"><span class="font-bold text-xl">$${item.price.toFixed(2)}</span><span class="text-[10px] uppercase font-mono text-gray-500">${inventory}</span></div>`
                            : `<div class="space-y-1 mb-3 text-sm"><div class="font-mono text-[11px] uppercase tracking-widest text-gray-700">Cost: $${item.unitCost.toFixed(2)} • Margin: ${margin !== null ? margin + '%' : '—'}</div><div class="text-xs text-gray-600">Inventory bands: ${inventory}</div></div>`
                        }
                        <button class="w-full bg-black text-white text-xs uppercase py-2 hover:bg-red-600 transition-colors">${barter.mode === 'shop' ? 'Add to Pull Sheet' : 'View Unit Economics'}</button>
                    `;
                    grid.appendChild(card);
                });
            },
            renderStreams() {
                const grid = document.getElementById('barter-stream-grid');
                if (!grid) return;
                grid.innerHTML = '';

                barter.data.revenueStreams.forEach((stream) => {
                    const count = barter.data.items.filter((item) => item.stream === stream.id).length;
                    const card = document.createElement('div');
                    card.className = 'bg-white border border-gray-200 p-4 shadow-sm';
                    card.innerHTML = `
                        <div class="font-mono text-[10px] uppercase tracking-widest text-gray-500 mb-2">${stream.label}</div>
                        <p class="text-sm text-gray-700 mb-3">${stream.description}</p>
                        <div class="flex items-center justify-between text-xs font-mono uppercase tracking-widest text-gray-600">
                            <span>${count} SKUs</span>
                            <span>${stream.formats.join(' • ')}</span>
                        </div>
                    `;
                    grid.appendChild(card);
                });
            },
            renderBundles() {
                const grid = document.getElementById('barter-bundle-grid');
                if (!grid) return;
                grid.innerHTML = '';

                barter.data.bundles.forEach((bundle) => {
                    const margin = barter.margin(bundle);
                    const card = document.createElement('div');
                    card.className = 'border border-gray-300 bg-white p-4 shadow-sm hover:shadow-lg transition-shadow';
                    card.innerHTML = `
                        <div class="flex justify-between items-start mb-1">
                            <div class="font-mono text-[10px] uppercase tracking-widest text-gray-500">${barter.streamLabel(bundle.stream)}</div>
                            <span class="font-mono text-[10px] text-gray-500">${bundle.sku}</span>
                        </div>
                        <h4 class="font-bold text-lg uppercase leading-tight">${bundle.name}</h4>
                        <p class="text-xs text-gray-600 font-mono mb-3">${bundle.tagline}</p>
                        <ul class="text-xs text-gray-700 mb-3 list-disc list-inside space-y-1">${(bundle.contents || []).map((c) => `<li>${c}</li>`).join('')}</ul>
                        ${barter.mode === 'shop'
                            ? `<div class="font-bold text-xl mb-3">$${bundle.price.toFixed(2)}</div>`
                            : `<div class="font-mono text-[11px] uppercase tracking-widest text-gray-700 mb-3">Cost: $${bundle.unitCost.toFixed(2)} • Margin: ${margin !== null ? margin + '%' : '—'}</div>`
                        }
                        <button class="w-full bg-black text-white text-xs uppercase py-2 hover:bg-red-600 transition-colors">${barter.mode === 'shop' ? 'Secure Bundle' : 'Inspect Economics'}</button>
                    `;
                    grid.appendChild(card);
                });
            },
            renderActivities() {
                const grid = document.getElementById('barter-activity-grid');
                if (!grid) return;
                grid.innerHTML = '';

                barter.data.activities.forEach((activity) => {
                    const card = document.createElement('div');
                    card.className = 'bg-white border border-gray-200 p-4 shadow-sm hover:shadow-lg transition-shadow';
                    card.innerHTML = `
                        <div class="font-mono text-[10px] uppercase tracking-widest text-gray-500 mb-1">${activity.location}</div>
                        <h4 class="font-bold text-lg uppercase leading-tight">${activity.name}</h4>
                        <p class="text-sm text-gray-700 mb-2">${activity.notes}</p>
                        <div class="flex items-center justify-between text-xs font-mono uppercase tracking-widest text-gray-600">
                            <span>Status: ${activity.status}</span>
                            <span>${barter.mode === 'transparency' ? 'Revenue map node' : 'On-floor anchor'}</span>
                        </div>
                    `;
                    grid.appendChild(card);
                });
            },
            margin(entry) {
                if (!entry || typeof entry.price !== 'number' || typeof entry.unitCost !== 'number') return null;
                return Math.round(((entry.price - entry.unitCost) / entry.price) * 100);
            },
            formatInventory(inv = {}) {
                if (!inv.min && !inv.opt && !inv.max) return 'Inventory: adaptive';
                return `Min ${inv.min || '—'} / Opt ${inv.opt || '—'} / Max ${inv.max || '—'}`;
            },
            streamLabel(id) {
                const found = barter.data.revenueStreams.find((s) => s.id === id);
                return found ? found.label : 'Stream';
            }
        };
        window.barter = barter;

        const ticketing = {
            tiers: [],
            setTiers(tiers) {
                ticketing.tiers = tiers;
                ticketing.render();
            },
            open() {
                const modal = document.getElementById('ticketing-modal');
                if (modal) modal.classList.add('active');
                document.body.classList.add('modal-open');
            },
            close() {
                const modal = document.getElementById('ticketing-modal');
                if (modal) modal.classList.remove('active');
                document.body.classList.remove('modal-open');
            },
            render() {
                const container = document.getElementById('ticketing-tiers');
                if (!container) return;
                container.innerHTML = '';
                ticketing.tiers.forEach((tier) => {
                    const card = document.createElement('div');
                    card.className = 'border border-gray-300 bg-white p-4 rounded-xl shadow-sm hover:shadow-lg transition-shadow';
                    card.innerHTML = `
                        <div class="font-mono text-[10px] uppercase tracking-widest text-gray-500">${tier.tier}</div>
                        <div class="text-2xl font-bold">$${tier.price.toFixed(2)}</div>
                        <ul class="text-sm text-gray-700 mt-3 space-y-1 list-disc list-inside">
                            ${(tier.perks || []).map((p) => `<li>${p}</li>`).join('')}
                        </ul>
                        <div class="mt-3 text-[11px] font-mono uppercase tracking-widest text-gray-500">${tier.idealFor || ''}</div>
                        <button class="ui-click mt-4 w-full bg-black text-white text-xs uppercase py-2 hover:bg-red-600 transition-colors">Claim ${tier.tier}</button>
                    `;
                    container.appendChild(card);
                });
            }
        };
        window.ticketing = ticketing;

        // --- 3D GALLERY ENGINE ---
        const gallery = {
            scene: null, camera: null, renderer: null, controls: null, active: false,
            frames: [],
            editMode: false,
            selectedFrame: null,
            lanternGroup: null,
            lanternLight: null,
            lanternTimer: null,
            init: () => {
                const container = document.getElementById('canvas-container');
                gallery.scene = new THREE.Scene();
                gallery.scene.background = new THREE.Color('#0f0f0f');
                gallery.scene.fog = new THREE.Fog('#0f0f0f', 10, 50);
                gallery.camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 100);
                gallery.camera.position.set(0, 6, 22);
                gallery.renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
                gallery.renderer.setSize(window.innerWidth, window.innerHeight);
                container.appendChild(gallery.renderer.domElement);
                gallery.controls = new OrbitControls(gallery.camera, gallery.renderer.domElement);
                gallery.controls.enableDamping = true;

                const ambient = new THREE.AmbientLight(0xffffff, 0.45);
                gallery.scene.add(ambient);
                const spot = new THREE.SpotLight(0xffffff, 1.2, 80, Math.PI / 4, 0.3);
                spot.position.set(12, 18, 12);
                gallery.scene.add(spot);

                // Room shell
                const room = new THREE.Mesh(new THREE.BoxGeometry(40, 18, 40), new THREE.MeshStandardMaterial({ color: '#e1ddd1', side: THREE.BackSide, roughness: 0.8 }));
                room.position.y = 9;
                gallery.scene.add(room);
                const floor = new THREE.Mesh(new THREE.PlaneGeometry(40, 40), new THREE.MeshStandardMaterial({ color: '#eae7dc', roughness: 0.9 }));
                floor.rotation.x = -Math.PI / 2;
                gallery.scene.add(floor);

                gallery.bindUI();
                gallery.loadFrames();
                gallery.animate();
            },
            bindUI: () => {
                const unlockBtn = document.getElementById('gallery-edit-btn');
                const addBtn = document.getElementById('gallery-add-btn');
                const resetBtn = document.getElementById('gallery-reset-btn');
                const panel = document.getElementById('gallery-editor-panel');
                const status = document.getElementById('gallery-edit-status');

                if (unlockBtn) {
                    unlockBtn.onclick = () => {
                        const pwd = document.getElementById('gallery-edit-password').value.trim();
                        if (pwd.toLowerCase() === 'loomworks') {
                            gallery.editMode = true;
                            panel.classList.remove('hidden');
                            status.innerText = 'Edit Mode';
                            status.classList.remove('text-gray-500');
                            status.classList.add('text-red-600');
                        } else {
                            status.innerText = 'Denied';
                            status.classList.add('text-red-600');
                        }
                    };
                }

                if (addBtn) addBtn.onclick = gallery.addOrUpdateFrame;
                if (resetBtn) resetBtn.onclick = gallery.resetLayout;
            },
            loadFrames: () => {
                const saved = localStorage.getItem('loomworks-gallery');
                const defaults = [
                    { id: 'a', w: 4, h: 5, x: -6, y: 5, z: -5, label: 'Archive Print' },
                    { id: 'b', w: 3, h: 3, x: 0, y: 4, z: -6, label: 'Lantern Study' },
                    { id: 'c', w: 5, h: 4, x: 6, y: 5, z: -5, label: 'Disney Provenance' }
                ];
                gallery.frames = saved ? JSON.parse(saved) : defaults;
                gallery.frames.forEach(gallery.addFrameMesh);
                gallery.refreshList();
            },
            saveFrames: () => {
                localStorage.setItem('loomworks-gallery', JSON.stringify(gallery.frames));
                gallery.refreshList();
            },
            refreshList: () => {
                const list = document.getElementById('gallery-frame-list');
                if (!list) return;
                list.innerHTML = '';
                gallery.frames.forEach((frame) => {
                    const btn = document.createElement('button');
                    btn.className = 'w-full text-left border border-gray-200 px-2 py-1 bg-white hover:bg-black hover:text-white transition-colors text-[10px] font-mono';
                    btn.innerText = `${frame.label || 'Work'} (${frame.w}×${frame.h})`;
                    btn.onclick = () => gallery.populateForm(frame);
                    list.appendChild(btn);
                });
            },
            populateForm: (frame) => {
                gallery.selectedFrame = frame.id;
                document.getElementById('frame-width').value = frame.w;
                document.getElementById('frame-height').value = frame.h;
                document.getElementById('frame-x').value = frame.x;
                document.getElementById('frame-y').value = frame.y;
                document.getElementById('frame-z').value = frame.z;
                document.getElementById('frame-label').value = frame.label || '';
            },
            removeFrameMeshes: (id) => {
                const obj = gallery.scene.getObjectByName(`frame-${id}`);
                const glass = gallery.scene.getObjectByName(`frame-glass-${id}`);
                if (obj) gallery.scene.remove(obj);
                if (glass) gallery.scene.remove(glass);
            },
            addFrameMesh: (frame) => {
                const artGeo = new THREE.BoxGeometry(frame.w, frame.h, 0.2);
                const artMat = new THREE.MeshStandardMaterial({ color: '#1f1f1f', metalness: 0.6, roughness: 0.4 });
                const art = new THREE.Mesh(artGeo, artMat);
                art.position.set(frame.x, frame.y, frame.z);
                art.name = `frame-${frame.id}`;
                gallery.scene.add(art);

                const glass = new THREE.Mesh(new THREE.PlaneGeometry(frame.w * 0.95, frame.h * 0.95), new THREE.MeshStandardMaterial({ color: '#a5b7ff', transparent: true, opacity: 0.15, metalness: 0.5, roughness: 0.05 }));
                glass.position.set(frame.x, frame.y, frame.z + 0.12);
                glass.name = `frame-glass-${frame.id}`;
                gallery.scene.add(glass);
            },
            addOrUpdateFrame: () => {
                if (!gallery.editMode) return;
                const w = parseFloat(document.getElementById('frame-width').value) || 3;
                const h = parseFloat(document.getElementById('frame-height').value) || 3;
                const x = parseFloat(document.getElementById('frame-x').value) || 0;
                const y = parseFloat(document.getElementById('frame-y').value) || 4;
                const z = parseFloat(document.getElementById('frame-z').value) || -5;
                const label = document.getElementById('frame-label').value || 'Work';
                const id = gallery.selectedFrame || Math.random().toString(36).slice(2, 7);

                gallery.frames = gallery.frames.filter(f => f.id !== id);
                const frame = { id, w, h, x, y, z, label };
                gallery.removeFrameMeshes(id);
                gallery.frames.push(frame);
                gallery.addFrameMesh(frame);
                gallery.saveFrames();
                gallery.selectedFrame = null;
            },
            resetLayout: () => {
                gallery.frames.forEach(f => gallery.removeFrameMeshes(f.id));
                localStorage.removeItem('loomworks-gallery');
                gallery.frames = [];
                gallery.loadFrames();
            },
            resize: () => {
                if(!gallery.camera) return;
                gallery.camera.aspect = window.innerWidth / window.innerHeight;
                gallery.camera.updateProjectionMatrix();
                gallery.renderer.setSize(window.innerWidth, window.innerHeight);
            },
            animate: () => {
                requestAnimationFrame(gallery.animate);
                if (gallery.active && gallery.controls) {
                    gallery.controls.update();
                    if (gallery.lanternGroup) gallery.lanternGroup.rotation.y += 0.004;
                    gallery.renderer.render(gallery.scene, gallery.camera);
                }
            },
            stopLanternEffects: () => {
                const grain = document.getElementById('lantern-grain');
                if (grain) grain.classList.add('hidden');
                if (gallery.lanternTimer) { clearInterval(gallery.lanternTimer); gallery.lanternTimer = null; }
                if (gallery.lanternGroup) { gallery.scene.remove(gallery.lanternGroup); gallery.lanternGroup = null; }
                if (gallery.lanternLight) { gallery.scene.remove(gallery.lanternLight); gallery.lanternLight = null; }
                audio.stopLantern();
            },
            launchLanternOverlay: (trigger = '') => {
                app.navigate('gallery');
                gallery.stopLanternEffects();
                const grain = document.getElementById('lantern-grain');
                if (grain) grain.classList.remove('hidden');
                audio.startLantern();

                const group = new THREE.Group();
                const frameMat = new THREE.MeshStandardMaterial({ color: '#0f1628', metalness: 0.92, roughness: 0.22 });
                const frame = new THREE.Mesh(new THREE.CylinderGeometry(1.1, 1.1, 2.8, 6, 1, true), frameMat);
                frame.position.set(0, 5, 0);
                group.add(frame);

                const strutGeo = new THREE.BoxGeometry(0.12, 2.9, 0.35);
                for (let i = 0; i < 6; i++) {
                    const strut = new THREE.Mesh(strutGeo, new THREE.MeshStandardMaterial({ color: '#111826', metalness: 0.8, roughness: 0.3 }));
                    strut.position.set(Math.cos((Math.PI * 2 * i) / 6) * 0.9, 5, Math.sin((Math.PI * 2 * i) / 6) * 0.9);
                    group.add(strut);
                }

                const glass = new THREE.Mesh(
                    new THREE.CylinderGeometry(0.85, 0.9, 2.5, 24, 1, true),
                    new THREE.MeshPhysicalMaterial({ color: '#f7fbff', transparent: true, opacity: 0.28, metalness: 0.3, roughness: 0.05, transmission: 0.7, thickness: 0.5 })
                );
                glass.position.set(0, 5, 0);
                group.add(glass);

                const core = new THREE.Mesh(new THREE.CapsuleGeometry(0.28, 1.2, 8, 16), new THREE.MeshStandardMaterial({ color: '#ff9c3d', emissive: '#ffb347', emissiveIntensity: 1.8, metalness: 0.4, roughness: 0.15 }));
                core.position.set(0, 5, 0);
                group.add(core);

                const base = new THREE.Mesh(new THREE.CylinderGeometry(1.4, 1.6, 0.35, 6), new THREE.MeshStandardMaterial({ color: '#0b101d', metalness: 0.9, roughness: 0.25 }));
                base.position.set(0, 3.6, 0);
                group.add(base);

                const topPlate = new THREE.Mesh(new THREE.CylinderGeometry(1.2, 1.3, 0.25, 6), frameMat);
                topPlate.position.set(0, 6.2, 0);
                group.add(topPlate);

                const handle = new THREE.Mesh(new THREE.TorusGeometry(0.9, 0.08, 10, 28), new THREE.MeshStandardMaterial({ color: '#cfd9ff', metalness: 0.8, roughness: 0.2 }));
                handle.position.set(0, 6.6, 0);
                handle.rotation.x = Math.PI / 2;
                group.add(handle);

                group.name = 'lantern-group';
                gallery.scene.add(group);
                gallery.lanternGroup = group;

                const light = new THREE.PointLight(0xffc36c, 2.2, 20);
                light.position.set(0, 5.3, 0);
                gallery.scene.add(light);
                gallery.lanternLight = light;

                gallery.lanternTimer = setInterval(() => {
                    if (!gallery.lanternLight) return;
                    gallery.lanternLight.intensity = 1.5 + Math.random() * 0.9;
                }, 140);

                if (trigger) {
                    const log = document.getElementById('event-log');
                    if (log) log.innerHTML = `> ${trigger}<br>` + log.innerHTML;
                }
            }
        };
        window.gallery = gallery;

        // --- NAVIGATION ---
        window.app = {
            navigate: (target) => {
                audio.click();
                if (state.view === 'profiler' && target !== 'profiler') {
                    profiler.closeModal();
                    document.body.classList.remove('modal-open');
                }
                document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
                document.getElementById(`view-${target}`).classList.add('active');
                
                document.querySelectorAll('.nav-btn').forEach(btn => {
                    if(btn.dataset.target === target) btn.classList.add('underline', 'decoration-red-600', 'decoration-2', 'underline-offset-4', 'text-black');
                    else btn.classList.remove('underline', 'decoration-red-600', 'decoration-2', 'underline-offset-4', 'text-black');
                });

                if (target === 'gallery') {
                    gallery.resize(); gallery.active = true;
                } else {
                    gallery.active = false;
                    gallery.stopLanternEffects();
                }

                if (target === 'archive') {
                    archive.init();
                }

                if (target === 'grift') {
                    grift.init();
                    if(grift.isSimulating) grift.loop();
                }

                if (target === 'barter') {
                    barter.init();
                }

                if (target === 'profiler' && profiler.initialChoice === null) {
                    profiler.init();
                }

                if (target === 'landing') ambient.startTooltips();
                else ambient.stopTooltips();

                state.view = target;
                window.scrollTo(0,0);
            },
            toggleMobileMenu: () => {
                const menu = document.getElementById('mobile-menu');
                menu.classList.toggle('translate-x-full');
            }
        };

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            const text = "LOADING LOOMWORKS MANUFACTURE PROCESS...";
            const el = document.getElementById('loader-text');
            let i = 0;
            const type = () => {
                if (i < text.length) {
                    el.innerHTML += text.charAt(i); i++; setTimeout(type, 30 + Math.random() * 50);
                } else {
                    setTimeout(() => { document.getElementById('loader').style.opacity = 0; setTimeout(() => document.getElementById('loader').remove(), 500); }, 800);
                }
            };
            type();

            registerHeatmap();
            observeBlueprints();
            initScanlineParallax();
            ambient.startTooltips();
            startIdleGlitch();
            initInvoiceMode();
            startGlitchBannerCycle();

            document.addEventListener('click', (e) => {
                if (e.target.closest('.ui-click') || e.target.tagName === 'BUTTON') audio.click();
            });
        });

        window.addEventListener('resize', () => sculptureEngine.resize());

        window.addEventListener('load', () => {
            gallery.init();
            archive.init();
            barter.init();
        });
    </script>
</body>
</html>
